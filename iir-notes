first thing is to set up imedidata to run locally
particularly the branch that has mauth - for now thats my fork


so its a submodule - so need to understand how to set up a submodule in rails/git
is it a git thing - i think its a git thing not a rails thing - well that shows my ignorance


#1) get access to iir repo - isaac
#2) git clone it? its empty?
#2.1 - make develop branch - push to origin
#2.2 - make init-rails branch???
#3) do rails init! setup all the dirs
#3.1 - pr for rails init??
#4) git submodule add imedidata
#4.1) make new branch
#5) make gemset for imedidata!
#6) get foreman gem for iir
#7) get subcontractor gem
#8) make procfile with both iir & imedidata - copy balance 
#   - check out rails3upgrade branch with yis subcontractor gemset stuff
#9) test running it
# 9B ) engineering page with install instructions - iir foreman subcontractor - 1st cut
# 10) put in mauth signer - in gemfile
# 11) make public private key pair
12) install keys with matts commands
13) make a controller & view & model? to query imedidata for study and just show study


#1] 
or #2]
https://github.com/mdsol/iir
its empty
has directions
add README - do we do readmes?
README.md apparently which just has a link to knowledge base
gmc: README.md:
[[https://sites.google.com/a/mdsol.com/knowledgebase/home/products/grants-manager-contracting]]
dont know what dounle brackets are about or .md for that matter
.md is Markdown - simplified html apparently...
http://en.wikipedia.org/wiki/Markdown


mkdir iir
  cd iir
  git init
  touch README.md
  git add README.md
  git commit -m 'first commit'
  git remote add origin git@github.com:mdsol/iir.git
  git push -u origin master


#3) - do rails init
well need all the rails gems and all
need to read up on this


rvm?
http://guides.rubyonrails.org/getting_started.html
section 3.2
rails new iir?
rails new -h
/System/Library/Frameworks/Ruby.framework/Versions/1.8/usr/lib/ruby/1.8/rubygems.rb:827:in `report_activate_error': Could not find RubyGem rails (>= 0) (Gem::LoadError)
        from /System/Library/Frameworks/Ruby.framework/Versions/1.8/usr/lib/ruby/1.8/rubygems.rb:261:in `activate'
        from /System/Library/Frameworks/Ruby.framework/Versions/1.8/usr/lib/ruby/1.8/rubygems.rb:68:in `gem'
        from /usr/bin/rails:18


gem install rails??
rvm gemset create iir
rvm gemset list
rvm gemset use iir
rvm use 1.8.7-p352@iir - NO
NO - use 1.9.2!
rvm use 1.9.2-p290@iir


p290?
1.9.2-p290 it is - only version cloud team supports - dont suppot 1.9.3 that is
.rvm.rc
its tempting to change ~/i to iir from imedidata


gem install rails -v version#??
3.1.3 for rails - NOT 3.2
gem install rails -v 3.1.3


cd ~/projects
rails new iir


edit gemfile
README.md 
take out README default
(gem install bundler?)
bundle install


dev - co dev
pdev - pull dev
gb feature/imed-submod
co feature/imed-submod






IMEDIDATA SUBMODULE 




imedidata submodule - master? develop? oh actually the branch with mauth
alias add-locale-update="cd ~/i/config/locales; git fetch; git checkout origin/HEAD; cd ../..; git add config/locales"
read up on submods
http://book.git-scm.com/5_submodules.html
http://progit.org/book/ch6-6.html


mkdir vendor/apps
git add dir???


cd vendor/apps
git submodule add ????imed-branch?? imedidata
git@github.com:mdsol/imedidata.git
but how do i specify develop branch




(for folks cloning iir will need to do git submodule init and git submodule update)


to a particular branch:
http://twoguysarguing.wordpress.com/2010/11/14/tie-git-submodules-to-a-particular-commit-or-branch/


git submodule add git://github.com/asynchrony/qunit.git qunit




cd vendor/apps/imedidata
change directory to the submodule folder and switch branches just like you would in a normal repo.


git checkout -b dev_branch origin/dev_branch
Now the submodule is fixed on the development branch instead of HEAD of master. 
Commiting these changes will persist the new submodule tracking your desired branch.


ok not the develop branch - as its been reverted cos rspec fails - woops - but can work off my feature branch
The next time you (or someone else) clones this repo, they will need to do one of two things.


A) Add the –recursive flag to their git clone command


git clone REPO_URL --recursive
B) manually initialize and the submodules after the clone


git clone REPO_URL
git submodule update --init --recursive


not sure what the recrusive thing is all about - because its not master? article doesnt say


recrusive gets nested submodules - but is the above a nested submodule? well whatever
If you git clone with --recursive, you can get all the git submodules too.


mkdir vendor/apps
##cd vendor/apps/imedidata
##cd vendor/apps  i think
##git submodule add git@github.com:mdsol/imedidata.git 
You need to run this command from the toplevel of the working tree.
woops


cd ~/iir
##git submodule add git@github.com:mdsol/imedidata.git vendor/apps
'vendor/apps' already exists and is not a valid git repo
rmdir vendor/apps
ah - you dont create apps
wrong again


git submodule add git@github.com:mdsol/imedidata.git vendor/apps/imedidata
need to rm wrong submodule
To remove a submodule you need to:


Delete the relevant line from the .gitmodules file.
Delete the relevant section from .git/config. -- not in there
Run git rm --cached path_to_submodule (no trailing slash).
Commit and delete the now untracked submodule files.


*** this is the one:
git submodule add git@github.com:mdsol/imedidata.git vendor/apps/imedidata


git checkout -b dev_branch origin/dev_branch


git checkout -b 
git checkout -b BRANCH_NAME creates a new branch and goes to new branch but git branch BRANCH_NAME creates a new branch and holds you still on the same branch.
man that was hard to find
so 
git checkout -b name  origin/or-branch
is shorthand for
git branch b-name
git checkout b-name?
??


cd vendor/apps/imedidata
git checkout -b feature/mauth origin/feature/mauth 
??
fatal: git checkout: updating paths is incompatible with switching branches.
Did you intend to checkout 'origin/feature/mauth' which can not be resolved as commit?


woops - i think i need to commit and push first


git commit -m "adding imedidata submodule"
feature/imed-submod 20134bd] adding imedidata submodule
 2 files changed, 4 insertions(+), 0 deletions(-)
 create mode 100644 .gitmodules
 create mode 160000 vendor/apps/imedidata


pb


cd vendor/apps/imedidata
git checkout -b feature/mauth origin/feature/mauth 
fatal: git checkout: updating paths is incompatible with switching branches.
Did you intend to checkout 'origin/feature/mauth' which can not be resolved as commit?


git checkout feature/mauth
error: pathspec 'feature/mauth' did not match any file(s) known to git.


git branch -a  all branches remote & local
git branch -r  remote branches
git branch     local


feature/mauth was blown away


git checkout feature/support_mauth
Branch feature/support_mauth set up to track remote branch feature/support_mauth from origin.
Switched to a new branch 'feature/support_mauth'
that seemed to work
commit and push at root?

END OF CREATING IMEDIDATA SUBMODULE IN IIR


IMEDIDATA GEMSET

make gemset for imedidata!
cd vendor/apps/imedidata  ??
rvm list
rvm gemset list
rvm gemset create imedidata
p249 is the sanctioned cloud ruby for imedidata
rvm use 1.8.7-p249@imedidata


yi says to do a rvm gemset empty to clear out the gemset
so i think 1.8.7-p249@imedidata already exists on my system for imed which is fine
but good to clear it out and redo
as bundle install will leave old crap lying around apparently
according to yi bundle update goes solely off gemfile lock file
so you can muck with lock file and try things out without mucking with gemfile


how do i list gems i n gemset
rvm help gemset
rvm gemset list


gem list


rvm gemset empty
bundle install
-bash: bundle: command not found


need to install bundle


gem install bundler


bundle install
#5 make gemset for imedidata is donw
onto #6
6) get foreman gem for iir
http://rubygems.org/gems/foreman
gem install foreman




cd ~/iir
actually this is not what we want
gem install foreman
this installs into the gemset - however its not in the gemfile
so  someone else who does bundle install will not get foreman
need to add to gemfile:
gem "foreman", "~> 0.36.1"
and then do bundle install
woops forgor to switch back to iir gemset and ruby
got error on bundle install
Gem::InstallError: linecache19 requires Ruby version >= 1.9.2.
adding .rvmrc


doing clean and redo with bad bundle install with wrong ruby version - why not


ok foreman is in
time for subcontractor
they should go in group :development
group :development do
  gem "foreman", "~> 0.36.1"
  gem "subcontractor", "~> 0.3.1"
end
#7 is done
#8 
8) make procfile with both iir & imedidata - copy balance 
   - check out rails3upgrade branch with yis subcontractor gemset stuff


#balance: bundle exec rails server -p 3000 
imedidata: cd vendor/apps/imedidata; subcontract --rvm ruby-1.8.7-p174@oldgems -- bundle exec script/server -p 3001 
cas: cd vendor/apps/castronaut/; RACK_ENV=balance_development subcontract --rvm ruby-1.8.7-p174@casgems -- bundle exec bin/castronaut 
delayed_job: script/delayed_job run
redis: redis-server 


rails server -p 3000 
will start up iir rails - unclear if bundle exec is needed - not needed for me leave out for now


how do i run foreman?
foreman start i think???


imedidata not ready to run yet - need to do db stuff and all
wont we need cas?? or just using as service so dont need to


but also my proc file aint working
the cd aint working
got cd working - needed space


imedidata has to go through full setup - db file and all


yales set up doc
https://docs.google.com/a/mdsol.com/document/d/1lU2AdayPO4MKxUauc7dNnBGioIQSAZqr0GbcGM5AG4Q/edit?pli=1


do we need to init imedidatas submodules?


git submodule init; git submodule update
or 
git submodule update --recursive
or 
git submodule update --init --recursive
Download the database.yml file and move it to config/database.yml.


% mv ~/Downloads/database.yml config/database.yml
ill grab db file from my other imedidata
cp ~/i/config/database.yml config


mysql -u root
> create database imedidata_development;
> create database imedidata_test;
> exit
already have the above db i believe


and have this i think
import the database file provided by Madalina:


% mysql -u root imedidata_development < imedidata-backup.sql


Finally, prepare the database with rake:


% bundle exec rake db:migrate
% bundle exec rake db:test:prepare


do we need cas? maybe not yet?


ok we got foreman issues
we can go back to old version of foreman and prob should
but before we do letsw try a few things
look around more for docs
the cd doesnt seem to work - but it does
put debugger deep in the gem ???
try running from iir root - with full path - imed that is
maybe make a 1.9.2 imed gemset? or actually that prob wont work since imed is 1.8.7 ??




this will run
vendor/apps/imedidata/script/server -p 3001
foreman check validates a foreman file


and it will run if in 1.8.7@im


now lets try with subcontractor
we are still in 0.3 foreman


so imedidata localhost:3001 isnt working 
and thats probably because their is no cas


this seems to work!
imedidata: subcontract --rvm ruby-1.8.7-p249@imedidata -- vendor/apps/imedidata/script/server -p 3001


ben says we need bundle exec ?? but do we? i think thats if you havent cleaned out your gemfile?


check this out! 
http://rubydoc.info/gems/subcontractor/0.3.1/frames
rails: rails s
another_app: subcontract --rvm ruby-1.8.7-p249@another_app --chdir ../another_app --signal INT -- rails s -p 3001


notice the --chdir!
subcontract --help
USAGE: subcontract [options] -- executable
    -r, --rvm RVM                    run in a specific RVM
    -d, --chdir PATH                 chdir to PATH before starting process
    -s, --signal SIGNAL              signal to send to process to kill it, default TERM




not dying nicely with ctrl C
leaves stray process
psr
131:magibson  4318   0.0  0.0  2425716    276 s009  R+   11:51AM   0:00.00 grep -n ruby
134:magibson  4206   0.0  1.8  2585704 155156 s011  S+   11:50AM   0:06.15 ruby /Users/magibson/projects/iir/vendor/apps/imedidata/script/server -p 3001
135:magibson  4154   0.0  0.0  2435544   1804 s011  Ss+  11:50AM   0:00.06 bash /Users/magibson/.rvm/bin/rvm ruby-1.8.7-p249@imedidata exec script/server -p 3001
-s, --signal SIGNAL              signal to send to process to kill it, default TERM
--signal INT


with INT or TERM still not dying 
ugh! is there any other signals?
try bundle exec
and try old foreman
maybe new foreman doesnt play well with subcontractor - subcon not up to date?


http://book.chinaunix.net/special/ebook/oreilly/Learning_bash_Shell/0596009658/bash3-CHP-8-SECT-3.html
there also seems to be QUIT and KILL
INT is ctrlC, TERM is same as KILL


emailed subcontractor dude:
tony.pitluga@gmail.com


Hi Tony,
First of all thanks for subcontractor - very handy tool.
I am trying to use subcontractor with ruby 1.9 and on doing a ctrl-C got:




/Users/magibson/.rvm/gems/ruby-1.9.2-p290@iir/gems/subcontractor-0.3.1/lib/subcontractor/cli.rb:37:in
`find_child_pids': undefined method `map' for
#<String:0x0000010204ebf8> (NoMethodError)


and in 1.9 the map function was removed from String. And i saw your
comment on github:




This was definitely a bug. It looks like slanger was spawning three
levels of processes. Subcontractor would not find the 3rd child and
that was the one that was not getting killed. I've updated the code to
recursively search for children until no more are found, so it should
be much more reliable. This fix is in version 0.3.1.


Is 0.3.1 stable? has it been tested with ruby 1.9? It seems 0.3 is the
release that is advertised on your site.
thanks for your help!




well lets try getting the latest code i guess


why not fork it - what the heck - in case need to make changes


forked it on github
git@github.com:magibson/subcontractor.git
cd ~/projects
git clone git@github.com:magibson/subcontractor.git


~/projects/subcontractor (master) $ m .rvmrc
rvm ruby-1.8.7-p249@subcontractor
!!
clearly hes not using 1.9!! prob not tested on 1.9!


crazy idea - have foreman/subcontractor run in 1.8 but subcontract iir to run in 1.9 ?? 
and imed in 1.8 of course


the source for subcontractor is tiny! this will be easy!


how do i point to src - thats in rack mauth notes


 # gem "rack-mauth", :path => "~/projects/rack-mauth"
gem "subcontractor", :path => "~/projects/subcontractor"




dam cant get it to work pointing to src


build a gem?
http://matschaffer.com/2010/12/your-own-gem/
gem build my_awesome_gem.gemspec




http://stackoverflow.com/questions/4271947/how-to-use-bundler-with-offline-gem-file
I'm using Rails 3.0.3, new to Rails 3 and bundler.


I got this same error with:


gem 'mygem', :path => '/path/to/gem'
Resolved by specifying the version number:


gem 'mygem', '0.0.1', :path => '/path/to/gem'


Copy the gem in to vendor/cache directory in your application's root folder.
bundle install --local
This will install the local gem.


ah ethan help
need to do 
bundle exec foreman start
but now get this error


bundle exec foreman start
15:54:15 imedidata.1  | started with pid 7962
15:54:17 imedidata.1  | Could not find linecache19-0.5.12 in any of the sources
15:54:17 imedidata.1  | Run `bundle install` to install missing gems.
15:54:17 imedidata.1  | process terminated


but i think bundle exec is blowing away subcontractor - oish
imedidata: subcontract --rvm ruby-1.8.7-p249@imedidata --chdir vendor/apps/imedidata -- script/server -p 3001


linecache19 is in iir but not in imedidata
imedidata has just linecache (0.46)


lets try doing a local install of the gem
we could also do submodule?


gem build subcontractor.gemspec
mkdir ~/iir/vendor/cache
cp subcontractor-0.3.0.gem ~/iir/vendor/cache/
cd ~/iir
bundle install --local


change gemfile:
 gem "subcontractor"


wow that worked


cli.rb line 37 put in split after line
      child_pids = lines.split.map(&:split).select do |(child_pid, parent_pid)|


cant get it to use new gem locally
i think you have to clear out gemset? - delete subcontractor by hand?
comment out subcontractor from gemfile
bundle install
then copy subcontractor into vendor/cache
uncomment out subcontracotr from gemfile
then do bundle install --local


config/application.rb can put in your own requires - thats where the bundler stuff gets required


friday 1/27/12


ok so where are we at 
unfortunately no email from tony
worse comes to worse we put in our own gem


oh need to move changes to my fork for safe keeping - will get wiped out on bundle install where it is now
i put changes straight in 


 ~/.rvm/gems/ruby-1.9.2-p290@iir/gems/subcontractor-0.3.1/lib/subcontractor/cli.rb
change is
      child_pids = lines.split("\n").collect{|x| x.split("\s")}.select do |(child_pid, parent_pid)|
line 38


putting in fork cli 


also i think the source gemming could work if i didnt use name subcontractor as thats an official gem
called it subcontractor19 and probably take out gemspec as well
as i think it was getting confused with actual gem repo with naming and all
this is wrong fix
      child_pids = lines.split.map(&:split).select do |(child_pid, parent_pid)|


crucial bug was did '\n' which is not at all "\n" - look out for that!


where we at
so actually we did #8 and #9
i think we are ready for a pr
and then on to 10 mauth signer
dont think i need to do cas right now but it does mean cant test it out on web yet just via api - curl jazzhands poster
lets clean up and make a pr
lets do a stash and put in new branch - feature/foreman-subcontract-setup


oh havent tried bundle exec yet in subcon
and havent tried with iir


bundle exec works in subcon - phew
iir & imed both work - phew
things that didnt work - 
cd command is NOT the way to go with subcon - need to use chdir!!
signal not necasary
bundle exec not needed for me but may be needed for others
#imedidata: cd vendor/apps/imedidata ; subcontract --rvm ruby-1.8.7-p249@imedidata -- bundle exec script/server -p 3001
# imedidata: cd vendor/apps/imedidata; bundle exec script/server -p 3001
#imedidata: cd vendor/apps/imedidata ; bundle exec script/server -p 3001
# imedidata:  bundle exec vendor/apps/imedidata/script/server -p 3001
# imedidata:  vendor/apps/imedidata/script/server -p 3001
#imedidata:  vendor/apps/imedidata/script/server -p 3001
#im: script/server -p 3001
#imedidata: subcontract --rvm ruby-1.8.7-p249@imedidata -- vendor/apps/imedidata/script/server -p 3001
#imedidata: subcontract --rvm ruby-1.8.7-p249@imedidata -- bundle exec vendor/apps/imedidata/script/server -p 3001
#imedidata: subcontract --rvm ruby-1.8.7-p249@imedidata --chdir vendor/apps/imedidata --signal QUIT -- script/server -p 3001
#imedidata: subcontract --rvm ruby-1.8.7-p249@imedidata --chdir vendor/apps/imedidata -- script/server -p 3001


cleaned up Procfile:
iir: rails server -p 3000
imedidata: subcontract --rvm ruby-1.8.7-p249@imedidata --chdir vendor/apps/imedidata -- bundle exec script/server -p 3001


4 subcontractor entries to choose from
  # gem "subcontractor", "~> 0.3.1"
  # gem "subcontractor", :path => "~/projects/subcontractor"
  #gem "subcontractor", '0.3.0', :path => "~/projects/subcontractor"
  gem "subcontractor"




why does vendor apps imedidata now say -dirty?? at end of subproject commit 204920394820394802938-dirty
  
  
gem install subcontractor --system
so system by default is 1.8.7
so then will be installed as 1.8.7
and will run from command line as 1.8.7
and thus wont need changes
this is a crazy theory of ugandhars
same with foreman - maybe


but heres what needs to happen
ideally tony will change the gem
if not i can temproraly set the gem up in github magibson
and if need be we can set up a mdsol subcontractor repo with isaac and get the gem there


alternatively we can do ugandhars solution where one installs gem not from gemfile but on command line
and then it should run as 1.8 - and prob foreman that way too


the advantadge of the other way is that now the developer doesnt have to separately install foreman and subcontractor
but gets it from the gemfile install


but for now since im the only 1 using iir then i can just keep it working proper locally until
theres a 2nd iir developer popping in - by that time tony hopefully will have made change


well see what ben says on commit


stash wont grab an unadded file
i think i need to add it and then stash it then make branch


the -dirty flag means ive made changes - which i did - to imedidata
i put a test procfile in which ill delete
m Procfile 
imtest: cd . ; bundle exec script/server -p 3001


and .rvmrc which i guess i could delete too? or could keep and just dont commit the -dirty


m .rvmrc 
rvm use ruby-1.8.7-p249@imedidata


double clicking a black no git file in gitx will do an add which should be grabbed by stash i think


cool gonna do pr to tony once he has a feature branch in place


ok did pr for foreman stuff
on to #10 - mauth signer
just need to gem install mauth signer - lets look at what we did in imedidata


  gem 'mauth_signer', :git => 'git@github.com:mdsol/mauth_signer.git', :tag => "v0.6.3"
check that this is latest with matt i suppose
on https://sites.google.com/a/mdsol.com/knowledgebase/home/departments/engineering/on-demand-portfolio/services/core-services/mauth/rack-mauth 
its updated
gem 'rack-mauth', :git => "git@github.com:mdsol/rack-mauth.git", :tag => "v1.0.1", :require => 'rack/mauth'
gem 'mauth_signer', :git => 'git@github.com:mdsol/mauth_signer.git', :tag => 'v1.0.1'


from ben 
Foreman needs to be part of the system gem set.  If you bundle exec foreman start it will load the current projects gemset and muck with the other apps that start up.


dam - who knew - well im learning and i learned a lot in the process


taking out of gemfile!
group :development do
  # gem "foreman", "~> 0.27" # foreman 0.36 working ok, no need at this point to do 0.27
  # Procfile should use subcon --chdir NOT cd command
  gem "foreman", "~> 0.36"
  gem "subcontractor", "~> 0.3.1"
end


do bundle wipeout and test


set up engineering page with setup instructions


gem uninstall foreman
gem uninstall subcontractor


gem install foreman --system 
gem install subcontractor --system
that doesnt work
how does balance do this - course balance is 1.8


rvm default?
goes to ruby-1.8.7-p352


bundle exec foreman start 




rvm use system


WARNING:  Installing to ~/.gem since /Library/Ruby/Gems/1.8 and
          /usr/bin aren't both writable.
WARNING:  You don't have /Users/magibson/.gem/ruby/1.8/bin in your PATH,
          gem executables will not run.
ERROR:  Error installing foreman:
        thor requires RubyGems version >= 1.3.6


# installing stuff into system land
rvm use system
# update to latest rubygems
sudo gem update --system
# install foramen into system with latest rubygems doing the install!
sudo gem install foreman
sudo gem install subcontractor




monday 1/30/11
ok where are we at
so after much discussion with ugandhar ben yi & geoffrey going to actually stick with putting
foreman and sunctonractor in gemset
which is how the last commit had it
i think just need to update to latest version of subcontractor - which is my change! for 1.9
and thats about it - should it auto update to newer versions? funny symbol in gemfile?


potential rake tasks??
1) run - foreman start ?
2) clean gemset - "rvm gemset empty; gem install bundler; bundle install"
3) run debug - just run iir in debug mode - not with foreman - no need to use foreman
3b) run supprting debug tasks - run foreman with all but iir - make special foreman file for this
  -- currently just imedidata - eventually also cas and others


need to learn rake
from top of ~/iir/Rakefile
# Add your own tasks in files placed in lib/tasks ending in .rake,
# for example lib/tasks/capistrano.rake, and they will automatically be available to Rake.


nothing currently in iir/lib/tasks
rake tasks are written in ruby - how nice!


oh 9B - install instrcuctions on new engineer page


 Benjamin:  correct, don't put it in the Gemfile and document foreman and subcontractor as required system gems on medinet
in addition to bundler
 me:  right should i start a new iir tech page?
or add to an existing page on medinet?
 Sent at 1:15 PM on Friday
 Benjamin:  The current page is kind of product oriented, I would make an engineering type page with setup info etc.
Same spots as iMedidata and Balance
under PaaS teams


tues 1/31


install instructions are in - 1st cut - and 2nd cut
will need additional iterations as someone tries it with nothing previously installed


10) put in mauth signer
seems to me thats just grabbing it - putting in gemfile - trivial right
13 will need some expanding
start a new branch i think
 
gem 'mauth_signer', :git => 'git@github.com:mdsol/mauth_signer.git', :tag => 'v1.0.0'


i think this can be


gem 'mauth_signer', :git => 'git@github.com:mdsol/mauth_signer.git', '>=v1.0.0'
i think tag is optional and i think the version can take >= and ~>
put in gemfile


dont forget to pull latest into develop!


dev
pdev
git checkout feature/mauth-signer
 git merge develop


gem 'mauth_signer', :git => 'git@github.com:mdsol/mauth_signer.git', '>=v1.0.0'
bundle install
has to have :tag - unclear what michael showed me
gem 'mauth_signer', :git => 'git@github.com:mdsol/mauth_signer.git', :tag => '>=v1.0.0'


ok thats trivial of course


on to 11
11) make public private key pair
can just use the ones i already have
actually i already have that token on server so maybe make a new pair so dont get muddled? may not actually matter?




12) install keys with matts commands
To remove old SecurityTokens, do the following in a rails console in the environment (e.g. development, sandbox) in which you are testing:


SecurityToken.find_by_app_uuid!("your app_uuid here").destroy!


i need an app uuid
i think i can make it up anyway i want 
jazzhands had some formal process but i dont think thats needed here for now
so just "iir-dev-test-app-uuid" will do
oh wait does imedidata need to know my app uuid - i dont think so 
i think that would just be for old system


ok 1st need to go into imedidata local and create an app as admin 
oh for that i would need to be able to go to webpage


once create app then query for app_uuid
App.last or something


imedidata new setup page:
https://sites.google.com/a/mdsol.com/knowledgebase/home/departments/engineering/on-demand-portfolio/paas-high-performance-teams/imedidata-engineering/imedidata-install-setup


time to install authmedidata!


PART 3: INSTALL AUTHMEDIDATA


In a new shell, follow the rvm instructions from before, using ruby 1.9.2-p290 with authmedidata (for example) as the gemset name. Remember to gem update --system and checkout the gemset before the next step.


Now clone the authmedidata repository, install the gems and run the server:


% git clone git@github.com:mdsol/authmedidata.git
% bundle install
% rails server


Your environment should be fully configured at this point. Navigate to http://localhost:3000 to view the running iMedidata app.


AUTHMEDIDATA SUBMODULE
cd vendor/apps
how do i make a new submodule i forgot again
git submodule add git@github.com:mdsol/imedidata.git vendor/apps/imedidata ->
git submodule add git@github.com:mdsol/authmedidata.git vendor/apps/authmedidata


this does git add for you - just need to do git commit & push


make gemset for mauth!
cd vendor/apps/imedidata  ??
rvm list
rvm gemset list
rvm gemset create imedidata
p249 is the sanctioned cloud ruby for imedidata
rvm use 1.8.7-p249@imedidata


pd vendor/apps/authmedidata
rvm use ruby-1.9.2-p290
rvm gemset create authmedidata
rvm use ruby-1.9.2-p290@authmedidata
# clean it out why not
rvm gemset empty
gem install bundler
bundle install


add to foreman and try running - dont need to set up db???
rails server runs it


rails server
=> Booting WEBrick
=> Rails 3.1.0 application starting in development on http://0.0.0.0:4567
=> Call with -d to detach
=> Ctrl-C to shutdown server
[2012-01-31 14:08:16] INFO  WEBrick 1.3.1
[2012-01-31 14:08:16] INFO  ruby 1.9.2 (2011-07-09) [x86_64-darwin10.8.0]
[2012-01-31 14:08:16] INFO  WEBrick::HTTPServer#start: pid=60059 port=4567


seems to work on port 4567


ok lets try from foreman
authmedidata: subcontract --rvm ruby-1.9.2-p290@authmedidata --chdir vendor/apps/authmedidata -- rails server


cd iir
have to be in iir gemset!
iir
cur
fs


well holy crap it worked
localhost 3000 just shows a generic rails page
hmmm - need to get to imedidata
should look at what balance does i guess
probably routes.rb


we need to get into imedidata to and create an app


http://localhost:4567/
doesnt work
i think this is because db hasnt been setup in authmedidata yet
ActiveRecord::ConnectionNotEstablished


the imedidata nor balance show a database file that needs copying oddly but im quite sure there is
lets look at balance
balance is out of date - its doing castronaut not authmedi - and maybe castro doesnt require
a db?


cp ~/projects/authmedidata/config/database.yml ~/iir/config/authmedidata_database.yml
git add
add to docs!
cp config/authmedidata_database.yml vendor/apps/authmedidata/config/database.yml


uh oh - authmedidata didnt seem to die from foreman??
ugandhar may be right? but wait then subcontract wouldnt even be recognized
wouldnt even launch


dam still getting connection not established even with db yaml in place


not dying for kill - and it spews a lot on kill with active record connection not established
i think i have to do some rake db stuff


i might need to do this - why isnt this in gemfile?
env ARCHFLAGS="-arch x86_64" gem install mysql -- --with-mysql-dir=/usr/local --with-mysql-config=/usr/local/mysql/bin/mysql_config


do for both imedi and auth ?


did it for imedi - still doesnt work
gonna do for auth now


still not working
auth ->
mv config database.yml.example to database.yml
rake db:create
rake db:migrate
!!! from chad - not on imedidata webpage - not on balance webpage
does balance do seomthing fancy with imedidata db??
rake db:create
WARNING: 'require 'rake/rdoctask'' is deprecated.  Please use 'require 'rdoc/task' (in RDoc 2.4.2+)' instead.
    at /Users/magibson/.rvm/gems/ruby-1.8.7-p249@imedidata/gems/rake-0.9.2.2/lib/rake/rdoctask.rb
WARNING: Global access to Rake DSL methods is deprecated.  Please include
    ...  Rake::DSL into classes and modules which use the Rake DSL methods.
WARNING: DSL method Cucumber::Rake::Task#desc called at /Users/magibson/.rvm/gems/ruby-1.8.7-p249@imedidata/gems/cucumber-0.8.5/lib/cucumber/rake/task.rb:140:in `define_task'
WARNING: DSL method Cucumber::Rake::Task#task called at /Users/magibson/.rvm/gems/ruby-1.8.7-p249@imedidata/gems/cucumber-0.8.5/lib/cucumber/rake/task.rb:141:in `define_task'
imedidata_development already exists


bundle exec?
already exists - were ok
put in docs


rake db:migrate


woops i never put database file - i messed up the copy
cp config/authmedidata_database.yml config/database.yml


ok now its working
well 4567 is directing to 3000 at least
not dying well - argh! may have to go into subcontract??


1 - dam we have to figure out why authmedidata wont get killed
2 - need to bring up imedidata login page


1 is important - we cant forget 
but lets do 2 and revisit 1
1 i suspect is a subcontract bug that prob not too hard to fix ??


balance rt (rake routes)
 root      /    {:controller=>"application", :action=>"login"}


routes.rb
  #Default
  map.root :controller => 'application', :action => 'login'
thats old rails 2


heres docs on rails 3 routes:


3.14 Using root
You can specify what Rails should route "/" to with the root method:


root :to => 'pages#main'
You should put the root route at the top of the file, because it is the most popular route and should be matched first. You also need to delete the public/index.html file for the root route to take effect.


  in routes.rb itself
  # You can have the root of your site routed with "root"
  # just remember to delete public/index.html.
  #  root :to => 'welcome#index'


  # The priority is based upon order of creation:
  # first created -> highest priority.


  # You can have the root of your site routed with "root"
  # just remember to delete public/index.html.
  root :to => 'welcome#index'


from routes.rb that will prob be deleted
  # Sample of regular route:
  #   match 'products/:id' => 'catalog#view'
  # Keep in mind you can assign values other than :controller and :action


  # Sample of named route:
  #   match 'products/:id/purchase' => 'catalog#purchase', :as => :purchase
  # This route can be invoked with purchase_url(:id => product.id)


  # Sample resource route (maps HTTP verbs to controller actions automatically):
  #   resources :products


  # Sample resource route with options:
  #   resources :products do
  #     member do
  #       get 'short'
  #       post 'toggle'
  #     end
  #
  #     collection do
  #       get 'sold'
  #     end
  #   end


  # Sample resource route with sub-resources:
  #   resources :products do
  #     resources :comments, :sales
  #     resource :seller
  #   end


  # Sample resource route with more complex sub-resources
  #   resources :products do
  #     resources :comments
  #     resources :sales do
  #       get 'recent', :on => :collection
  #     end
  #   end


  # Sample resource route within a namespace:
  #   namespace :admin do
  #     # Directs /admin/products/* to Admin::ProductsController
  #     # (app/controllers/admin/products_controller.rb)
  #     resources :products
  #   end




  # See how all your routes lay out with "rake routes"


  # This is a legacy wild controller route that's not recommended for RESTful applications.
  # Note: This route will make all actions in every controller accessible via GET requests.
  # match ':controller(/:action(/:id(.:format)))'


  # You can have the root of your site routed with "root"
  # just remember to delete public/index.html.
  root :to => 'welcome#index'


but there is no public/index.html??? at least not in app???
oh i see its litereally in iir/public/inedix.html


mv public/index.html ~/fiddle/iir/
need to remove from git too


balance application_controller.login
  # Action to log the user in
  def login
    redirect_to studies_path(params.reject{|k,v| !%w(study_id studygroup_id study_group_uuid).include?(k.to_s) })
  end
# Filters added to this controller apply to all controllers in the application.
# Likewise, all the methods added will be available for all controllers.
class ApplicationController < ActionController::Base
  before_filter :auto_session_timeout, :except => :logout
  before_filter :set_session_user_id, :except => :logout
  before_filter :check_balance_imed_sync_required, :except => :logout


hmmm - redirecting to studies path


gmc has some gmc library plugin submodule in vendor/plugins


put tasks on rally!!!!
seed imedidata db
balance used bootstrap.rb that is inside of imedidata no less
but iir is going to just load up a small db like imedidata does
chad is going to send an imedidata db


tasks to put on board


2/1
email to kevin jay ben
hey
i havent been very good about adding tasks that ive been working on to
the rally board
as ive been doing more than what is listed in rally
and rally still seems to be broken at the moment
is there a way to add tasks?


i need to add:


-1) document setting up iir - done - but is continuous really
0) put authmedidata into iir - done - ben just made pr for this
1) seed iir imedidata database with small database (get from chad) 2 hours
2) document db seeding on knowledge base - .5 hour
3) research how balance & gmc do login - 2 hours
4) implement login on iir imitating balance - 4 hours
5) create application in local imed for iir & save to seed db - 1 hour
6) install keys in mauth sandbox for iir w app id & key pair


another item just cropped up
research how authmedidata(cas's replacement) needs to work - 3 hours
implement login using authmedidata in iir - 2 hours


im guessing too late now but tasks i did at end of last sprint that i
shouldve put in rally:
initialize iir rails app,fix subcontractor for 1.9, make gemset for
imedidata, get subcontractor working in foreman/procfile, document
making gemsets for setup


putting in mauth signer gem is done


db setup is waiting on chad


lets research how balance does login


balance rt (rake routes)
 root      /    {:controller=>"application", :action=>"login"}


class ApplicationController < ActionController::Base
  before_filter :auto_session_timeout, :except => :logout
  before_filter :set_session_user_id, :except => :logout
  before_filter :check_balance_imed_sync_required, :except => :logout


  # Action to log the user in
  def login
    redirect_to studies_path(params.reject{|k,v| !%w(study_id studygroup_id study_group_uuid).include?(k.to_s) })
  end


timeout not interesting of course


  # Sets a session's user_id attribute for CAS.
  def set_session_user_id
    cas_attrs = session[:cas_extra_attributes]
    @session_user_id = cas_attrs[:user_id] unless cas_attrs.blank?
  end


thats just setting vars - not calling any methods


  # Sync user and study info. with imedidata if not already done in this session
  def check_balance_imed_sync_required
    if !session[:balance_imed_sync_time]
      balance_imed_sync(@session_user_id, 0)
    end
  end


  # Synchronize imedidata and balance data (studies, roles, etc).  Time since
  # last sync must be more than delta seconds.
  def balance_imed_sync(user_id, delta=10)
    now = Time.now
    session[:balance_imed_sync_time] ||= now


    if session[:balance_imed_sync_time] + delta <= now
      User.find_remote(user_id).make_current!
      session[:balance_imed_sync_time] = Time.now
    end


    I18n.locale = User.current.locale || "eng"
    get_current_nav
  end


so app_control is calling in pre filter check_bal_im_sy_req
which calls bal_im_sync
which calls User.find_remote(user_id).make_current


we should start balance and put a breakpoint in
theres some if's in there so unclear if this is the path taken


bal
comment out 1st foreman line
sep terminal: debug-run-bal
localhost:3000


User.find_remote is i think the crucial bit


though i cant get a breakpoint to hit on going to balance login page


class User < MedidataUser


  # Returns the remote user with a given ID.  
  def self.find_remote(user_id)
debugger
    get_remote_user(user_id)
  end


wheres MedidataUser?
vendor/plugins/imedidata_client/lib/imedidata_client/medidata_user.rb
1:class MedidataUser < ActiveRecord::Base


its a plugin - imedidata_client
which i think is a submodule?
where are submodules listed?
where do i get this submodule?


  def self.get_remote_user(user_id)
    user = self.create_and_cache(user_id)
    if user
      user.associate_studies
      MedidataStudyGroup.fetch_all
    end
    return user
  end


yes its in github


~/b (master) $ git submodule status
 c729b7c10bbaea038f4d061b04bbd9def7a07c41 vendor/apps/castronaut (branched-v2010.1.0-298-gc729b7c)
 edf44b715386b677e2264fabcfe3c62f85622639 vendor/apps/imedidata (release2011.1.4.2-675-gedf44b7)
 6fee9373e52a6e7591820a9133537169834009eb vendor/plugins/acts_as_auditable (v2010.1.0-15-g6fee937)
 0473d6c0867fe5e327ec8084943e7b04c47563c2 vendor/plugins/imedidata_client (balance-release-2011.2.0-34-g0473d6c)
 5bb763e5a8059d35e81ad25579558fda37062e05 vendor/plugins/medidata_buttons (v2010.1.0-23-g5bb763e)
 75d741453f54c3a9c45368e8edf69732e969363c vendor/plugins/rubycas-client (remotes/origin/session_stores)
 a77bd87143e8587e90d60fc1fb0ebcbddff3d3fc vendor/plugins/shamus (0.0.1-3-ga77bd87)
 cf5e4407d1e6127db415fd2f7886a79e6921ec22 vendor/plugins/watirworld (cf5e440)


how bout that


email to chad:


hey chad
well first a reminder to send me your imedidata db - thanks


so i am working on setting up authmedidata in iir
got it as a submodule, got it working in foreman with subcontractor
(theres a bug that it doesnt get killed - todo)


but now im looking at how balance does login - and its using cas 1st of all
is there a client that is using authmedidata that i can look at for an
example - i know its relatively new


so i know balance uses imedidata-client plugin and so does gmc
but ben is saying thats not necasary for iir - and besides its all different now


so looking at balance i see that in plugin imedidata_client/init.rb -
im guessing init.rb gets called when the plugin is included?
theres this


CLOUD_ENV = YAML.load_file("#{RAILS_ROOT}/config/cloud.yml")[RAILS_ENV]


require 'casclient'
require 'casclient/frameworks/rails/filter'


CASClient::Frameworks::Rails::Filter.configure(
 :cas_base_url => CLOUD_ENV['cas_base_url']
)


a bunch of requires


ActionController::Base.send :include, Medidata::Client


so from talking to ben my sense is that i need to do something
likewise in iir - though dont need to do it as a plugin - at least for
now.
but it should now talk to authmedidata instead of cas of course
so what are the analogous calls i need to make to authmedidata
is there docs or examples or a client that is using authmedidata to look at


thanks
end of email


does jazzhands use auth? i wouldnt be surprised


imedidata itself uses authmedidata - so lets look at that 
ask michael or yale where that is


actually we got the db lets load it up


in imedidata app/con/application_controller
class ApplicationController < ActionController::Base
  include AuthenticatedSystem


before_filter CASClient::Frameworks::Rails::Filter


so whats authenticated system
and wheres CASCLIENT?


learn about mixins


require is a lib
include is a mixin!
need to have require if comes from another file
wow mixins are funky


ack:
vendor/plugins/restful_authentication/generators/authenticated/templates/authenticated_system.rb
1:module AuthenticatedSystem


is restful 
~/projects/magibson-imedidata (feature/mauth) $ submod-status
 b72d24ca9c4e472e4154a3721672729f579e9ff3 config/locales (heads/master)
 04c06c09090fc48a35891de9a99842f8ef19176b vendor/plugins/acts_as_auditable (v2010.1.0-12-g04c06c0)
 9e54a77a187dea175d1a2c43ab5188e03cc4ff93 vendor/plugins/medidata_buttons (v2010.1.0-37-g9e54a77)
 75d741453f54c3a9c45368e8edf69732e969363c vendor/plugins/rubycas-client (remotes/origin/session_stores)
 bc8218b8eee7fe5c4dbf03bcabb839d3a77c7f75 vendor/plugins/shamus (0.0.1~7)
 10873453b54de991916850fd29aed04e8a868ea4 vendor/plugins/watirworld (1087345)


https://github.com/mdsol/imedidata/tree/master/vendor/plugins
can see plugins as submodiules and not submod


from rubycas-client submodule
vendor/plugins/rubycas-client/lib/casclient/frameworks/rails/filter.rb
5:  module Frameworks
vendor/plugins/rubycas-client/lib/casclient/frameworks/rails/filter.rb
4:module CASClient


ah notice both old and new have this same line:
 before_filter CASClient::Frameworks::Rails::Filter


imedidata puts that right in the application controller
balance puts that line in imedidata_client submodule plugin


and imedidata has the include AuthenticatedSystem plugin - do we need that??
AuthenticatedSystem has methods like
   def logged_in?
    def current_<%= file_name %>
    def authorized?(action = action_name, resource = nil)
    def login_required
    def access_denied
...
imedidata app_cont
\has a set_current_user method - reuse? copy?
  before_filter :set_current_user, :except => :login
checks if user is logged in - sends them to login if not
uses AuthenticatedSystem plugin


put before filter cas in iir application controller
something tells me we need to require cas somewhere??? surely its not finding it automaticallly


wait the imedidata login page is now coming up with localhost 4567
was that happening before?
ah but loclhost 3000 is not going there


getting active record error - because theres no db
but we have no db!


get http://stackoverflow.com/questions/821251/how-to-configure-ruby-on-rails-with-no-database




Uncomment this line in the environment.rb


config.frameworks -= [ :active_record, :active_resource, :action_mailer] - rails 2 - no good


that line doesnt exist but this does
  config.action_controller.session_store = :active_record_store


for rails 3
http://stackoverflow.com/questions/3954307/rails-3-how-do-i-avoid-database-altogether


actuall just talked to ben we do need a db for auth - iir has to cache user login stuff from auth apparently
bummer
supposedly auth when installed as plugin puts a migration in db/migrate
nope - no migration


2/2 thurs
ok where am i
several things to work on
1 need to put in db yaml file for auth db - maybe do that 1st and see what 3000 does now
2 need to put auth in the main page
dont we need a maing page - well know we just need to redirect to auth/medidata for now i think
3 need to fix 
4 install chad imedi db


db yaml file i guess we should look at imed & balance db file
imed:
local:
    adapter: mysql
    database: imedidata_development
    username: root
    password: 
    host: localhost
test:
    adapter: mysql
    database: imedidata_test
    username: root
    password: 
    host: localhost
...
BALANCE:
local_mysql: &local_mysql
  adapter: mysql
  username: root
  password:
  host: localhost
  encoding: utf8  
  
test:
  <<: *local_mysql
  database: balance_test<%= ENV['TEST_ENV_NUMBER'] %>


development:
  <<: *local_mysql
  database: balance_development


sanitation:
  <<: *local_mysql
  database: balance_sanitation




authmedidata
development:
  adapter: mysql2
  encoding: utf8
  reconnect: false
  database: authmedidata_development
  pool: 5
  username: root
  password:
  socket: /tmp/mysql.sock




i think i want a db called iir_dev....
copy balance - its dryest


cp config/database.yml.sample config/database.yml
bundle install
./bin/balance_init


imedi
mv ~/Downloads/database.yml config/database.yml


put in database.yml.sample


imedidata has a local that points to dev - balance does not have a local
for now no local i guess


still getting
ActiveRecord::ConnectionNotEstablished
but i havent actually created db


fri 2/3
where we at
i need to put in auth per chads suggestions
chad chat about auth in 111
theres a few config files to copy for auth
and most imporatnly theres plugin ruby cas client
and use in same way as balance
so can just go with study of balance and how it does it
cas & auth are very similar - auth is just rails 3 - cas is sinatra
which at the time didnt work with the error webby thing


and want a login and logout method
not in application but in a session controller
see how balance does it


i think need to do rake db:create?
ake db:create
rake aborted!
uninitialized constant Mysql


Tasks: TOP => db:create
(See full trace by running task with --trace)
oish


i think i need to install mysql gem!
in imedidata didnt need to install mysql gem??
funny gem-list for imedidata does not include mysql 
but who knows imedidata may not be properly setup just not tested yet hasnt hit db yet


do we need to do this?
is the gem update system necasary before?
gem update --system
gem update --system 1.5.3
env ARCHFLAGS="-arch x86_64" gem install mysql -- --with-mysql-config=/usr/local/mysql/bin/mysql_config


balance does list mysql as a gem
mysql (2.8.1)


ok installed with
env ARCHFLAGS="-arch x86_64" gem install mysql -- --with-mysql-config=/usr/local/mysql/bin/mysql_config


notice this isnt in gemfile nor gemfile lock




rake db:create
rake aborted!
uninitialized constant Mysql


Tasks: TOP => db:create
(See full trace by running task with --trace)


dam - still happening - thought mysql gem would take care of this




gem-list -d mysql


did gem uninstall mysql
and then put mysql in gemfile
gem 'mysql', '2.8.1'
and did clean bundle install
and lo and behold rake db:create worked


ok thats done i think next is cas client submodule plugin and get migration from that


so now is gives this message
uninitialized constant ApplicationController::CASClient
so thats good
though it should be finding that right


need to incldue CASClient
ah! this is from the plugin!!
lets look at balance


~/b (master) $ git submodule status
 c729b7c10bbaea038f4d061b04bbd9def7a07c41 vendor/apps/castronaut (branched-v2010.1.0-298-gc729b7c)
 edf44b715386b677e2264fabcfe3c62f85622639 vendor/apps/imedidata (release2011.1.4.2-675-gedf44b7)
 6fee9373e52a6e7591820a9133537169834009eb vendor/plugins/acts_as_auditable (v2010.1.0-15-g6fee937)
 0473d6c0867fe5e327ec8084943e7b04c47563c2 vendor/plugins/imedidata_client (balance-release-2011.2.0-34-g0473d6c)
 5bb763e5a8059d35e81ad25579558fda37062e05 vendor/plugins/medidata_buttons (v2010.1.0-23-g5bb763e)
 75d741453f54c3a9c45368e8edf69732e969363c vendor/plugins/rubycas-client (remotes/origin/session_stores)
 a77bd87143e8587e90d60fc1fb0ebcbddff3d3fc vendor/plugins/shamus (0.0.1-3-ga77bd87)
 cf5e4407d1e6127db415fd2f7886a79e6921ec22 vendor/plugins/watirworld (cf5e440)




balance - but chad said dont use master - use branch
 vendor/plugins/rubycas-client (remotes/origin/session_stores)


from madalina
in imedidata we curently use the latest commit on session_stores branch of https://github.com/edan/rubycas-client


ok lets submodule the rubycas-client


git submodule add git@github.com:mdsol/imedidata.git vendor/apps/imedidata


git submodule add git@github.com:edan/rubycas-client.git vendor/plugins/rubycas-client
i think have to commit this first and then switch to session_stores branch
gitx - commit & push
ok now
cd vendor/plugins/rubycas-client
git checkout -b session_stores origin/session_stores


localhost:3000
Cannot use the CASClient filter because it has not yet been configured.
excellent - p[rogress - need to now configure cas client somewhere


i think i found it
balance/config/initializers/load_config.rb


mon 2/6
need to get cas configged!


heres balance load config.rb:


AMAZON_ENV = YAML::load(ERB.new(IO.read(File.join(RAILS_ROOT, 'config', 'amazon_s3.yml'))).result)[RAILS_ENV]


CLOUD_ENV = YAML::load(ERB.new(IO.read(File.join(RAILS_ROOT, 'config', 'cloud.yml'))).result)[RAILS_ENV]


WEBHELP_INFO = YAML.load_file("#{RAILS_ROOT}/config/webhelp.yml")[RAILS_ENV]
unless %w(test).include? RAILS_ENV
  WEBHELP_MAPPING = begin
    YAML.load(Net::HTTP.new(WEBHELP_INFO["webhelp_bucket"]).request(Net::HTTP::Get.new("/WebHelpMapping/webhelp_mapping.yml")).body)
  rescue SocketError
    {}
  end
end


CASClient::Frameworks::Rails::Filter.configure(
  :cas_base_url => CLOUD_ENV['cas_base_url'],
  :enable_single_sign_out => true,
  :service_session_lookup_storage => :db)
  
S3_FIELD_MIXIN_EXCLUDED_ENVS = ["development","test"]
ActiveRecord::Base.send(:include, S3FieldMixin)


relevant bits


CLOUD_ENV = YAML::load(ERB.new(IO.read(File.join(RAILS_ROOT, 'config', 'cloud.yml'))).result)[RAILS_ENV]
CASClient::Frameworks::Rails::Filter.configure(
  :cas_base_url => CLOUD_ENV['cas_base_url'],
  :enable_single_sign_out => true,
  :service_session_lookup_storage => :db)


need cloud.yml! in config - copy that
chad mentioned theres another thing we'll need thats new but dont know what that is yet


config/cloud.yml:
test:
    cas_domain: localhost
    imed_domain: localhost
    imedsql_domain: localhost
    conduct_domain: localhost
    imed_base_url: http://<%= `uname -n`.chomp %>:<%= (4100 + ( ENV['TEST_ENV_NUMBER'].to_i || 0 )).to_s %>
    cas_base_url: http://<%= `uname -n`.chomp %>:<%= (4200 + ( ENV['TEST_ENV_NUMBER'].to_i || 0 )).to_s %>
    conduct_base_url: http://<%= `uname -n`.chomp %>:<%= (4300 + ( ENV['TEST_ENV_NUMBER'].to_i || 0 )).to_s %>


development: &default_settings
    cas_domain: localhost
    imed_domain: localhost
    imedsql_domain: localhost
    conduct_domain: localhost
    cas_base_url: http://<%= `uname -n`.chomp %>:4567
    imed_base_url: http://<%= `uname -n`.chomp %>:3001
    conduct_base_url: http://<%= `uname -n`.chomp %>:3000


sanitation:
    <<: *default_settings


that all seems generic


/Users/magibson/projects/iir/config/initializers/load_config.rb:1:in `<top (required)>': uninitialized constant RAILS_ROOT (NameError)
10:12:52 iir.1           |         from /Users/magibson/.rvm/gems/ruby-1.9.2-p290@iir/gems/railties-3.1.3/lib/rails/engine.rb:556:in `block (2 levels) in <class:Engine>'
10:12:52 iir.1           


FROM BALANCE:
boot.rb
6:RAILS_ROOT = "#{File.dirname(__FILE__)}/.." unless defined?(RAILS_ROOT)


wow theres a whole bunch of stuff in balance boot.rb that looks like we would need 
- loading up initializers and scuh


/Users/magibson/projects/iir/config/initializers/load_config.rb:1:in `<top (required)>': uninitialized constant RAILS_ENV (NameError)
10:17:47 iir.1           | 


schedule.rb
3:job_type :run_in_rails_root, 'export RAILS_ENV=:environment && cd :path && :task > :path/log/cron.log 2>&1


lib/tasks/shell.rake
58:      ENV["RAILS_ENV"] = env.to_s
# Execute the block in the specified environments
def in_env(*envs)
  envs.each do |env|
    pid = fork do
      ENV["RAILS_ENV"] = env.to_s
      yield
    end
    Process.wait(pid)
  end
end


so who calls in_env?
lib/tasks/app.rake
37:    in_env(*BALANCE_ENVS) { rake(*args) }


namespace :app do
  BALANCE_ENVS   = (ENV["RAILS_ENV"] && [RAILS_ENV]) || %w(development test)
....
  def balance_rake(*args)
    in_env(*BALANCE_ENVS) { rake(*args) }
  end


 ack balance_rake
lib/tasks/app.rake
15:      balance_rake "db:migrate"
36:  def balance_rake(*args)


lib/test_tasks/cruise.rb
16:      balance_rake "db:migrate"
17:      balance_rake "db:seed"


hmmm i think this is just for migrate
how does run get its BALANCE_ENV???


http://stackoverflow.com/questions/2715035/rails-env-vs-rails-env
Rails.env!


Before Rails 2.x the preferred way to get the current environment was using the RAILS_ENV constant. Likewise, you can use RAILS_DEFAULT_LOGGER to get the current logger or RAILS_ROOT to get the path to the root folder.


Starting from Rails 2.x, Rails introduced the Rails module with some special methods:


Rails.root
Rails.env
Rails.logger
This isn't just a cosmetic change. The Rails module offers capabilities not available using the standard constants such as StringInquirer support. There are also some slight differences. Rails.root doesn't return a simple String buth a Path instance.


Anyway, the preferred way is using the Rails module. Constants are deprecated in Rails 3 and will be removed in a future release, perhaps Rails 3.1.


that fixed it
CLOUD_ENV = YAML::load(ERB.new(IO.read(File.join(RAILS_ROOT, 'config', 'cloud.yml'))).result)[Rails.env]


/Users/magibson/projects/iir/vendor/plugins/rubycas-client/lib/casclient/frameworks/rails/filter.rb:146:in `configure': uninitialized constant RAILS_DEFAULT_LOGGER (NameError)
10:54:12 iir.1           |         from /Users/magibson/projects/iir/config/initializers/load_config.rb:3:in `<top (required)>'


            @@config[:logger] = RAILS_DEFAULT_LOGGER unless @@config[:logger]
-->
            @@config[:logger] = Rails.logger unless @@config[:logger]




from chad/checkmate
CLOUD_ENV = YAML.load_file("#{Rails.root}/config/cas.yml")[Rails.env]
CASClient::Frameworks::Rails::Filter.configure(:cas_base_url => CLOUD_ENV['cas_base_url'], :enable_single_sign_out => true, :service_session_lookup_storage => :db, :logger => Rails.logger)


calling cloud.yml cas.yml does seem to make more sense


ok that worked - logger and env both fixed


now a new error
well it up & runs now!
but hitting 3000 does this


Started GET "/" for 127.0.0.1 at 2012-02-06 11:19:22 -0500
11:19:22 iir.1           |   Processing by ApplicationController#login as HTML
11:19:22 iir.1           | Guessed service url: "http://localhost:3000/"
11:19:22 iir.1           | Completed 500 Internal Server Error in 1ms
11:19:22 iir.1           | 
11:19:22 iir.1           | URI::InvalidURIError (bad URI(is not URI?): http://<%= `uname -n`.chomp %>:4567/login):
11:19:22 iir.1           |   
11:19:22 iir.1           | 
11:19:22 iir.1           | Rendered /Users/magibson/.rvm/gems/ruby-1.9.2-p290@iir/gems/actionpack-3.1.3/lib/action_dispatch/middleware/templates/rescues/_trace.erb (1.7ms)


notice its going from 3000 to 4567
so it seems cas is kicking in
lets try with cas line out


and what the fuck is actionpack?
http://rubydoc.info/gems/actionpack/3.2.1/frames
Action Pack is a framework for handling and responding to web requests. It provides mechanisms for routing (mapping request URLs to actions), defining controllers that implement actions, and generating responses by rendering views, which are templates of various formats. In short, Action Pack provides the view and controller layers in the MVC paradigm.


ok so if i take out 
#  before_filter CASClient::Frameworks::Rails::Filter
in application controller 
then get a different error (missing view)


so this says the problem is with cas
so where the hell is this error coming from


its from auth not from cas client
app/models/proxy_granting_ticket.rb
59:    rescue URI::InvalidURIError


app/models/service_ticket.rb
33:        raise URI::InvalidURIError.new("Not HTTP or HTTPS") unless %w{https http}.include?(uri.scheme)
34:      rescue URI::InvalidURIError
83:    rescue URI::InvalidURIError


  #TODO: this might not be needed
  validates_each :service do | model, attr, service|
    message = ""
    if service.blank? then message = :blank
    else
      begin
        uri = URI.parse(service)
        # sometimes this does not throw an error but returns a URI::Generic Object,
        # so test that it has http or https scheme
        raise URI::InvalidURIError.new("Not HTTP or HTTPS") unless %w{https http}.include?(uri.scheme)
      rescue URI::InvalidURIError
        message = :invalid
      end
    end
    model.errors.add(attr, message) unless message.blank?
  end


actually thats not it - look how its immediately rescued - funny code


wait where the hell is this coming from???


http://<%= `uname -n`.chomp %>:4567/login


7:    cas_base_url: http://<%= `uname -n`.chomp %>:<%= (4200 + ( ENV['TEST_ENV_NUMBER'].to_i || 0 )).to_s %>


cas.yml:
    cas_base_url: http://<%= `uname -n`.chomp %>:4567


thats the problem - the <% is not getting processed as ruby code!
lets look at check mate
and what is uname?
chomp takes out newline at end
uname seems to return os name ???
lets look at checkmate


development:
  cas_domain: localhost
  cas_base_url: http://localhost:4567


innovate:
  cas_domain: login-innovate.imedidata.com
  cas_base_url: https://login-innovate.imedidata.com


im just gonna shove that in for now see if it works


taking out from cas.yml(formerly cloud.yml) balance stuff:
test:
    cas_domain: localhost
    imed_domain: localhost
    imedsql_domain: localhost
    conduct_domain: localhost
    imed_base_url: http://<%= `uname -n`.chomp %>:<%= (4100 + ( ENV['TEST_ENV_NUMBER'].to_i || 0 )).to_s %>
    cas_base_url: http://<%= `uname -n`.chomp %>:<%= (4200 + ( ENV['TEST_ENV_NUMBER'].to_i || 0 )).to_s %>
    conduct_base_url: http://<%= `uname -n`.chomp %>:<%= (4300 + ( ENV['TEST_ENV_NUMBER'].to_i || 0 )).to_s %>
development: &default_settings
    cas_domain: localhost
    imed_domain: localhost
    imedsql_domain: localhost
    conduct_domain: localhost
    cas_base_url: http://<%= `uname -n`.chomp %>:4567
    imed_base_url: http://<%= `uname -n`.chomp %>:3001
    conduct_base_url: http://<%= `uname -n`.chomp %>:3000


sanitation:
    <<: *default_settings


also adding for test grigory


heres imedidatas cloud.yml - the test is a little diff
development: &default_settings
  cas_domain: localhost
  imed_domain: localhost
  imedsql_domain: localhost
  conduct_domain: localhost
  cas_base_url: http://localhost:4567
  imed_base_url: http://localhost:3001
  
test:
  <<: *default_settings
  cas_base_url: ""
  imed_base_url: http://localhost:3001


i think its time for a pr as its in a somewhat stable place
though clearly more work needs doing
need to put in chad db with a user




ok lets get migraion in there


 ~/i/vendor/plugins/rubycas-client/generators/cas_client/cas_client_generator.rb
and templates/create_cas_sessions.rb
class CreateCasSessions < ActiveRecord::Migration
  def self.up
    create_table :cas_sessions do |t|
      t.text     :service_ticket 
      t.text  :session_id
    end
  end
 
  def self.down
    drop_table :cas_sessions
  end
end


i think copy create_cas_sessions to iir/db/migrate
yup hafta make a file name with date down centiseconds in it which seems a little over the top
but i guess its a standard
theres prob a rake task that makes this filename for you
nonetheless its in and it worked


whats next - the imedidata db - chads - get it in there
new branch i guess


chads imedidata db - 
user login is superadmin 
pwd is Password1
in email from feb 1


ok this has to go into imedidata db which i already one actually
wait im confused i have one - but balance does one too
or does balance just augment it
i forget how i get into db


it drops & creates tables so it will wipe out whats already there which is fine - wipe it for all i care


does db:migrate migrate both dev & test - doubt it!
i think balance has a rake task for this


so for db we are follwoing imedidata way not balance
however the db that is copied in is NOT the imedidata database.yml.sample
as in db name is balance:
development:
    adapter: mysql
    database: imedidata_balance_development


oh wait lets make another branch
feature/more_iir_setup


dam - not sure how to deal with wierd submodule modifcation issue


im confused 
database.yml is not in git
yet we dont have to make it for every branch????
what does balance do?
add it to git ignore


with imedi db name change need to run rake db:create and rake db:migrate in vendor/imed again


ok so how do i load chads db???
lets look at imedidata startup


chaeck balances cas/auth db.yml
the config for castronaut seems very different


mysql -u root imedidata_development < imedidata-backup.sql


cd iir root
 cp ~/Downloads/checkmate_imedidata_development.sql config/imedidata-iir-dev-db.sql
mysql -u root imedidata_iir_development < config/imedidata-iir-dev-db.sql


alias mysql-iir="mysql -u root imedidata_iir_development"


cool login worked 
need view for application/login i guess??


ok that works - what next? view? 
go into imedidata and make app id? how to go into imedi?


whats the url for imed when running in balance


chicken and egg
need iir to go to imed
need to go to imed to create a valid app id for iir 


http://qp1150wndnm.ad.mdsol.com:3001/?ticket=ST-1328564349rE12AE7F3A44BFBF41E
i think localhost:3001 would do it - of course silly


yes!
http://localhost:3001/?ticket=ST-1328564430r33E5EDA6A13E9C765C


then go into app admin - add app
then it needs a public key??? is this cas? mauth? old request token?
where does the private key go?


in jazzhands
config/keys/apps
grab a key 
an ssl key
and put that in the pulbic key
-----BEGIN RSA PUBLIC KEY-----
MIGJAoGBALTPpMYJlV32yf173k7UcIwxHsk57HM6kn9pts88BXvZ3OOYHVz/qPan
fwLQ4KTOSQiOEgh7+Hj/qKiAhFbJJMh6ECXDkoK30CAdoSccAeaI5nGp6pDXitIk
nD548KX647yQUfO5OMUuSU8lBVGSbdrzdkGNVu5F9g9vzX7LkOc9AgMBAAE=
-----END RSA PUBLIC KEY-----


IIR created. Api Id: d38e7edc-5113-11e1-95fe-70cd60fffe66 Api Token: a29a796599f72bc2f632b4a1a6eaae3a3631ddf0 iMedidata public key: -----BEGIN RSA PUBLIC KEY----- MIGJAoGBANrvxzDxt92vWs73y6a524FxrNOS0+X+E3t2U/BYbfKeg7Tj0IYK4SZ2 +CeTRdt91DOL7sHTk98mHI/r6v2TmlJg9mTOdknjzx6Hj9/WVa56+meaZaNE9+yp 79PjPX9Gy8UglvDBgPy5R6Zu5lzZPMQFxh5LSDZvDtCd+sXMGAsNAgMBAAE= -----END RSA PUBLIC KEY-----


tues 2/7/2012


this is the app uuid 
Api Id: d38e7edc-5113-11e1-95fe-70cd60fffe66
will need this for mauth config of iir!
need to dump this db
alias dump-master="mysqldump -u root -A > master-balance.sql"
mysqldump -u root -A > ~/i/config/imedidata-iir-dev-db.sql


via admin adding app type and app for iir
and study group
and adding user  - accept invitation
to study group and study...


superadmin email is
harrycaul@mdsol.com


-A is all databases
for iir we just want dump for iir stuff


http://dev.mysql.com/doc/refman/5.1/en/mysqldump.html


mysqldump -u root --databases iir_development iir_test > ~/i/config/imedidata-iir-dev-db.sql


wow its really fast!




woops wrong dbs silly - those are the auth iir trivial db 




test is a db that gets wiped out everytime i think?
mysqldump -u root --databases imedidata_iir_development > ~/i/config/imedidata-iir-dev-db.sql


ok what now
maybe a quick look at auth subcontract bug
put up view page 




oh my auth dies fine when only thing in proc file
lets change order
bombs with iir running


its iir & auth - order doesnt matter - imedidata doesnt effect


theres no port specified for auth??? trying -p 3002


hmmm - well table for now - 
but is it funny that calling rails server twice in 1 procfile - shouldnt be i think?
is there another way to bring up auth?
or dig into subcontract and see why it wont kill auth's children


i think i should put up a default blank view page 
look at gmc and balance
gmc:
root  /(.:format)  {:action=>"index", :controller=>"sponsor/studies"}
routes root / to sponsor/studies/index


just  sent out emails - really confused about code sharing between iir & gmc
should i make default
investigator/studies/index
which is iir specific and would not be reused by gmc?
can do for now and change later
just putting up a blank page dont overthing it


so in gmc its in sponsor/studies_controller 
which has class Sponsor::StudiesController < ApplicationController
  include Parley::SponsorAuthentication
not sure what that include is about???


lib/parley/sponsor_authentication.rb
2:module Parley::SponsorAuthentication  
# Place code specific for Sponsor role
module Parley::SponsorAuthentication  
  # Add before filter for checking sponsor permissions
  def self.included(base)
    base.before_filter :check_sponsor_permissions
  end
    
  # TODO change redirect_to to error_page 500 errors
  # otherwise if role will not equal role it will led to infinite loop 
  def check_sponsor_permissions
    if session[:role].blank?
      flash.now[:error] = I18n.t('user.errors.user_has_no_access_with_role', :user_id => cas_session_user_id, :role => Role::SPONSOR_ROLE)
      render_404 and return
    end  
    
    redirect_to site_root_path unless session[:role] =~ /^#{Role::SPONSOR_ROLE}$/i
  end
end


this is not cas - this checking role - sponsor and site and all
will need to put this in eventually
unclear how gmc does authentication
maybe what ugandhar researched was right
only see it here inside imedidata_client - oh that must be where it happens
vendor/plugins/imedidata_client/lib/imedidata_client.rb
4:      base.before_filter CASClient::Frameworks::Rails::Filter


cool got suncontract working needed --signal INT where others didnt


dont have haml put in yet
had to do html for app/views/investigator/studies/index.html


ok put a dummy page in 
so whats next 
mauth to imedidata


need to point to imedidata branch that has mauth working
submod-stat
-f5bdd2809b3610065a642650bd460dbb22915921 vendor/apps/authmedidata
-05a233adcf95aa98e56836e5964cb43313468350 vendor/apps/imedidata
-75d741453f54c3a9c45368e8edf69732e969363c vendor/plugins/rubycas-client
gb
* feature/support_mauth


silly goose youre already pointing to it
though prob needs updating!


ok how do you update to latest submod?
alias add-locale-update="cd ~/i/config/locales; git fetch; git checkout origin/HEAD; cd ../..; git add config/locales"


git fetch
git checkout origin/feature/support_mauth


-Subproject commit 05a233adcf95aa98e56836e5964cb43313468350
+Subproject commit e0662bd1264da8feea09b79ecf0f2d4387078362-dirty


ah this is consistent with what im seeing on git hub
https://github.com/mdsol/imedidata/commit/e0662bd1264da8feea09b79ecf0f2d4387078362
oddly couldnt find 05a??


so 1st get latest from branch - support_mauth imed
write a test? or wait for ben to put in cuc stuff
so then what needs to happen?
iir has to sign a request with mauth - weve got mauth signer - make sure on latest
view show study
controller query model
model sign request and send request off to imedidata
make request just like curlmaker does


1st make a new study-mauth branch




with new branch update have to do bundle install
rvm use ruby-1.8.7-p249@imedidata


 | /Users/magibson/.rvm/rubies/ruby-1.8.7-p249/lib/ruby/1.8/yaml.rb:143:in `initialize': No such file or directory - /Users/magibson/projects/iir/vendor/apps/imedidata/config/cloud.yml (Errno::ENOENT)
getting this error w update
but i thought we did cloud.yml in plugin casruby thing ???


so this is new
and will change install
and every timewe update imed submodule this has to be recopied - bummer
would be nice as a rake task i suppose


put in docs things that have to happen with new imedidata submodule
submodule update
cp database.yml
cp cloud.yml
cd imed
rake db:migrate


what used to be contents of cloud.yml in imed??? 3000 or 3001?
yea used to be 3001!! how strange to make 3000 now


hmmm - from auth
imedidata_development database is not configured
oh theres prob something in cas config?


~/i (feature/more-setup) $ ack imedidata_development
vendor/apps/imedidata/config/database_environments.yml
10:    database: imedidata_development
is database_environments even used????


sambple db is wrong!!! fix this
darn lost app_id stuff
also reboot mac
and setup laptop!




wed 2/8
ben added a bunch of stuff
!!! at begining of haml is doc type
http://haml-lang.com/docs/yardoc/file.HAML_REFERENCE.html#doctype_


always run bundle install - never sudo bun in


bundle check - list missing dependencies


bundle help


:group => :test  - env


--without=test - leave out test gems


bundle lock - locks down versions - gemfile.lock


bundle install will only install locked version
dont modify lock file


bundle install --relock - updates gems from lock


wow .bundle by default?????
bundle pack -> vendor/cache dir puts in repo


railsPlugins.org


ok very interesting about bundler 
ben is configged differently to bundle install to .bundle directory
NOT to gemset which is default now (his way was previously default)




ok so 1st the db got all screwed up
need to fix that
i think its the db change thats the problem
i think need to change db name in db dump file




 Host: localhost    Database: imedidata_iir_development


CREATE DATABASE /*!32312 IF NOT EXISTS*/ `imedidata_iir_development` /*!40100 DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci */;


USE `imedidata_iir_development`;


yup thats it
lets change those
made changes to sql dump
mysql -u root imedidata_development < config/imedidata-iir-dev-db.sql


cool - fixed


ok whats next


should put .gitignore in ve/app/imed!


need to make new branch


.gitignore


# Changes not staged for commit:
#        modified:   public/images/medidata_buttons/b_cancel.gif
#        modified:   public/images/medidata_buttons/bg_neutral_mini_a.png
#        modified:   public/images/medidata_buttons/bg_neutral_mini_span.png
#        modified:   public/stylesheets/medidata_buttons.css


how the hell did these get modified????
i certainly didnt do anything here?


actually theyre not modified they have been somehow added
i think they need to be gitignored


balance v/a/im .gitignore
public/stylesheets/medidata_buttons.css
public/stylesheets/imedidata.css
.bundle
public/logout/
public/login/


interesting how .bundle is in there - thats for ben clearly


funny that public/images/* isnt in there - perhaps new


ok kjust ignored the changes
i think they may come from vendor/plugins/medidata_buttons?
who knows


whats my 1st step?
so a request comes in to controller says show me this study
controller goes to model
model goes to imedidata
model does the mauth siging stuff


from ben email
http://api.rubyonrails.org/classes/ActiveResource/Base.html


active resource for putting restful in a model!


class Person < ActiveResource::Base
  self.site = "http://api.people.com:3000"
end


seems to use xml by default
another example shows json though


i think there may be a serious problem
and that is getting it to work with mauth
bears more investigation - esp into into its auth stuff
may need monky patch or subclass or write our own


here is what the curl looks like
curl -v -H 'Authorization: MWS 993516ea-3dfb-11e1-a84d-70cd60fffe66:lyfN0lxXqFsXjhhclEj158jFG8j+4jtW/DoGfT3j+blax4fLMRahzqVIBQTKjTjl2gUsRozPQGQKr+/fPOF72lXln4xZUXv5zYO/vxWpeQN4iVEgSEvDJqGVLgW8S1LtU1TXWlK18AzQfEdiUnEkE3eHd6P65DzFdC+ngH/RLHR99jzVwXx/A1Hhokd46nGimFAGaYKvD0sPY2rRfVZJz1YmfbWW28Hz+1WWSM/5JzYVhorIta1GsvfRjuWTGugksQlU00UdVyg3gkKf+h96VM/HEAN2qMZQaectNd30h+frABrQBPblhLd063omwZHZ7DcUhpptfZOZJsjJ+8W0hQ==' -H 'x-mws-time: 1326992698' http://localhost:3000/api/v2/study_groups.json


curl 
-v 
-H 'Authorization: MWS 993516ea-3dfb-11e1-a84d-70cd60fffe66:lyfN0lxXqFsXjhhclEj158jFG8j+4jtW/DoGfT3j+blax4fLMRahzqVIBQTKjTjl2gUsRozPQGQKr+/fPOF72lXln4xZUXv5zYO/vxWpeQN4iVEgSEvDJqGVLgW8S1LtU1TXWlK18AzQfEdiUnEkE3eHd6P65DzFdC+ngH/RLHR99jzVwXx/A1Hhokd46nGimFAGaYKvD0sPY2rRfVZJz1YmfbWW28Hz+1WWSM/5JzYVhorIta1GsvfRjuWTGugksQlU00UdVyg3gkKf+h96VM/HEAN2qMZQaectNd30h+frABrQBPblhLd063omwZHZ7DcUhpptfZOZJsjJ+8W0hQ==' 
-H 'x-mws-time: 1326992698' 
http://localhost:3000/api/v2/study_groups.json






curl man page
-H, --header <header>


(HTTP) Extra header to use when getting a web page. You may specify any number of extra headers. Note that if you should add a custom header that has the same name as one of the internal ones curl would use, your externally set header will be used instead of the internal one. This allows you to make even trickier stuff than curl would normally do. You should not replace internally set headers without knowing perfectly well what you're doing. Remove an internal header by giving a replacement without content on the right side of the colon, as in: -H "Host:". If you send the custom header with no-value then its header must be terminated with a semicolon, such as -H "X-Custom-Header;" to send "X-Custom-Header:".


curl will make sure that each header you add/replace is sent with the proper end-of-line marker, you should thus not add that as a part of the header content: do not add newlines or carriage returns, they will only mess things up for you.


See also the -A, --user-agent and -e, --referer options.


This option can be used multiple times to add/replace/remove multiple headers.


-v verbose of course


so basically we need to just be able to add 2 headers - Authorization and x-mws-time


dont think this will work for mauth - this is ssl specific
class Person < ActiveResource::Base
  self.site = "https://secure.api.people.com/"
  self.ssl_options = {:cert         => OpenSSL::X509::Certificate.new(File.open(pem_file))
                      :key          => OpenSSL::PKey::RSA.new(File.open(pem_file)),
                      :ca_path      => "/path/to/OpenSSL/formatted/CA_Certs",
                      :verify_mode  => OpenSSL::SSL::VERIFY_PEER}
end


theres a headers method!
headers()
Source: hide | on GitHub


# File activeresource/lib/active_resource/base.rb, line 563
def headers
  @headers ||= {}
end
extremeley undocumented of course!
      def headers
        @headers ||= {}
      end
oddly @headers is nowhere else in file??
but theres no headers= ??? just a getter?
||= default to empty hash


require 'uri'
require 'active_support/core_ext/uri'


theres a bunch of places in code where headers is called 
but nowhere where its set ???


http://corelib.rubyonrails.org/classes/URI.html


wrong - headers is part of request NOT uri - uri is part of request


http://opensoul.org/blog/archives/2010/02/16/active-resource-in-practice/


PivotalTracker::Resource.headers['X-TrackerToken'] = "mytoken"
ah!
its a hash
so we just say 
obj.headers['x-mws-time'] = "239487"
obj.headers['Authorization'] = 'osidfoisj'
that should do it


http://apidock.com/rails/ActiveResource/Base


 def headers
        @headers ||= {}
      end
so one is suppose to be able to look at the above code and realize aha set this through 
a hash - now that i know i know but geez how bout a doc on this


http://semprebon.blogspot.com/2009/06/seting-custom-headers-in-activeresource.html
thats about adding header to connection default header - i dont think thats what we are doing


http://ryandaigle.com/articles/2007/5/7/what-s-new-in-edge-rails-activeresource-finder-update
class Post < ActiveResource::Base
  headers['X-MyHeader'] = 'ryan'
end


ok once again poor documentation! but its all doable! no workaround needed thank goodness


so lets code up the model


does active resource come with rails?
probably
prob need to do require - well prob not actually
dont have to for active record - though it may be somewhere else - we'll see


so whats my api?
should i write a test?


http://localhost:3000/api/v2/study_groups.json


whats the url for studies?
imedidata:
api_v2_study GET /api/v2/studies/:id(.:format) {:controller=>"api/v2/studies", :action=>"show"}


api_v2_studies GET /api/v2/studies(.:format) {:controller=>"api/v2/studies", :action=>"index"}


whats the diff between show & index?


oid is 12345 for my study
 NoMethodError (You have a nil object when you didn't expect it!
12:04:54 imedidata.1     | The error occurred while evaluating nil.unpack):
12:04:54 imedidata.1     |   /Users/magibson/.rvm/rubies/ruby-1.8.7-p249/lib/ruby/1.8/base64.rb:59:in `decode64'
12:04:54 imedidata.1     |   lib/api_authentication_v2.rb:41:in `request_token_auth'
12:04:54 imedidata.1     |   lib/api_authentication_v2.rb:13:in `api_authenticate_v2'
12:04:54 imedidata.1     |   /Users/magibson/.rvm/gems/ruby-1.8.7-p249@imedidata/gems/newrelic_rpm-3.3.1/lib/new_relic/agent/instrumentation/controller_instrumentation.rb:257:in `perform_action'
12:04:54 imedidata.1     |


of course! im trying to query without request token
have to setup jazzhands
or actually try out curl with mauth
to try out curl need to set up mauth key
in sandbox for public key with app id
and well actually just the curl would need the private key
in fact we could use the old pair
oh but its a new app_id
we need to install new appid with public key into mauth sandbox
i think thats where we are at actually


mikes secret writeup - not on knowledge base
Adding App's public key and uuid to MAuth for testing
1) Go to http://medistrano.imedidata.net/projects/52/stages/136, and SSH into sandbox server
2) cd /mnt/app/current
3) RAILS_ENV=production bundle exec rails console
Steps 4-5 are to be executed in rails console
4) SecurityToken.find_by_app_uuid!("70f3841a-4868-11e1-9826-a4b197fffe70").destroy!
   // This removes any existing SecurityToken with your app
   // If S3 Storage error is display, means no such SecurityToken exists, this is an ignorable error
5) SecurityToken.create!(:app_name => "enter_app_name", :app_uuid => "enter_app_uuid", :public_key_str => "enter public key, as single line  with \n")
6) Before you exit make sure a valid SecurityToken entry has been created for your app.


Generating curl commands for testing
8) Retrieve curlgen.rb, in rack-mauth git repo, under test/curlgen.rb
9) curlgen script takes in a yaml file that stores specific api request parameters
10) Create a new yaml file, ensure it has the following format:
      :private_key_str: | 
               <multi line private key for the app that is making the call>
      :app_uuid: <uuid of app making the api call> 
      :host: <host, include http://>
      :url: <api url path>
      :verb: <http method used, GET, POST, etc>
      :post_data: <if using POST, enter post data here>
9) Need to generate a new curl command every 5 minutes or so, otherwise the MAuth tokens will expire
10) Ensure your using the latest mauth-signer




had to change pwd to 2Lg - expired


 SecurityToken.create!(:app_name => "enter_app_name", :app_uuid => "enter_app_uuid", :public_key_str => "enter public key, as single line  with \n")


 SecurityToken.create!(:app_name => "IIR test", :app_uuid => "d38e7edc-5113-11e1-95fe-70cd60fffe66", :public_key_str => "enter public key, as single line  with \n")


Api Id: d38e7edc-5113-11e1-95fe-70cd60fffe66
will need this for mauth config of iir!


i dont know where i got this public key dont see it in .ssh
i do see priv key
"-----BEGIN RSA PUBLIC KEY-----\nMIIBCgKCAQEA34ajaK5gm/UM4PxHyrIF+gcBr6cacLqWdSzfGOz6KdBLCZXzHYWX\n/9sEL7XgWuXhhXsJr8bgNibUToghgK+cE9QVUnipDSogc2Ds2FJE5rlJBFtfPLrw\n11OT20teCTeFpaXl2pE/C+ItlW9Ip2QYNF5v9eHHxMdBzJC7yckiCfLaY58/wT+K\naxiFZsaw15LMGHeiqMeGt1kRGqfREIm+drOiMjD5P49uOMn2Ye5RbdF1JkhVv1wo\ngqABWpAV1d8akpBh3bytoyH4Wgwi4lLeAVSc0glnh6+ED3wq0+7p1X/OufTErEJN\nDyRRg9hiTLnXMKWpX24yX5TI5cucDp6DPQIDAQAB\n-----END RSA PUBLIC KEY-----\n"


thats matts public key i think or geofreys
my pub key is
AAAAB3NzaC1yc2EAAAABIwAAAQEAzFFKXyGP2tmS9GAw0yjuDcjYn35KvNsmMc6L8JqLhXIhEF7txP/s9Z4/gq5ESPD1JdcRCUMkoXF9p/b/L25V/+08szyYdWUz4Wwh/wdu41xcT1lUSOmz5ApPO9Z5BTTZprW/BZaI1YYlCugwjjaNrN0vwXghI5Ak6zF3GuSgqnLQYBC3HgAGMsWYy9XT07uLpgDbOOSsz9iDN3e/QVSyPAIrZr7F/x7Ej/ftbiMsn0Mz87fvPEbhoScH422v9nBUH90IW++nKuIYuc5giaLLTO2iyJAIHd5jQFtVgNp52286MV31dcBvzPH1YEnmVRj6M4JJoQUi9g6/bO3CQauYyw==




it seems like i mangled keys in rack-mauth-notes
but somehow it worked
looks like i used matts public key not mine - very confusing - then again i was very 
confused at the time


oh wait i made a whole new pair 
cos i didnt want it to get mixed up with old or something


so i think somewhwere in the process i made a new key pair though i dont seem to have 
documented that
and whats confusing is the priv keys have sam MIIE prefix
i think i will just reuse my working pair for now i think it will be fine
-----BEGIN RSA PRIVATE KEY-----
MIIEoQIBAAKCAQEAzFFKXyGP2tmS9GAw0yjuDcjYn35KvNsmMc6L8JqLhXIhEF7t
xP/s9Z4/gq5ESPD1JdcRCUMkoXF9p/b/L25V/+08szyYdWUz4Wwh/wdu41xcT1lU
SOmz5ApPO9Z5BTTZprW/BZaI1YYlCugwjjaNrN0vwXghI5Ak6zF3GuSgqnLQYBC3
HgAGMsWYy9XT07uLpgDbOOSsz9iDN3e/QVSyPAIrZr7F/x7Ej/ftbiMsn0Mz87fv
PEbhoScH422v9nBUH90IW++nKuIYuc5giaLLTO2iyJAIHd5jQFtVgNp52286MV31
dcBvzPH1YEnmVRj6M4JJoQUi9g6/bO3CQauYywIBIwKCAQEAhkQMTSSu/Yeptoha
mWQKJlDI3damJFV/f9DfnhxqUGDxKAPeE74fX5Pgl7RYwjfxjeUZ0uL60H3HmkM5
+pj2r36kO0UTutwax1Wv8Lu95d2bvx1x5sV2NsTyPUPL3tmWV5wBL47O8rc86ekJ
9w3oEoK4+3rT8sxwCEUTwTcnwHYna+0KZ4XIhaHHYbLbZO/M7tm0TCxta+yoslZ5
iB8lg1PtqOj9r8qwaXYzrUP2BvcltSjhmKIhNNAfSvem2+InXTyOWu14QvbUNQae
qwj577t5+5BDH6OuQLHYfC74fEd+d5UsXMwZUKZJS3r/uynxPUwJDowH+EYDHGhF
3sLDKwKBgQD+laNfF114az967EBIcjW4y8C39pHdK7al1J73r1LXiImwYsZZA0PI
tpqmD2SsUMsoHn1c+D7S6KFYvGcnTTFR7oo8z8/1yPvI45DBRqyp76fjwMQmWf0g
wDntHcvB69OIomUVQuA0YpQxe47wOY/pRPS3dtUju4YZMlVR9P7oWwKBgQDNdBrk
BO07PvQa/P/ONzpNFb0ySNeNTc/+EK47JwocDQPk1mlaPkJes1Bc58Zi9fTSc6NR
Ol9AXQYxnq8QT4KwB52Z4F1ISekjLIF2KG4JMz63fdoXcld8Ha6ZY0zOgGaM70Jl
CdYrJ0p1v8gjCdnvvcvzr+B4qncnD13vtuh8UQKBgB0YanFEf7X9oNrZK+sFvP8t
OpiudxH2XgRS0FbSNVp2ARt5ALm3OvJeAwup/OB+QxqHJEUjr2iPnWk6GmrkQCae
6zomYOjjxQEEEIseBRq8TbOhAHlpXsHqFT+rokIMUrCHloYWRYJUaLUysUAGlBqo
y4KufsJBUSdzd3cUr2sDAoGAEZw80bdHiLxAzxz/+7uXSG+T370Zykh/is460d7G
Wi0AVXF2vpefSfIc1MNoxqdeIKrTe/2wZJpCXAZJhQ4hJQf3kNi3idpzEaS6o7pS
kxMFYC9b1h++Wxh8rg/TYihDTeifSn0vnUyCuaK5YhbJiZPs6QByU3xTWx6TBesb
PdsCgYB+y7H5MQSw4fFzsoxdDALRpBjbddirKwXxOLiwhV3z1rk0pLoPnrsQddOL
32wtUFuYNS+wSu/480r9u0JLsriKKcf241z2XCdHJ2slpHDD9imL5wDxmtKm4Th9
xO9tGPVwzbM5YEKnbtalWcGBv3AjOZshBl3Zut8lIBSftMvTVA==
-----END RSA PRIVATE KEY-----


ah - heres the call - i did it in ruby:
ruby-1.8.7-p249 :002 > @private_key = OpenSSL::PKey::RSA.generate( 2048 )


 @private_key_str = @private_key.to_s


 @public_key_str = @private_key.public_key.to_s


in rack mauth ~/r
irb
~/r (master) $ irb
Using /Users/magibson/.rvm/gems/ruby-1.8.7-p249 with gemset rackmauth
ruby-1.8.7-p249 :001 > require 'openssl'
 => true 
Using /Users/magibson/.rvm/gems/ruby-1.8.7-p249 with gemset rackmauth
ruby-1.8.7-p249 :002 > @private_key = OpenSSL::PKey::RSA.generate( 2048 )




lets just use the key pair made from that - why not
with old app id
SecurityToken.create!(:app_name => "mark-jazzhand-imed-local-client", :app_uuid => "993516ea-3dfb-11e1-a84d-70cd60fffe66", :public_key_str => "-----BEGIN RSA PUBLIC KEY-----\nMIIBCgKCAQEA34ajaK5gm/UM4PxHyrIF+gcBr6cacLqWdSzfGOz6KdBLCZXzHYWX\n/9sEL7XgWuXhhXsJr8bgNibUToghgK+cE9QVUnipDSogc2Ds2FJE5rlJBFtfPLrw\n11OT20teCTeFpaXl2pE/C+ItlW9Ip2QYNF5v9eHHxMdBzJC7yckiCfLaY58/wT+K\naxiFZsaw15LMGHeiqMeGt1kRGqfREIm+drOiMjD5P49uOMn2Ye5RbdF1JkhVv1wo\ngqABWpAV1d8akpBh3bytoyH4Wgwi4lLeAVSc0glnh6+ED3wq0+7p1X/OufTErEJN\nDyRRg9hiTLnXMKWpX24yX5TI5cucDp6DPQIDAQAB\n-----END RSA PUBLIC KEY-----\n")


same key but new app id:


SecurityToken.create!(:app_name => "IIR-dev", :app_uuid => "d38e7edc-5113-11e1-95fe-70cd60fffe66", :public_key_str => "-----BEGIN RSA PUBLIC KEY-----\nMIIBCgKCAQEA34ajaK5gm/UM4PxHyrIF+gcBr6cacLqWdSzfGOz6KdBLCZXzHYWX\n/9sEL7XgWuXhhXsJr8bgNibUToghgK+cE9QVUnipDSogc2Ds2FJE5rlJBFtfPLrw\n11OT20teCTeFpaXl2pE/C+ItlW9Ip2QYNF5v9eHHxMdBzJC7yckiCfLaY58/wT+K\naxiFZsaw15LMGHeiqMeGt1kRGqfREIm+drOiMjD5P49uOMn2Ye5RbdF1JkhVv1wo\ngqABWpAV1d8akpBh3bytoyH4Wgwi4lLeAVSc0glnh6+ED3wq0+7p1X/OufTErEJN\nDyRRg9hiTLnXMKWpX24yX5TI5cucDp6DPQIDAQAB\n-----END RSA PUBLIC KEY-----\n")


=> #<SecurityToken:0xb65b31f8 @errors=#<OrderedHash {}>, @public_key_str="-----BEGIN RSA PUBLIC KEY-----\nMIIBCgKCAQEA34ajaK5gm/UM4PxHyrIF+gcBr6cacLqWdSzfGOz6KdBLCZXzHYWX\n/9sEL7XgWuXhhXsJr8bgNibUToghgK+cE9QVUnipDSogc2Ds2FJE5rlJBFtfPLrw\n11OT20teCTeFpaXl2pE/C+ItlW9Ip2QYNF5v9eHHxMdBzJC7yckiCfLaY58/wT+K\naxiFZsaw15LMGHeiqMeGt1kRGqfREIm+drOiMjD5P49uOMn2Ye5RbdF1JkhVv1wo\ngqABWpAV1d8akpBh3bytoyH4Wgwi4lLeAVSc0glnh6+ED3wq0+7p1X/OufTErEJN\nDyRRg9hiTLnXMKWpX24yX5TI5cucDp6DPQIDAQAB\n-----END RSA PUBLIC KEY-----\n", @created_at=Thu Feb 09 18:41:38 UTC 2012, @app_uuid="d38e7edc-5113-11e1-95fe-70cd60fffe66", @validation_context=nil, @app_name="IIR-dev", @new_record=true>


SecurityToken.find_by_app_uuid!("d38e7edc-5113-11e1-95fe-70cd60fffe66")
yup its there


now lets test with curl before we do it with rails-iir


lets get new curlgen script from rack mauth


the version of rack-mauth to use is http-client


need to make curl config file
put curlgen into iir root for now - maybe it belongs in iir test?
Create a new yaml file, ensure it has the following format:
      :private_key_str: | 
               <multi line private key for the app that is making the call>
      :app_uuid: <uuid of app making the api call> 
      :host: <host, include http://>
      :url: <api url path>
      :verb: <http method used, GET, POST, etc>
      :post_data: <if using POST, enter post data here>
   Example file:
     :private_key_str: | 
                    -----BEGIN RSA PRIVATE KEY-----
                    MIIEpAIBAAKCAQEAsZasSJmci3icNVbpz6Si5OmZBSAVVEJx02gm9OQvCr1XhIqA
                    .........................................................................................................                 
                    8bvTK2ddzX3k8br6SfKBLPfD90Giy5xvCDheF/+D8Ce0AVaYeXRgyw==
                    -----END RSA PRIVATE KEY-----
    :app_uuid: 70f3841a-4868-11e1-9826-a4b197fffe70 
    :host: http://localhost:3000 
    :url: /api/v2/studies/b56680fa-0c97-11e1-9af1-1231391d1426/users.json
    :verb: GET
    :post_data: 


     :private_key_str: | 
          -----BEGIN RSA PRIVATE KEY-----
               MIIEowIBAAKCAQEA34ajaK5gm/UM4PxHyrIF+gcBr6cacLqWdSzfGOz6KdBLCZXz
               HYWX/9sEL7XgWuXhhXsJr8bgNibUToghgK+cE9QVUnipDSogc2Ds2FJE5rlJBFtf
               PLrw11OT20teCTeFpaXl2pE/C+ItlW9Ip2QYNF5v9eHHxMdBzJC7yckiCfLaY58/
               wT+KaxiFZsaw15LMGHeiqMeGt1kRGqfREIm+drOiMjD5P49uOMn2Ye5RbdF1JkhV
               v1wogqABWpAV1d8akpBh3bytoyH4Wgwi4lLeAVSc0glnh6+ED3wq0+7p1X/OufTE
               rEJNDyRRg9hiTLnXMKWpX24yX5TI5cucDp6DPQIDAQABAoIBAB+C5JCCXL4/upQR
               HLHXjP4ldLhlj1WrCED2lXD3H4E7iwiL6h0UU0xPfPSY6EsIM1XU9ZWhLMSVjsKP
               cGGq4A7vjB33QqXHdZGubVVFq872+fMySmfOVtuUPbjhlB0qhZ3HmHLKnR+4wAJc
               ENsAQmVHlvML5FS6Xm1PThnxT+ok3ezJHq7wEdHeWxgKffUrbv6JHK1p4wHn9s3B
               DU/Ljnfi04Q6q7yr5COzarpBiego7NqHqcMmQnZAfzUdYW9sNu9skjYpm0u5JFJv
               5NAD9pLaA2lOCeJo9tkxQyzX+7GNvC0X7fHrrREgHJQsoMOjN5RacOc/xHdy7aWK
               /K0HbmUCgYEA9DXh2obI8I0s2pYRXO5pMNPkpm3ouhjIJGh0cBUO8gkyqwRy3JOl
               NG/mewJRPt3gynBe+T8B0ZEEzKItP3LdMoKQyMiUa/4mKq6Q33ZxabgilrnfG7wR
               QlCWUOmrEf1r6KIKqPtIQVpxR5ms85P2j6OJHWSFm5MojHQ1iawSjfMCgYEA6lEf
               XDGadnT7rxJHRObvW8KzbRmv/N2o0UW5tVv+EyC+IpGghSa62WXQmbk3RDl3VJRe
               q+tkBUzL56xfOFeZ5/YwCvHcizOkqJRk7F0I+mabD1cbVAMtnTUgo4Um32vdGT+Q
               Br9sZkp1pQUKkmAYgVXqVOdpKjrp8o83hh+Zhg8CgYEAlFgOw/HQKd93+afjEDJ6
               j4CHilmFX1YibYtN/6+rDndr4dqn8zl0xy+aL+quc6PQIuizqHAPqL+QzMVO+xXJ
               LB+H14+QKTGO+apksnl+VxvVVv29e1l4mnHdfXUTx6/LVtrn4tIRiDFqUnYVSzj8
               MzDB36rqRiDUJs2IoAJ4muUCgYAt80KnHcMgv8griPYY+QCvifsNxh/RAtb8UyQc
               ALJOpfkjZlOISRQTVfgWbU/9PRe9qmr2Y+71ax4BjLgPoH46EvlQ7CVH1xTPSmqQ
               P55nHIAD/h0J2KW1UpnX92CsJ8bwEJr598gWNzvi5J4yHk4v7t1JUSg6c9s1Cgjl
               cIT22QKBgHayTw+K3CIf8f7j8Bso6JuKhJV4Hz7D5U0HFiKqSl5Hxl+V4LoaYtOR
               pdqtQCNnVLrDcXaLNOknjDEvi1qtA5acbyiRS9dyE/Plv4p96rsyQY6PviU6gbKI
               cmWAExNsM5QZHHIToW855bFXm+rCZvCn3oYUA1tyvDQqZbZUX8pQ
               -----END RSA PRIVATE KEY-----
    :app_uuid: d38e7edc-5113-11e1-95fe-70cd60fffe66
    :host: http://localhost:3001
    :url: /api/v2/studies/index/d2216ad8-5199-11e1-95fe-70cd60fffe66
    :verb: GET
    :post_data: 


uuid of my study - got with mysql query of studies
d2216ad8-5199-11e1-95fe-70cd60fffe66


foreman start
cd ~/i
curlgen.rb curlgen-data.yml


./curlgen.rb curlgen-data.yml
Invalid gemspec in [/Users/magibson/.rvm/gems/ruby-1.8.7-p249@imedidata/specifications/chronic-0.6.6.gemspec]: invalid date format in specification: "2011-11-23 00:00:00.000000000Z"
Invalid gemspec in [/Users/magibson/.rvm/gems/ruby-1.8.7-p249@imedidata/specifications/foreman-0.36.1.gemspec]: invalid date format in specification: "2012-01-18 00:00:00.000000000Z"
Invalid gemspec in [/Users/magibson/.rvm/gems/ruby-1.8.7-p249@imedidata/specifications/jquery-rails-1.0.19.gemspec]: invalid date format in specification: "2011-11-26 00:00:00.000000000Z"
Invalid gemspec in [/Users/magibson/.rvm/gems/ruby-1.8.7-p249@imedidata/specifications/term-ansicolor-1.0.7.gemspec]: invalid date format in specification: "2011-10-13 00:00:00.000000000Z"
Invalid gemspec in [/Users/magibson/.rvm/gems/ruby-1.8.7-p249@imedidata/specifications/tilt-1.3.3.gemspec]: invalid date format in specification: "2011-08-25 00:00:00.000000000Z"
git@github.com:mdsol/mauth_signer.git (at >=v1.0.3) is not checked out. Please run `bundle install`


woops wrong rvm
iir


http://guides.rubyonrails.org/debugging_rails_applications.html
If you are using Ruby 1.9, you can install a compatible version of ruby-debug by running 
sudo gem install ruby-debug19


this is whats needed for debugger! just check gemfile!
require 'ruby-debug'
# To use debugger
gem 'ruby-debug19', :require => 'ruby-debug'


oh geez the file format was wrong in the doc


:app_uuid: d38e7edc-5113-11e1-95fe-70cd60fffe66
:base_url: http://localhost:3001
:path: /api/v2/studies/index/d2216ad8-5199-11e1-95fe-70cd60fffe66
:verb: GET
:post_data: 




curl -v -H 'x-mws-authentication: MWS d38e7edc-5113-11e1-95fe-70cd60fffe66:VFy00Mg2qxhGZqjRicDtCXk8QP12gTDM7lX0RFxtEngrQKJYsYCHr7oTqU//SfR0TcPUYLFj2cKEIRjSs1BoFrIOdBbD1C96UCqMiT6VgJvf8AqcPtbMgCnbHX2DbJRDpPo2IwlUrhl79JK79TIrT3Y/R7B9O/p2rLWHSPvxV/kq2ir3xiTiMkKGfjGvAGjtqqmlPtjc4MPUjYCTqE26G7tstMad8PLbwqdjPjprN60YXa/b8Q6Ea/4qLwnxcmQeSxWyA1D6NyqlMRfeuaI3sbGOA09hz7a7Wi+bfoq06AfsFTtx/Q/fA4xWubV1HaALsQme7UxqQ2ogu2nkRRAEJg==' -H 'x-mws-time: 1328818955' http://localhost:3001/api/v2/studies/index/d2216ad8-5199-11e1-95fe-70cd60fffe66


 HTTP/1.1 401 Unauthorized
dam!


no output on foreman


need to put debugger in imedidata


rack mauth is doing local authentication
and verifier is nil
       # Rack-mauth does its own authentication
   135        def authenticate_request(digest, params)
   136          verifier = verifier_for_app(params[:app_uuid])
=> 137          !verifier.nil? && verifier.verify_request(digest, params)
   138        end
   139 


rack-mauth: Cannot find public key for app with uuid d38e7edc-5113-11e1-95fe-70cd60fffe66 locally or in MAuth


/Users/magibson/.rvm/gems/ruby-1.8.7-p249@imedidata/bundler/gems/rack-mauth-d8ced6e7a9ea/lib/rack/mauth.rb


imedidata pubvlic key not yet in mauth for doing caching


 Michael:  -----BEGIN RSA PUBLIC KEY-----\nMIIBCgKCAQEAtJQ15Qxju7lrXyXL8eRHQNa4KvG1Lief+reSwhVTAUTWqk1LRcZG\nh+fpu5IYG2LnL+nRiwBOirqTgsTt4EblTp7k8uzdawPg4Zfk7Y20OZ/F+LrQ/0JF\n2fGtdZvqyH4IY6GHtPvBEBZ5ERM5pJMMgk7WGp6ocNhpwwaE/ATAOTrnNAFtX2Mw\nQ5e0IihZYywM0iDuddBVI5pqtgE6WvJQ2KFk//9VZqYax2kxDOT/QSIJDQhtuP9R\nuc4Km+T8X27GVL6Vm1QX65wlOiVGGL67/FLuluDkBqIeUaNPYstFxBP8MEoHqhYf\n7D5vHV0JItLmnGTPn0p7fqx9rNtcvR2ERQIDAQAB\n-----END RSA PUBLIC KEY-----\n
63566d60-4c62-11e1-b86c-0800200c9a66




SecurityToken.create!(:app_name => "iMedidata-dev", :app_uuid => "63566d60-4c62-11e1-b86c-0800200c9a66", :public_key_str => "-----BEGIN RSA PUBLIC KEY-----\nMIIBCgKCAQEAtJQ15Qxju7lrXyXL8eRHQNa4KvG1Lief+reSwhVTAUTWqk1LRcZG\nh+fpu5IYG2LnL+nRiwBOirqTgsTt4EblTp7k8uzdawPg4Zfk7Y20OZ/F+LrQ/0JF\n2fGtdZvqyH4IY6GHtPvBEBZ5ERM5pJMMgk7WGp6ocNhpwwaE/ATAOTrnNAFtX2Mw\nQ5e0IihZYywM0iDuddBVI5pqtgE6WvJQ2KFk//9VZqYax2kxDOT/QSIJDQhtuP9R\nuc4Km+T8X27GVL6Vm1QX65wlOiVGGL67/FLuluDkBqIeUaNPYstFxBP8MEoHqhYf\n7D5vHV0JItLmnGTPn0p7fqx9rNtcvR2ERQIDAQAB\n-----END RSA PUBLIC KEY-----\n")


SecurityToken.find_by_app_uuid!("63566d60-4c62-11e1-b86c-0800200c9a66")=> #<SecurityToken:0xb6553b54 @public_key_str="-----BEGIN RSA PUBLIC KEY-----\nMIIBCgKCAQEAtJQ15Qxju7lrXyXL8eRHQNa4KvG1Lief+reSwhVTAUTWqk1LRcZG\nh+fpu5IYG2LnL+nRiwBOirqTgsTt4EblTp7k8uzdawPg4Zfk7Y20OZ/F+LrQ/0JF\n2fGtdZvqyH4IY6GHtPvBEBZ5ERM5pJMMgk7WGp6ocNhpwwaE/ATAOTrnNAFtX2Mw\nQ5e0IihZYywM0iDuddBVI5pqtgE6WvJQ2KFk//9VZqYax2kxDOT/QSIJDQhtuP9R\nuc4Km+T8X27GVL6Vm1QX65wlOiVGGL67/FLuluDkBqIeUaNPYstFxBP8MEoHqhYf\n7D5vHV0JItLmnGTPn0p7fqx9rNtcvR2ERQIDAQAB\n-----END RSA PUBLIC KEY-----\n", @created_at="2012-02-09T21:20:20Z", @app_uuid="63566d60-4c62-11e1-b86c-0800200c9a66", @app_name="iMedidata-dev">


cool its in!




curl-study-grp.yml
:app_uuid: d38e7edc-5113-11e1-95fe-70cd60fffe66
:base_url: http://localhost:3001
:path: /api/v2/study_groups.json
:verb: GET
:post_data: 


ruby curlgen.rb curl-study-grp.yml


curl -v -H 'x-mws-authentication: MWS d38e7edc-5113-11e1-95fe-70cd60fffe66:ZAI24zNXRaXQePcunueboAXdMMZ/z/JVqXhY/unwJJt0LLRQ/WIwTDP8+joJQO1R88670QrHv+pqWlte+2XkfYiN+5R3F1l48uZFHKJ902WmxsFvElUvfbEI7mSzzwYOdj6MytXbsjFkfNdLikH139xjUsIiWD7L04aFqelCeXtCuyhvG2rqzVqU/KtwyrpDcaBmopb2ix7ipOTxfqA3s54W7mjNBWa2Fg74isKPJYwVmpR2aeZHAtAoYA0LyEXPw/muYF/LITY+s08Eczcw5geKZ5iSV2w99r3jGtyw8BNQQq7YM5QqifQAGzD/6jUOiwjMWULh0yv3XbUWoenT9Q==' -H 'x-mws-time: 1328823512' http://localhost:3001/api/v2/study_groups.json


{"study_groups":[{"href":"http://localhost:3001/api/v2/study_groups/35aa8dec-5199-11e1-95fe-70cd60fffe66","uuid":"35aa8dec-5199-11e1-95fe-70cd60fffe66","name":"aaa for iir"}]}


woohoo it worked!


this path is no good
 /api/v2/studies/index/d2216ad8-5199-11e1-95fe-70cd60fffe66


so how do i get a study - i think thats what im trying to do
lets look at balance?
maybe just do show


ruby curlgen.rb show-study-curl-data.yml
nope
No route matches "/api/v2/studies/show/d2216ad8-5199-11e1-95fe-70cd60fffe66"


 User#show would help us make the header scenario pass
with the user name
if you wanted to attack that first
 me:  /api/v2/users/:id/studies
 Benjamin:  my thought is on login that we would query the User name
and store it in a session variable
 me:  oh sure i could go for taht 1st
 Benjamin:  to use in the header
yeah that would be good
a little more digestable
 Sent at 4:50 PM on Thursday
 me:  right i guess it makes more sense to get the user before we get the studies for the user
 Benjamin:  that to 
 Sent at 4:52 PM on Thursday
 me:  right so on login there must be some returned data that im currently not grabbing
ill see what balance does for this
 Sent at 4:54 PM on Thursday
 Benjamin:  we use the client plugin
for IIR I hope it's something simple like User.full_name
session[:full_name] ||= User.find_by_uuid(cas_uuid).full_name
assuming our user model is connected to iMedidata
via active resource
 Sent at 4:56 PM on Thursday
 me:  right cool - and i just need to extract a cas_uuid from cas
 Benjamin:  cas_attrs = session[:cas_extra_attributes]
cas_attrs[:user_id]


 and I would store the full name in a session variable so we only hit User#show once


switch over to getting user


still go to study controller
but make call to User model
user grab cas uuid and make call ot imedidata for user


fri 2/10


ok where we at
studies controller is going to call User acvtive resouce model
which is going to call imedidata with user id from cas and mauth headers


need to get uuid from cas attributes for user


from mysql
mysql-iir
select * from users
user uuid for harry caul
307602f2-469f-11e1-ad6f-00261824db2f


pp cas_attrs
{"user_id"=>1, "user_uuid"=>"307602f2-469f-11e1-ad6f-00261824db2f"}


yes!
 pp session
{"session_id"=>"3c99ff7fb05f9fc2df29fba47d241087",
 "cas_sent_to_gateway"=>false,
 "cas_validation_retry_count"=>0,
 "previous_redirect_to_cas"=>2012-02-08 12:28:38 -0500,
 "cas_user"=>"superadmin",
 "cas_extra_attributes"=>
  {"user_id"=>1, "user_uuid"=>"307602f2-469f-11e1-ad6f-00261824db2f"},
 "casfilteruser"=>"superadmin",
 "cas_last_valid_ticket"=>
  #<CASClient::ServiceTicket:0x000001021a5ee8
   @renew=nil,
   @response=
    <cas:authenticationSuccess>
  <cas:user xmlns:cas='http://www.yale.edu/tp/cas'>superadmin</cas:user>
  <user_id xmlns:cas='http://www.yale.edu/tp/cas'>1</user_id>
  <user_uuid xmlns:cas='http://www.yale.edu/tp/cas'>307602f2-469f-11e1-ad6f-00261824db2f</user_uuid>
</cas:authenticationSuccess>,
   @service="http://localhost:3000/",
   @ticket="ST-1328722123rD82428D2C8BD7E2506">,
 "_csrf_token"=>"5XayOlr9HGiYUkn8LsAISxG7gdnQ/6ckfuztd7UOl/8="}


ok whats the url for users? api v2 that is
would be handy to have jazzhands to test - actually can always test with curl!


api_v2_user GET    /api/v2/users/:id(.:format)  {:controller=>"api/v2/users", :action=>"show"}


lets try curl 1st


307602f2-469f-11e1-ad6f-00261824db2f
:path: /api/v2/users/307602f2-469f-11e1-ad6f-00261824db2f


ruby curlgen.rb user-curl.yaml


curl -v -H 'x-mws-authentication: MWS d38e7edc-5113-11e1-95fe-70cd60fffe66:lzpzPPhgHZeNWtSq/8ebmJdDaPUu0bVErbYttpOpZPDGSopeX0TZD4WWssmD3h+hDUow5lZe4zF36YPnr6UJkHhSbY1f3A8D+YbN9KdXWTylUdj0RORFUja1kdAcsB5FN30PZ++LfPH8L5sSNZ8/MQK4yWoK8Lo27RKcy8yW3My0EF5scB87zHGABmtn7pCr7oh8crrTSP4cn97pFC+0vviKmdhhvGdfY80eEdmxbSBr1WhmveiMiFgol6MhdYvi01DAsnzVJs+W0yrbVTX+uXaxPFYW6co4wWlOdgcgM3yqECyJtySitbw3Tm/MfaUihGShGgCgzAqwL7v8H/HjeA==' -H 'x-mws-time: 1328887400' http://localhost:3001/api/v2/users/307602f2-469f-11e1-ad6f-00261824db2f


< HTTP/1.1 200 OK
< Connection: close
< Date: Fri, 10 Feb 2012 15:24:08 GMT
< request_token: okszHfNCdFg2OG7PFrK%2FDK3KKgk4wnKSxqwSuPd6QJNGCvC8mRbTpBivdyNS%0AdzNehcEw2bMs4C9dzlU7O9PnvkPmf%2FvHgtn5Fand0EsUhrFnP63JBAhceU2s%0AAuL4JXmf5LJyspcPuRI9fAkt2imUFe1Qiqbgubm%2FMSE9UdZbpQo%3D%0A
< ETag: "a2ea4f2892a0c2592f1cd94a04c27e3a"
< Content-Type: application/xml; charset=utf-8
< X-Runtime: 323
< Content-Length: 489
< Set-Cookie: _session_id=dc288de392493fb7c23da6d2e77f5639; path=/; HttpOnly
< Cache-Control: private, max-age=0, must-revalidate
< 
<user name="Harry Caul" city="" institution="" title="" country="" uuid="307602f2-469f-11e1-ad6f-00261824db2f" postal_code="" creator_uuid="a9cc880c-492d-11e1-842b-00261824db2f" activation_code="4cb10bf91b6aee3508b191fc662135bf04193718" pager="" address_line_1="" mobile="" last_name="Caul" address_line_2="" fax="" time_zone="Midway Island" locale="eng" address_line_3="" telephone="337-449-8988" login="superadmin" department="" email="harrycaul@mdsol.com" first_name="Harry" state=""/>


woohoo!


now big test of active resource


undefined method `find_by_uuid' for User:Class


well thats not shocking
maybe just find?
like this
http://api.rubyonrails.org/classes/ActiveResource/Base.html#method-c-headers
ryan = Person.find(1)


Failed.  Response code = 404.  Response message = Not Found.


Existing local CAS session detected for "superadmin". Previous ticket "ST-1328722123rD82428D2C8BD7E2506" will be re-used.
10:28:49 iir.1           | Completed 500 Internal Server Error in 387ms
10:28:49 iir.1           | 
10:28:49 iir.1           | ActiveResource::ResourceNotFound (Failed.  Response code = 404.  Response message = Not Found.):
10:28:49 iir.1           |   app/controllers/investigator/studies_controller.rb:11:in `get_user_info'




http://api.rubyonrails.org/files/activeresource/README_rdoc.html


ok i think we need to see wahts happening in imed/rackmauth/mauth to cause 500 error
that isnt happening with curl - curl works 
so active resource is prob not making the request i think it is


# for GET http://api.people.com:3000/people/1.xml
#
ryan = Person.find(1)
need to see what url it actually makes ??? how to get at that in active resource


oh wait - jesus - we havent put in the bloody mauth headers yet - of course this is a 500 or whatever
PivotalTracker::Resource.headers['X-TrackerToken'] = "mytoken"
ah!
its a hash
so we just say 
obj.headers['x-mws-time'] = "239487"
obj.headers['Authorization'] = 'osidfoisj'
or
http://ryandaigle.com/articles/2007/5/7/what-s-new-in-edge-rails-activeresource-finder-update
class Post < ActiveResource::Base
  headers['X-MyHeader'] = 'ryan'
end


  def find(user_uuid)
    headers['Authorization'] = 1
    headers['x-mws-time'] = 1234
    self.find(user_uuid)


l;ets go to curlgen


    headers = MAuth::Signer.new(:private_key => self.private_key_str).
                            signed_request_headers(:app_uuid => self.app_uuid,
                             :request_url => path, :post_data => post_data, :verb => verb)
 args = headers.map{|k,v| "-H '#{k}: #{v}'"} * ' '


so headers has key value pairs for headers


i think priv key has to be as one string with \n
"-----BEGIN RSA PRIVATE KEY-----\nMIIEowIBAAKCAQEA34ajaK5gm/UM4PxHyrIF+gcBr6cacLqWdSzfGOz6KdBLCZXz\nHYWX/9sEL7XgWuXhhXsJr8bgNibUToghgK+cE9QVUnipDSogc2Ds2FJE5rlJBFtf\nPLrw11OT20teCTeFpaXl2pE/C+ItlW9Ip2QYNF5v9eHHxMdBzJC7yckiCfLaY58/\nwT+KaxiFZsaw15LMGHeiqMeGt1kRGqfREIm+drOiMjD5P49uOMn2Ye5RbdF1JkhV\nv1wogqABWpAV1d8akpBh3bytoyH4Wgwi4lLeAVSc0glnh6+ED3wq0+7p1X/OufTE\nrEJNDyRRg9hiTLnXMKWpX24yX5TI5cucDp6DPQIDAQABAoIBAB+C5JCCXL4/upQR\nHLHXjP4ldLhlj1WrCED2lXD3H4E7iwiL6h0UU0xPfPSY6EsIM1XU9ZWhLMSVjsKP\ncGGq4A7vjB33QqXHdZGubVVFq872+fMySmfOVtuUPbjhlB0qhZ3HmHLKnR+4wAJc\nENsAQmVHlvML5FS6Xm1PThnxT+ok3ezJHq7wEdHeWxgKffUrbv6JHK1p4wHn9s3B\nDU/Ljnfi04Q6q7yr5COzarpBiego7NqHqcMmQnZAfzUdYW9sNu9skjYpm0u5JFJv\n5NAD9pLaA2lOCeJo9tkxQyzX+7GNvC0X7fHrrREgHJQsoMOjN5RacOc/xHdy7aWK\n/K0HbmUCgYEA9DXh2obI8I0s2pYRXO5pMNPkpm3ouhjIJGh0cBUO8gkyqwRy3JOl\nNG/mewJRPt3gynBe+T8B0ZEEzKItP3LdMoKQyMiUa/4mKq6Q33ZxabgilrnfG7wR\nQlCWUOmrEf1r6KIKqPtIQVpxR5ms85P2j6OJHWSFm5MojHQ1iawSjfMCgYEA6lEf\nXDGadnT7rxJHRObvW8KzbRmv/N2o0UW5tVv+EyC+IpGghSa62WXQmbk3RDl3VJRe\nq+tkBUzL56xfOFeZ5/YwCvHcizOkqJRk7F0I+mabD1cbVAMtnTUgo4Um32vdGT+Q\nBr9sZkp1pQUKkmAYgVXqVOdpKjrp8o83hh+Zhg8CgYEAlFgOw/HQKd93+afjEDJ6\nj4CHilmFX1YibYtN/6+rDndr4dqn8zl0xy+aL+quc6PQIuizqHAPqL+QzMVO+xXJ\nLB+H14+QKTGO+apksnl+VxvVVv29e1l4mnHdfXUTx6/LVtrn4tIRiDFqUnYVSzj8\nMzDB36rqRiDUJs2IoAJ4muUCgYAt80KnHcMgv8griPYY+QCvifsNxh/RAtb8UyQc\nALJOpfkjZlOISRQTVfgWbU/9PRe9qmr2Y+71ax4BjLgPoH46EvlQ7CVH1xTPSmqQ\nP55nHIAD/h0J2KW1UpnX92CsJ8bwEJr598gWNzvi5J4yHk4v7t1JUSg6c9s1Cgjl\ncIT22QKBgHayTw+K3CIf8f7j8Bso6JuKhJV4Hz7D5U0HFiKqSl5Hxl+V4LoaYtOR\npdqtQCNnVLrDcXaLNOknjDEvi1qtA5acbyiRS9dyE/Plv4p96rsyQY6PviU6gbKI\ncmWAExNsM5QZHHIToW855bFXm+rCZvCn3oYUA1tyvDQqZbZUX8pQ\n-----END RSA PRIVATE KEY-----\n"




bundle exec rails server --debugger -p 3000


pp path
"/api/v2/users/users/307602f2-469f-11e1-ad6f-00261824db2f.json"
its putting a .json on it should still work but should check this in curl


pp headers
{}
that cant be good
surprised getting 404 and not 500?


i think my local headers is overriding headers method - not setting headers


hmmm
i think rack matuh may be rejecting it?
need to put debugger into imediata/rackmatuh i guess
getting a 401


Completed 500 Internal Server Error in 8149ms


ActiveResource::UnauthorizedAccess (Failed.  Response code = 401.  Response message = Unauthorized.):
  app/models/user.rb:26:in `find_user'
 
/api/v2/users/users/307602f2-469f-11e1-ad6f-00261824db2f.json


also put .json explicitly on request?


mauth is definitely rejecting - local


yup curl works with .json
lets put .json in request


:path: /api/v2/users/307602f2-469f-11e1-ad6f-00261824db2f.json
this is the path that goes into signer!
not /api/v2/users/!


forecasting integration branch on balance


balance/yi wanted to use active resource - however can only use for rails 3.1 and balance is a loser with rails 2


do we need \n at beginning? or priv key?


need to step into mauth
/Users/magibson/.rvm/gems/ruby-1.8.7-p249@imedidata/bundler/gems/rack-mauth-d8ced6e7a9ea/lib/rack/mauth.rb


/Users/magibson/.rvm/gems/ruby-1.8.7-p249@imedidata/bundler/gems/mauth_signer-bc6bc2dc1684/lib/mauth_signer.rb


     # Verify request or response signature
   107      def verify_signature(signature, params, request_or_response)
   108        begin
=> 109          verify_signature_time(params[:time]) && secure_compare(decrypt_with_public_key(Base64.decode64(signature)), format_string_to_sign(request_or_response, params))
   110


this is failing!!
so the request is prob getting mangled or not doing exactly what we expect
oh we should put post as "" just in case


pp verify_signature_time(params[:time])
true
(rdb:7) pp secure_compare(decrypt_with_public_key(Base64.decode64(signature)), format_string_to_sign(request_or_response, params))
false
(rdb:7) decrypt_with_public_key(Base64.decode64(signature))
"19538997de750e866a0644751f66552ba0e680acfe9fce968b66372f6fa9f63488f7647fe507bbe053b63df43bac431ca723ebd20c83b5e53776e91bda0084dd"
(rdb:7) format_string_to_sign(request_or_response, params)
"4068d8b389bb6b35aca316ac09bc0c31b63df7e518d3ddd3eb324a7007f452a7b01380c63978c6988e591f339381b5722ef8756672ac801e973211b706a88b21"


so the params its signing with are different than the params sigining with over in user.rb
so we need to look at them - need to dig into these methods


pp params
{:digest=>
  "s9OkiRTLOcoKMCCpY6HZROcp5BBUpmOPA+LEYcw0w/bg0DG238Sx5lCs+S/vilxcdCAbYM6yn6C6a4qrEZsj9vOktUxZ5ynnaPGbTJ8idyr5qlqR1N1d0e9HXP/U4/eiEgLCWMVFvScsiLEFnyp5dKbKeOPnJX73r+x+9QL3Jm4XI5zZn4usI2/aBxLb9GZfhJgTFGnXaN3d05jDPrrdTeqyL0vdIykfBHnAdw2gH44CTZJIGBiwkFMlp/R54i/j6GNb1oBLlbJ3hSUwi/mhbl9FNB1+aTiSI1/4EYA9iYtpkDBiC9ODAcUpHTJKzKAhsGVZ7fnC5a3K1RImIVw+2w==",
 :app_uuid=>"d38e7edc-5113-11e1-95fe-70cd60fffe66",
 :time=>"1328899744",
 :verb=>"GET",
 :body=>"",
 :request_url=>"/api/v2/users/users/307602f2-469f-11e1-ad6f-00261824db2f.json"}
(rdb:7) pp request_or_response
:request


body is empty string
oh i wonder if its not there in other signinig????


pp str_to_sign
"GET\n/api/v2/users/users/307602f2-469f-11e1-ad6f-00261824db2f.json\n\nd38e7edc-5113-11e1-95fe-70cd60fffe66\n1328899744"


pp Digest::SHA512.hexdigest(str_to_sign)
"01309ee0539891ee767af8d7f68de3129d6e031077d34b0c04c8eb0e26bddec50bd0092d53482b7648aa3585620614ff7e13af24a1d93344e8c6e24e042eb0b5"


ill bet its the empty body! ill  bet active record shoves in the empty body to the request!


mauth_signer
    # Returns a header to include in authenticated requests
    def signed_request_headers(params)
      params.merge!(:time => Time.now.to_i)
      {
        'x-mws-authentication' => "MWS #{params[:app_uuid]}:#{generate_request_signature(params)}",
        'x-mws-time' => params[:time].to_s
      }
    end


    # Generates a signature by encrypting string of request parameters
    def generate_request_signature(params)
      generate_signature(params, :request)
    end
    # Generate request or response signature
    def generate_signature(params, request_or_response)
      sig = encrypt_with_private_key format_string_to_sign(request_or_response, params)
      Base64.encode64(sig).gsub("\n","")
    end


dam - putting :body => '' didnt work


pp str_to_sign
"GET\n/api/v2/users/users/307602f2-469f-11e1-ad6f-00261824db2f.json\n\nd38e7edc-5113-11e1-95fe-70cd60fffe66\n1328899744"


need to see what this string looks like in mauth signer for iir -
which is in a different gemset! 1.9.2
put a breakpoint there


wo look at that - users/users - thats the problem
users shouldnt be in there???


!!!!holy shit that was it - dont put users in path for active record because it adds it
but you dont have to put it in for maunl mauth signing of course


holy crap - it was the extra folder added - empty body and post didnt matter


oh but the .json does have to be there


ok should clean up code and make pull request - why not


commit # of submod imed has changed
from e06 to 75b
did i change this?


thats wrong - e06 is the latest
do i need to do submodule update?
nope
funny - i guess ill just discard it
cant undo in gitx - hmmmm


commit 75bcce708ddbda1a2f3256fbb98bc3fd8d6f9192
Author: Mark Gibson <magibson@mdsol.com>
Date:   Wed Feb 8 15:00:18 2012 -0500


    ignore .rvmrc


commit e0662bd1264da8feea09b79ecf0f2d4387078362
Author: Mike West <mwest@mdsol.com>
Date:   Mon Feb 6 09:38:47 2012 -0500


    Remove extra whitespace in preinitializer




so its some sort of new commit - which has my ignore .rvmrc in it
strange
dont know where that commit lives
or maybe its just local




mon 2/13
comments from ethan & ben on commit
use agi monkey patch
and use eureka


oh i should put my notes in github! then i can share notes across laptop and desktop! yes must do today!
also need to setup laptop


well what the hell is eureka?
http://eureka.ykyuen.info/2011/04/28/rails-file-upload-with-paperclip/
Rails – File Upload with Paperclip


ben:
Basically make a simple config file and make this pass
@PB11314-003




dam getting error on ven imed rake db:migrate
rake aborted!
uninitialized constant ApplicationController::CASClient


dam - run totally doesnt work - fs


 What about taking the AGI approach and doing the mixin? Did you want to also tackle that in the PR?
 Sent at 3:12 PM on Monday
 me:  once eureka comes the agi approach comes for free is my understanding
so i could put it in by hand now
or wait a few weeks for eureka
 Benjamin:  ok
 me:  should i put it in now?
 Benjamin:  what about a passing scenario for username?
or
 me:  or just wait
 Benjamin:  config file?
 me:  yea i dont have any scenarios
nor config file
do you want that in this pr?
 Benjamin:  I'll show your branch at reveal but, I don't want to merge until we have a scenario and config file
 me:  k
the config file will also be wiped out by eureka
which again leads to question
rewrite it now
or just wait for eureka?
 Benjamin:  eureka is months away from being production ready
Basically make a simple config file and make this pass
@PB11314-003


wait this is imedidata complaining about cas NOT iir
this is different
try recursive subomdule update?


http://stackoverflow.com/questions/1535524/git-submodule-inside-of-a-submodule
git submodule update --init --recursive




wed 2/15/12 - livermore
ok 1st thing is to get config in branch
its all working - good
we need gitx!


ok mauth_signer.rb is the hardwired class in models
its really the helper class
just need a yaml file in config with app uid private key 
keyed on env
and that would do it
authmedidata_database.yml is a good example
wow C-qC-j is line return for replace in emacs - who knew
install ack!
curl http://betterthangrep.com/ack-standalone > ~/bin/ack && chmod 0755 !#:3


hmm how strange
setting @@ class vars in mauth_signer from load config reading in yaml
file but when goes to use mauth_signer the var is not set but its a friggin clas var???
google for it - or look how its done in others


hmmm cas client sets @@vars just like im doing????
 def configure(config)
            @@config = config
            @@config[:logger] = RAILS_DEFAULT_LOGGER unless @@config[:logger]
            @@client = CASClient::Client.new(config)
            @@log = client.log


is mauth_signer somehow totally getting redone?
and how would i check for it


Ruby on Rails, in development mode, by default reloads your source files on each request. Since you're saving your "program"'s state in class variables, the changes get wiped out by the reloading of your classes.
http://stackoverflow.com/questions/9257136/class-variables-instance-variables-in-ruby


so of course - model is rails - its getting wiped out by rails
cas client is a plugin not in rails so not getting wiped


oh wait i think michael did this in imed branch!
oh but he just reads it in and uses it in environment.rb
it doesnt persist


1. set reload: Reload source code when changed.
2. set autolist: Execute list command on every breakpoint.
3. set listsize _n_: Set number of source lines to list by default to n.
4. set forcestep: Make sure the next and step commands always move to a new line
You can see the full list by using help set. Use help set _subcommand_ to learn about a particular set command.
You can include any number of these configuration lines inside a .rdebugrc file in yourHOME directory. ruby-debug will read this file every time it is loaded and configure itself accordingly.
Here’s a good start for an .rdebugrc:
set autolist
set forcestep
set listsize 25
	



ok moving along
config all done
lets get that cuc passing


so user find_user calls self.find(user_uuid) 
which needs to be mocked! and return a User


ok this is wierd 
in balance i can not find where the i am logged into step is defined???


oh its recursive sort of 
it calls itself
session steps in balance - authentication steps in gmc
Given(/^I am(?: currently)? logged in(?:to Balance)? as "([^\"]*)"$/) do |login|
  Capybara.current_session.reset!
  @current_user = MedidataUser.find(:first, :conditions => {:login => login})
  CASClient::Frameworks::Rails::Filter.fake(@current_user.login, { :user_id => @current_user.id })
  visit "/studies"
end


so what the hell is this MedidataUser
that might be a table in the db??


so i think MedidataUser is getting an actual user from db - 
so somewhere they must shove some test data into the db i guess?
but iir is different - there is no db!
so does this mean we somehow go off to imedidata and get the user in test?
or do we somehow mock imedidata in iir


ok i think we just need to come up with an object that makes that call happy
perhaps a homemade mocking obj or something
first need to run it and see where it fails


   Given I am logged in as "testuser" with name "Test User" # features/step_definitions/session_steps.rb:3
      Connection refused - connect(2) (Errno::ECONNREFUSED)
      /Users/magibson/.rvm/rubies/ruby-1.9.2-p290/lib/ruby/1.9.1/net/http.rb:644:in `initialize'
      /Users/magibson/.rvm/rubies/ruby-1.9.2-p290/lib/ruby/1.9.1/net/http.rb:644:in `open'
      /Users/magibson/.rvm/rubies/ruby-1.9.2-p290/lib/ruby/1.9.1/net/http.rb:644:in `block in connect'
      /Users/magibson/.rvm/rubies/ruby-1.9.2-p290/lib/ruby/1.9.1/timeout.rb:44:in `timeout'
      /Users/magibson/.rvm/rubies/ruby-1.9.2-p290/lib/ruby/1.9.1/timeout.rb:89:in `timeout'
      /Users/magibson/.rvm/rubies/ruby-1.9.2-p290/lib/ruby/1.9.1/net/http.rb:644:in `connect'
      /Users/magibson/.rvm/rubies/ruby-1.9.2-p290/lib/ruby/1.9.1/net/http.rb:637:in `do_start'
      /Users/magibson/.rvm/rubies/ruby-1.9.2-p290/lib/ruby/1.9.1/net/http.rb:626:in `start'
      /Users/magibson/.rvm/rubies/ruby-1.9.2-p290/lib/ruby/1.9.1/net/http.rb:1168:in `request'
      /Users/magibson/.rvm/rubies/ruby-1.9.2-p290/lib/ruby/1.9.1/net/http.rb:888:in `get'
      ./app/models/user.rb:12:in `find_user'
      ./app/controllers/investigator/studies_controller.rb:12:in `get_user_info'
      ./app/controllers/investigator/studies_controller.rb:5:in `index'
      ./features/step_definitions/session_steps.rb:7:in `/^I am logged in as "([^\"]*)" with name "([^\"]*)"$/'
      features/general/page.feature:9:in `Given I am logged in as "testuser" with name "Test User"'


  visit "/"
triggers this - no way around this
i think either have to put in mocks or have to hook imedidata
lets query balance gmc imed and see if they use mocks in steps
or if thats a no no


~/b/features/step_definitions (master) $ ack mock
field_mapper_steps.rb
2:require "spec/mocks"
166:  field_map_controller = mock(FieldMappingsController)
181:  inventory_batch_file_mock = mock_model(InventoryBatchFile)
182:  inventory_batch_file_mock.stub(:headers!).and_raise InventoryBatchFile::UnableToRetrieveData
183:  InventoryBatchFile.stub(:find).and_return(inventory_batch_file_mock)


interesting only in field mapper steps - that must be for the ajax?


~/b/features/step_definitions (master) $ ack stub
application_steps.rb
315:Given /^the date is stubbed to (.*)$/ do |datetime|
318:  Time.stub(:now).and_return(Time.parse(datetime))
319:  DateTime.stub(:now).and_return(DateTime.parse(datetime))


field_mapper_steps.rb
1:require 'spec/stubs/cucumber'
93:  # find current audits in system (before auditable action takes place), and stub current date for Packlist create
96:    Date.stub(:today => datetime.to_date)
167:  field_map_controller.stub(:map_values)
173:  FieldMappingsController.stub(:force_timeout).and_return(true)
182:  inventory_batch_file_mock.stub(:headers!).and_raise InventoryBatchFile::UnableToRetrieveData
183:  InventoryBatchFile.stub(:find).and_return(inventory_batch_file_mock)


shipment_steps.rb
91:  MedidataResource.stub(:post)




gmc ack stub
authentication_steps.rb
25:    Sponsor::StudiesController.any_instance.stubs(:session_expired?).returns(true)


budget_steps.rb
19:  Gmp::GmpData.stub!(:budgets).and_return(
61:  stub_request(:get, endpoint).to_return(:body => response)
65:  stub_request(:get, token_point).to_return(:body => token)


custom_web_steps.rb
18:  Time.stub!(:now).and_return(@now)


document_steps.rb
32:  stubed_docks_upload_response_body = File.new(File.join(Rails.root, 'spec/fake/docks_create_upload_response.json'))
33:  Parley::AuthenticationDocks.stub!(:request_token)
34:  stub_request(:post, /#{Regexp.new(upload_request_endpoint)}/).to_return(:body => stubed_docks_upload_response_body, :status => 201)
68:  Parley::AuthenticationDocks.stub!(:request_token)
69:  stub_request(:delete, /#{Regexp.new(remove_doc_app_endpoint)}/)


i forget what diff between stub and mock is
person = double("person")
Person.stub(:find) { person }


double and mock are samt thing
hmmm how do i stub the index or get_user_info method of studies controller
dont i have to get a hold of the instance of studies controller?


from field_mapper_steps
When /^article types are being processed$/ do
  field_map_controller = mock(FieldMappingsController)
  field_map_controller.stub(:map_values)
end


put in env.rb somewhere
World(RSpec::Rails::Mocks, Rspec::Mocks::ExampleMethods) 
https://groups.google.com/group/cukes/browse_thread/thread/a3c4c6b2241c98fe?pli=1


in features/support/env.rb - which seems new - not in balance
Module: RSpec::Rails::Mocks
Defined in:
lib/rspec/rails/mocks.rb
person = double("person")
Person.stub(:find) { person }

finally got stub to work with
require 'spec_helper'


now getting a funny error i dont understand
/Users/magibson/.rvm/gems/ruby-1.9.2-p290@iir/gems/activesupport-3.1.3/lib/active_support/dependencies.rb:234:in `load': /Users/magibson/projects/iir/features/general/page.feature:3: syntax error, unexpected ':', expecting $end (SyntaxError)
Feature: General Page Elements (General-Page)
        ^


its not understanding feature format it seems ???


https://github.com/sunaku/tork/issues/27
wo! seems to be bug in cuc ruby 1.9.2 using rspec from cuc - arg!
and this is a very recent issue - conv/fix is from a few days ago -yikes!
but this is for running tork - which im not aware im running that if i am - red herring?


wait ben has tests that pass - lets find those and fiddle


cu features/general/page.feature:15 i think is a passing feature
  #Header content
  @Release2012.1.0
  @PB11314-001
  @Review[SQA]
  Scenario: The IIR logo should be in the header
    Then I should see the "IIR Logo" image within the "header"


i think my additions have broken this
rspec is in gemfile - should try taking it out
spec/helper in f/s_d/session_steps


f/sup/env.rb has req rspec/rails and World...


try taking these things out and running


wait i dont think any of these features passed as they all depend on login


wait - i broke scenarios when i added user.find! take it out


yes passes now with out


oh wow - spec_helper is causing this bug
/Users/magibson/.rvm/gems/ruby-1.9.2-p290@iir/gems/activesupport-3.1.3/lib/active_support/dependencies.rb:234:in `load': /Users/magibson/projects/iir/features/general/page.feature:3: syntax error, unexpected ':', expecting $end (SyntaxError)
Feature: General Page Elements (General-Page)
 
spec_helper must not be the way to go!
lets clean up gemfile 1st and other things to make sure its not a combo
taking out rspec in gem


if take out rspec then env.rb fails


http://www.rubyinside.com/how-to-rails-3-and-rspec-2-4336.html
spec/spec_helper.rb - a file that's loaded by every spec (not in any automatic way but most have require 'spec_helper' at the top). It sets the test environment, contains app level RSpec configuration items, loads support files, and more.


annoying - google docs is down
so spec_helper is fucked up
in particular rspec/autorun - if i comment it out
then the feature file wont get evaluated as a ruby file and fail
so comment it out i shall
its needed for mocking but i wonder what actual part of it is needed
lets just extract bits and see
dam i swear i had this sorta working minus the funny issue
uninitialized constant RSpec::Mocks (NameError)
thought i fixed that??
gemfile rspec?
yes that was it


dam cant get stub to work
i thought i had this workin? maybe not 




fri 2/17/12 - livermore


cool all the tests pass


theres so few tests can just say cucumber at root


ok onto next branch problem - i think study index


ok study index - is this querying for just 1 study? or all studies of a user
i think its all studies of a user - yes confirmed with ben


lets try to write a feature 1st for clarity
i think the studies come in on the home page
i think theres a studies.feature? look at balance or gmc?


gmc features/study/site_study_list.feature is good file to look at i think
Scenario: A Site user can view overall status of site budgets on the Site Study List page
Given I am logged into Parley
  And Site user have access to studies:
    | name | study group |
    | StudyA | sp1 |
    | StudyB | sp2 |
  And each study has a budget
  And the budget "BudgetA" has negotiations with the following properties:
    | Site | Negotiations | Status | Round |
    | Site 1 | Negotiation 1 | Open to Sponsor | 2 |
    | Site 2 | Negotiation 2 | Open to Site | 2 |
    | Site 8 | Negotiation 3 | Open to Sponsor | 2 |
    | Site 4 | Negotiation 4 | Cancelled | 2 |
    | Site 10| Negotiation 5 | Completed | 2 |
    | Site 9 | Negotiation 6 | Open to Site | 2 |
  When I am on the "Site Study List" page
  Then I should see a "Fat Header" with the following data:
    | Open to Me | 2 |
    | Open to Sponsor | 2 |
    | Completed | 1 |
    | Total Site Budgets | 5 |


no budgets yet so just
Scenario: A Site user can view overall status of site budgets on the Site Study List page
Given I am logged into Parley
  And Site user have access to studies:
    | name | study group |
    | StudyA | sp1 |
    | StudyB | sp2 |
...
    When I am on the "Site Study List" page
  Then I should see a "Fat Header" with the following data:
    | Open to Me | 2 |
    | Open to Sponsor | 2 |
    | Completed | 1 |
   …
step_defs/study_steps


Given /^I have access to studies:$/ do |table|
  table.hashes.each do |hash|
    create_or_return_study_by_name(hash[:name], nil, hash[:role], hash["study group"])
  end
end


module StudyHelpers
  # create study and all related data (medidata, associations)
  # medidata dictate "study name" should be unique 
  # this function allows to avoid to dublicate study with the same name twice
  def create_or_return_study_by_name(name, user = nil, role = nil, study_group_name=nil)
    raise "Study Name is empty" if name.blank?
    raise "require medidata user" if !defined?(@medidata_user) || (user.blank? and @medidata_user.blank?)
    @medidata_user ||= user
    role ||= User.find_remote(@medidata_user.id).role if @medidata_user
    
    medidata_study_name = MedidataStudy.where("medidata_studies.name = ?", name).first
    if medidata_study_name.blank?
      medidata_study_group = Imedidata::MedidataStudyGroup.where(:name => study_group_name).first
      medidata_study_group = Factory(:medidata_study_group, :name => study_group_name) if medidata_study_group.blank?
      medidata_study = Factory(:medidata_study, :name => name, :medidata_study_group => medidata_study_group)
      medidata_association = Factory(:medidata_association, :medidata_study => medidata_study, :medidata_user => @medidata_user)
      study_role = Factory(:medidata_user_study_role_oid, :medidata_study => medidata_study, :medidata_user => @medidata_user, :oid => role || Role::SPONSOR_ROLE)
      study = Study.synchronize_by_study(:imedidata_study_id => medidata_study.id)
      set_fake_date(study)
    else
      MedidataAssociation.where(:medidata_study_id => medidata_study_name.id, :medidata_user_id => @medidata_user.id).first ? nil :  Factory(:medidata_association, :medidata_study => medidata_study_name, :medidata_user => @medidata_user)
      MedidataUserStudyRoleOid.where(:medidata_study_id => medidata_study_name.id, :medidata_user_id => @medidata_user.id, :oid => (role || Role::SPONSOR_ROLE)).first ? nil : Factory(:medidata_user_study_role_oid, :medidata_study => medidata_study_name, :medidata_user => @medidata_user, :oid => role || Role::SPONSOR_ROLE)
      study = Study.synchronize_by_study(:imedidata_study_id => medidata_study_name.id)
    end
    study.medidata.medidata_study_group.update_attributes(:name => study_group_name) if study_group_name


    return study
  end


does balance show a list of studies on front page?
      medidata_study_group = Imedidata::MedidataStudyGroup.where(:name => study_group_name).first
      medidata_study_group = Factory(:medidata_study_group, :name => study_group_name) if medidata_study_group.blank?
      medidata_study = Factory(:medidata_study, :name => name, :medidata_study_group => medidata_study_group)
      medidata_association = Factory(:medidata_association, :medidata_study => medidata_study, :medidata_user => @medidata_user)
      study_role = Factory(:medidata_user_study_role_oid, :medidata_study => medidata_study, :medidata_user => @medidata_user, :oid => role || Role::SPONSOR_ROLE)
      study = Study.synchronize_by_study(:imedidata_study_id => medidata_study.id)
      set_fake_date(study)
    else
      MedidataAssociation.where(:medidata_study_id => medidata_study_name.id, :medidata_user_id => @medidata_user.id).first ? nil :  Factory(:medidata_association, :medidata_study => medidata_study_name, :medidata_user => @medidata_user)
      MedidataUserStudyRoleOid.where(:medidata_study_id => medidata_study_name.id, :medidata_user_id => @medidata_user.id, :oid => (role || Role::SPONSOR_ROLE)).first ? nil : Factory(:medidata_user_study_role_oid, :medidata_study => medidata_study_name, :medidata_user => @medidata_user, :oid => role || Role::SPONSOR_ROLE)
      study = Study.synchronize_by_study(:imedidata_study_id => medidata_study_name.id)




lots of factory stuff there - i dont think we are doing factories for active resource/service objects??
just mocks? i think factories are for active record not active resource


(gmc above - balance below)


balance:
# The Study List page provides users with the list of studies to which they have access in Balance. It serves as the landing page in Balance for users who have access to more than one study. For each study the list page shows the number of subjects, with a link to the subject list, and the number of sites, with a link to that list as well. The list also indicates for each site whether or not it is Live.


Feature: Study List Page (Study-List)
  In order to organize my studies 
  As a user 
  I want to see a list of studies


  Background:
    Given a study exists with name: "Test Study 1"
    And a medidata_study_group exists with name: "Test Study Group"
    And a medidata_study exists with name: "Test Study 2", parent: "Test Study Group"
    And a study exists with medidata: "Test Study 2"
    And a medidata user exists with login: "testuser"
    And "testuser" has access to study "Test Study 1" as a "System Administrator"
    And "testuser" has access to study "Test Study 2" as a "Primary Investigator"
    And I am logged into Balance as "testuser"


  @Release2010.1.0
  @PB116-001
  @Validation
  Scenario: The Study List page should show a list of Studies associated with the user in iMedidata.
    When I go to the "Study List" page
    Then I should see "Test Study 1"
    And I should see "Test Study 2"


step_def/study_steps.rb
wierd in performance steps NOT study_steps
oh wait ill bet thats a factory thing
lets reasearch factory girl


balance 
feature/support/factories.rb
Factory.define :study do |s|
  s.medidata { |study| study.association(:medidata_study, :name => study.name || "Fake Study #{Factory.next(:study_name_id2)}") }
  s.association :study_design
  s.study_status { StudyStatus.find_by_name("Design") }
  s.live false
  s.name { "Fake Study #{Factory.next(:study_name_id)}" }
  s.sequence(:id) { |n| n+100 }
end


i guess one question is what does balance do with imedidata
well actually balance has a bunch of imedidata tables i believe and it synchs
so not relevant


https://github.com/moonmaster9000/dupe_example_app
dupe!
funny the docs are about webrat not capybara


well lets try out dupe i guess until ben nixes it 


first lets write a scenario
2nd skecth out some steps - well run scenario and it will create skeleton




gem install dupe


ok have a step & scenario
next put in dupe i guess


webrat? capybara?


script/generate dupe
? wonder what that does?


uh oh - the docs are out of date
there is no script/generate
just script/rails


almost worth scrapping


just adapted to rails 3.1 4 months ago
need to find up to date docs


https://gist.github.com/989132
run install tasks for our gems
rails g cucumber:install
rails g rspec:install
rails g simple_form:install
???


rails g dupe:install
Could not find generator dupe:install.


well lets try to carry on 
and scrap if they dont get back and it doesnt work


should i continue implementing study test
i think should put in code now 
gives time til we hear from dupe folk


so code - study controller needs to call study model
thats an active resource 
that calls imedidata - need to figure out url there


wo! theres no app/models??? no user model???
maybe i forgot to pull into develop??


studies_api_v2_user GET /api/v2/users/:id/studies(.:format) {:action=>"studies", :controller=>"api/v2/users"}
i think that gets studies of user and id is user
not users of study


(:studies)
# PUT an update by invoking the 'promote' REST method, i.e. PUT /people/1/promote.json?position=Manager.
Person.find(1).put(:promote, :position => 'Manager')
# => { :id => 1, :name => 'Ryan', :position => 'Manager' }



 i think i should put studies in flash?


wow - if give User.find_user a nil user_uuid it still retrieves a user


oh of course - its mocked silly - this is with cucumber
need to run it thru web - do this on tues/wed


mon 2/20 dorrington president day georgie porgie
gonna try out dupe!
need to hook iir up with mauth innovate - sandbox mauth is down and we are not suppose to use that
who knew
emailed jeanlouis to hook up an iir key


so study/list.feature has when I go to the study list page
that needs to be done with dupe i think
no thats not dupe 
dupe is 
Given the library has lots of books
   When I go to the books index page
   Then I should see all of the books in the library


Given /^the library has lots of books$/ do
 Dupe.create :book, :name => "Rooby Rocks"
 Dupe.create :book, :name => "Rails Rocks too!"
end
Then /^I should see all of the books in the library$/ do
 Then %{I should see "Rooby Rocks"}
 Then %{I should see "Rails Rocks too!"}
end
but not the going to of the page - even the then i should see
its the library has lots of books


Background:
  Given a study exists with name: "Hooshy"


thats the step that needs duping!
Dupe.create :book, :name => "Rooby Rocks"
Dupe.create :study, :name => var


was wondering about variables in controller and view
view can see instance variables of controller
as can be seen in field_mappings view new.html.haml @study in super class ApplicationController which is
set by before_filter


Dupe.create :user, :name => “Test User”, 
well actually we already have casClient.fake 


 @studies = User.find_studies(get_user_uuid)


mock User.find_studies
for every scenario that hits main study page???
surely theres a better way
lets look at balance
or wait maybe we only need to mock it in iam logged in step


but wait find_studies should be taking advantadge of dupe
should we just mock out get_user_uuid that comes from cas - which stuffs it in the session
dont think we can dupe that? even though cas is actually a service
the cas client puts it in the session
how do you stub a controller method - how do you get a hold of an instance of the controller
want to do:
application_controller.stub(:get_user_uuid).and_return(“fake_uuid”)


from balance:
  field_map_controller = mock(FieldMappingsController)
  field_map_controller.stub(:map_values)


that works
  application_controller = mock(ApplicationController)
  application_controller.stub(:get_user_uuid).and_return('fake_uuid')


haml = is do ruby and print out result  - is do ruby dont print out result


there is css for header
app/views/layouts/application.html.haml
app/views/shared/_header.html.haml


theres css inside of app/assets/stylesheets
which has head.css


lets look at balance
in public/stylesheets/balance.css is a body element


lets step back
lets just look at how a balance feature tests for well i guess table & body content
and actually lets look at a balance home page


  Scenario: The Study List page should show a list of Studies associated with the user in iMedidata.
    When I go to the "Study List" page
    Then I should see "Test Study 1"
    And I should see "Test Study 2"


balance doesnt do this see blah in yah - just see - ben added the selector anew hmm
#header
what is # in haml?




. is class, # is id
ben has a # header id
so do we need a # body id
f is 


oh balance does have some stuff


web_steps
~/b/features/step_definitions (master) $ ack within | g "should see"
application_steps.rb:382:  Then %Q(I should see "#{text}" within "#{locator}")
field_mapper_steps.rb:132:Then /^I should see "([^"]*)"(?: within "([^"]*)")? is mapped to "([^"]*)"$/ do |mapped_from, selector, mapped_to|
web_steps.rb:108:  Then /^(?:|I )should see #{quote}([^#{quote}]*)#{quote}(?: within(?: the)? "([^"]*)")?$/ do |text, selector|
web_steps.rb:125:Then /^(?:|I )should see \/([^\/]*)\/(?: within ?:the "([^"]*)")?$/ do |regexp, selector|


site/list.feature:59:    Then I should see "Name" within "Site List"


 with_scope(get_scope(selector))
def get_scope(selector)
  if !@content.blank? && !@content.attributes["id"].blank?
    selector = '#' + @content.attributes['id'].value
  elsif selector.blank?
    # First see if there is html in the modal, if true then see if there is a selector within the current scope.
    selector = '#modal' if html.include?('id="modal"') && has_selector?("#modal")
  else
    selector = selector.downcase.gsub(/\s+/, '_') 
    selector = '#' + selector unless selector.include?('#')
  end
  return selector
end


maybe we should follow what ben did with header ? it sure is confusing this crap


  %body
    = render "shared/header"


#header


so in haml just put #something and then reference that in test
#header
  #banner
    #logo= link_to(image_tag("logo.gif", :alt => "IIR Logo"), root_path, {:id => 'iir_logo'})
  #header-center
    = link_to(image_tag( "imedidata.gif", :alt => "iMedidata Logo" ), CLOUD_ENV["imed_base_url"], { :id => 'imedidata_logo' })
  #user-area
    #top_rung
      %span#help= render '/shared/help_menu'
      %span#logout= link_to( t('application.header.logout'), logout_url )
    #bottom_rung= (session[:full_name] || "") + " (" + session["cas_user"] + ")" 




maybe #user-area would do it? try it


well it fails but diff err - it finds the element - progress
but apparently not printing in the element
but wait theres prob no studies


pp User.find_studies(get_user_uuid)
nil


no studies silly


hmmm debugger in User.find_studies is not being hit - so its being bypassed ???
is dupe causing that?
pp User.find_studies(get_user_uuid)
nil


oh wait - i think the user is being mocked in login
Given(/^I am logged in as "([^\"]*)" with name "([^\"]*)"$/) do |login,full_name|
  Capybara.current_session.reset!
  CASClient::Frameworks::Rails::Filter.fake(login, { :full_name => full_name })
  user = mock(User)
  user.stub(:name).and_return(full_name)
  User.stub(:find_user).and_return(user)
  User.stub(:find_studies).and_return()


oh duh - and find_studies is being mocked
that cant bewith dupe
clearly im lost on the mocking duping scene - this stuff is hairy


wed 2/22 dorrington
ok pick up where we left off - we are blocking out dupe and screwing up studies scenario
take out stub for find_studies see what happens
  #User.stub(:find_studies).and_return()
need to mock get_user_uuid apparently
dam this doesnt work
 session[:cas_extra_attributes][:user_uuid] = 'fake-uuid'


oish nothing is working!
one post says use params has not seeing that


how does balance deal with this - ill bet balance also gets its user id in the seesion


from balance
  # Sets a session's user_id attribute for CAS.
  def set_session_user_id
    cas_attrs = session[:cas_extra_attributes]
    @session_user_id = cas_attrs[:user_id] unless cas_attrs.blank?
  end


balance session_steps
Given(/^I am(?: currently)? logged in(?:to Balance)? as "([^\"]*)"$/) do |login|
  Capybara.current_session.reset!
  @current_user = MedidataUser.find(:first, :conditions => {:login => login})
  CASClient::Frameworks::Rails::Filter.fake(@current_user.login, { :user_id => @current_user.id })
  visit "/studies"
end


well what the hell happens when you visit /studies
a/c/studies_controller.index
all sorts of stuff in there


  if params[:study_id]
      # When the study id is specified we must force a sync in case a new study was 
      # created and the user already logged into balance
      balance_imed_sync(User.current.id)


User.current.id NOT session! lets try that
 @user_studies = User.current.studies
do we have User.current?


  # Returns the Current User.
  def self.current
    Thread.current[:user]
  end


  # Sets the Current User.
  def self.current=(u)
    raise ArgumentError, "Expected object of class '#{self}', got #{u.inspect}" unless u.is_a?(self) || u.nil?
    Thread.current[:user] = u
    Thread.current[:user_id] = u.id
  end


  # Sets the Current User to self -- to the User instance that is calling the method.
  def make_current!
    User.current = self
  end


  # Returns the current user of the session.
  def get_current_user
    @current_user = User.current = User.find(@session_user_id)
    I18n.locale = @current_user.locale || "eng"
  end


  # Returns all Studies that contain the User.
  def studies
    Study.scoped(:include => {:medidata => :medidata_users}, :conditions => ["medidata_users.id = ?", self.id])
  end


our approach isnt right - lets mimic balance!


  Given I am logged in as "testuser" with name "Test User" # features/step_definitions/session_steps.rb:4
      No user uuid (ArgumentError)
      ./app/models/user.rb:21:in `find_user'
      ./app/controllers/application_controller.rb:28:in `get_current_user'
      ./features/step_definitions/session_steps.rb:24:in `/^I am logged in as "([^\"]*)" with name "([^\"]*)"$/'
 
ok login scenario is failing again lets get that passing
cu features/general/page.feature:30
faling in background
   Given I am logged in as "testuser" with name "Test User" # features/step_definitions/session_steps.rb:4
      No user uuid (ArgumentError)
 
lets look at balance
Given(/^I am(?: currently)? logged in(?:to Balance)? as "([^\"]*)"$/) do |login|
  Capybara.current_session.reset!
  @current_user = MedidataUser.find(:first, :conditions => {:login => login})
  CASClient::Frameworks::Rails::Filter.fake(@current_user.login, { :user_id => @current_user.id })
  visit "/studies"
end


i lack a @current_user - which i think is using factory girl
i could try with dupe?
notice balance sets up its user and THEN calls cas client
lets imitata that
where is factory girl setup - i guess who cares for now just get it workin


No mocked service response found for '/api/v2/users/1.json'
oh silly goose its the api/v2 thats a problem! for dupe


custom intercept mock
Get %r{/authors/published.xml} do
  --#   Dupe.find(:authors) {|a| a.published == true}
  --# end


irb# Get %r{/authors\.xml\?published=(true|false)$} do |published|
--#   if published == 'true'
--#     Dupe.find(:authors) {|a| a.published == true}
--#   else
--#     Dupe.find(:authors) {|a| a.published == false}
--#   end
--# end


i think dupe only works with xml not json
1st of all is this true?
2nd of all does it matter?


this is trying to do json on xml it seems
   Given I am logged in as "testuser" with name "Test User" # features/step_definitions/session_steps.rb:5
      756: unexpected token at '<?xml version="1.0" encoding="UTF-8"?>
      <user>
        <id type="integer">1</id>
        <full-name>Test User</full-name>
      </user>
      ' (MultiJson::DecodeError)
      ./features/step_definitions/session_steps.rb:14:in `/^I am logged in as "([^\"]*)" with name "([^\"]*)"$/'
      features/general/page.feature:9:in `Given I am logged in as "testuser" with name "Test User"'


so dupe is returning xml
and then its trying to be parsed as json
whos doing the parsing???
i think active resource is all .json somehow - it adds .json by default remember
and thus expects json


http://api.rubyonrails.org/classes/ActiveResource/Base.html


format()
Returns the current format, default is ActiveResource::Formats::JsonFormat.
Source: show | on GitHub
format=(mime_type_reference_or_format)
Sets the format that attributes are sent and received in from a mime type reference:
Person.format = :json
Person.find(1) # => GET /people/1.json

Person.format = ActiveResource::Formats::XmlFormat
Person.find(1) # => GET /people/1.xml

Default format is :json.


________________
User.format = :xml worked


i think mauth headers are screwing up dupe oh my
commenting out for now
    #MauthSigner.set_mauth_headers(self,full_path)


   Given I am logged in as "testuser" with name "Test User" # features/step_definitions/session_steps.rb:5
      undefined local variable or method `user' for #<Investigator::StudiesController:0x00000105d530d0> (NameError)
      ./app/controllers/application_controller.rb:33:in `get_user_info'
      ./features/step_definitions/session_steps.rb:35:in `/^I am logged in as "([^\"]*)" with name "([^\"]*)"$/'
      features/general/page.feature:9:in `Given I am logged in as "testuser" with name "Test User"'


 7      @studies = User.current.find_studies(get_user_uuid) || []
   8    end
   9  
   10  end
/Users/magibson/projects/iir/app/controllers/investigator/studies_controller.rb:7
@studies = User.current.find_studies(get_user_uuid) || []
(rdb:1) c
    Given I am logged in as "testuser" with name "Test User" # features/step_definitions/session_steps.rb:5
      undefined method `find_studies' for #<User:0x000001072ab8d8> (NoMethodError)


hmmmm 
does active resource work as an instance methoetd


wait this is my wrapper method


since dont have mauth/app working should prob double check with curl - annoying but only option at moment


mysql> select id,uuid,login,email from users;
+----+--------------------------------------+------------+---------------------+
| id | uuid                                 | login      | email               |
+----+--------------------------------------+------------+---------------------+
| -2 | 735eb026-469c-11e1-9178-00261824db2f | System     | NULL                |
|  1 | 307602f2-469f-11e1-ad6f-00261824db2f | superadmin | harrycaul@mdsol.com |
+----+--------------------------------------+------------+---------------------+


so its just called uuid
man google docs sucks! keeps haniging 
tempting to go back to git/emacs


though just cos its uuid doesnt mean its not user_uuid in json?
yea this is unusable!
need to do curl double check


we need to stub out MauthSigner.set_mauth_headers


    Given I am logged in as "testuser" with name "Test User" # features/step_definitions/session_steps.rb:5
      undefined method `find' for #<User:0x000001078cfe30> (NoMethodError)
      ./app/models/user.rb:39:in `find_studies'
 
need to dupe studies

select id,name,parent_id,uuid from studies;
+----+-------------------+-----------+--------------------------------------+
| id | name              | parent_id | uuid                                 |
+----+-------------------+-----------+--------------------------------------+
|  1 | Study Group Alpha |      NULL | b812a1d8-46a0-11e1-a3e6-00261824db2f |
|  2 | Study Alpha       |         1 | 6555bd04-4795-11e1-81a0-00261824db2f |
|  3 | Study Beta        |         1 | ab1a11d6-4935-11e1-827e-00261824db2f |
|  4 | Study Gamma       |         1 | fbe7cf4a-4935-11e1-827e-00261824db2f |
|  5 | aaa for iir       |      NULL | 35aa8dec-5199-11e1-95fe-70cd60fffe66 |
|  6 | aa study          |         5 | d2216ad8-5199-11e1-95fe-70cd60fffe66 |

how does studies relate to users
must be a many to many of course

show tables;
app_assignments                            |
| app_assignments_roles                      |
| app_types                                  |
| apps                                       |
| apps_idps                                  |
| apps_owned_studies                         |
| apps_studies                               |
| apps_study_groups                          |
| apps_teams                                 |
| audit_formats                              |
| audit_targets                              |
| audits                                     |
| blocking_courses_study_group_invitations   |
| blocking_courses_study_invitations         |
| blocking_courses_team_invitations          |
| cas_sessions                               |
| categories                                 |
| course_assignment_attempt_answers          |
| course_assignment_attempts                 |
| course_assignment_statuses                 |
| course_assignments                         |
| course_assignments_course_mappings         |
| course_assignments_study_group_invitations |
| course_assignments_study_invitations       |
| course_assignments_team_invitations        |
| course_files                               |
| course_mappings                            |
| course_overrides                           |
| courses                                    |
| courses_sites                              |
| courses_studies                            |
| courses_teams                              |
| depots                                     |
| emails                                     |
| esignatures                                |
| evaluations                                |
| exports                                    |
| file_attachments                           |
| forgot_password_tokens                     |
| invitation_app_details                     |
| invitation_app_details_roles               |
| invitation_details                         |
| invitation_details_study_group_invitations |
| invitation_details_study_invitations       |
| invitation_details_team_invitations        |
| invitation_study_site_details              |
| login_attempts                             |
| messages                                   |
| notifications                              |
| old_passwords                              |
| phases                                     |
| questions                                  |
| request_tokens                             |
| roles                                      |
| roles_study_site_assignments               |
| schema_migrations                          |
| security_questions                         |
| sessions                                   |
| site_invitations                           |
| site_types                                 |
| sites                                      |
| studies                                    |
| study_depot_assignments                    |
| study_group_invitations                    |
| study_group_types                          |
| study_invitations                          |
| study_site_assignments                     |
| study_sites                                |
| team_invitations                           |
| team_types                                 |
| teams                                      |
| therapeutic_areas                          |
| user_security_questions                    |
| users                                      |
| users_courses      

select id,study_id,subject_id,inviter_id,invitee_id from study_invitations;
+----+----------+------------+------------+------------+
| id | study_id | subject_id | inviter_id | invitee_id |
+----+----------+------------+------------+------------+
|  1 |        1 | NULL       |          1 |          1 |
|  2 |        2 | NULL       |          1 |          1 |
|  3 |        3 | NULL       |          1 |          1 |
|  4 |        4 | NULL       |          1 |          1 |
|  5 |        5 | NULL       |          1 |          1 |
|  6 |        6 | NULL       |          1 |          1 |
+----+----------+------------+------------+------------+
+----+----------+------------+------------+------------+---------------------+
| id | study_id | subject_id | inviter_id | invitee_id | accepted_at         |
+----+----------+------------+------------+------------+---------------------+
|  1 |        1 | NULL       |          1 |          1 | 2012-01-25 20:43:38 |
|  2 |        2 | NULL       |          1 |          1 | 2012-01-25 20:44:38 |
|  3 |        3 | NULL       |          1 |          1 | 2012-01-27 22:24:26 |
|  4 |        4 | NULL       |          1 |          1 | 2012-01-27 22:26:41 |
|  5 |        5 | NULL       |          1 |          1 | 2012-02-07 14:40:23 |
|  6 |        6 | NULL       |          1 |          1 | 2012-02-07 14:41:30 |

study 5 is what we care about

  1 | superadmin | harrycaul@mdsol.com | 307602f2-469f-11e1-ad6f-00261824db2f |

so i think study_invitations is the link between study and user

studies_api_v2_user GET /api/v2/users/:id/studies(.:format) {:action=>"studies", :controller=>"api/v2/users"}
screw invitations
all we care about is the above
and how we will model that in the model
and that is a user will have many studies and vice versa many to many


Dupe.define :book do |book|
 --#   book.name
 --#   book.author
 --# end

irb# Dupe.create :book
  ==> <#Duped::Book author=nil id=1 name=nil>

Given /^an author with many books$/ do
  @author = Dupe.create :author
  @author.books = Dupe.stub 10, :books, :like => {:author => @author}
end

well wait step back - actually we are only dealing with 1 user at a time!
and will usually only have 1 study as investigator
though a sponsor can have mutliple studies and an investigator in rare
case can prob have more than one 1 study
so user is like author in example and study is like book

oh my - once we have a duped User it has metho find_studies still
but that method calls self.find
and self.find is no longer - it seems the User object is no longer active resource
but i need it to be - hmmmmm
ah! the issue is with self.find
if i do User.find its fine!

 No mocked service response found for '/api/v2/users/fake-uuid.xml' (Dupe::Network::RequestNotFoundError)
but thats not quite right
studies_api_v2_user GET /api/v2/users/:id/studies(.:format) {:action=>"studies", :controller=>"api/v2/users"}
its suppose to be putting /studies at end???
 User.find(uuid).get(:studies)
and its not ???
wait this is an active resource issue NOT a dupe issue - argh!

# PUT an update by invoking the 'promote' REST method, i.e. PUT /people/1/promote.json?position=Manager.
Person.find(1).put(:promote, :position => 'Manager')

that seems clear 
lets try doing put

wait a second - first its calling find and THEN it calls get
its failing on the find!
this is wierd for sure
i think dupe isnt handling this wierd case

2 things - lets email author
and lets try duping the simple find and see what happens

   Given I am logged in as "testuser" with name "Test User" # features/step_definitions/session_steps.rb:5
      Failed with 404: the request '/api/v2/users/1/studies.xml' returned nil. (Dupe::Network::Mock::ResourceNotFoundError)
      ./app/models/user.rb:42:in `find_studies'
 oh crap - its getting close
but i know whats wrong here - 
 User.find(uuid).get(:studies) - its doing User.find with uuid - finding the user
and then using the id not the uuid of the user - and dupe is artificially making ids
i wonder if can subvert dupe to put uuid in for id?
yea i think so

pp user_uuid
"fake-uuid/studies"
oh crap
Get %r{/api/v2/users/(.*).xml$}
that regexp is too aggressive - need no / i guess

holy shit it passed
though need to be sure it actually did what we think it did

so active record puts id into url of object of find - so need to make
sure that id is set to uuid - dupe on creation makes artifical ids - have to override that i think
or alternatively could just try to go with the made up ids but that may be trouble


wait - login passed - not study scenario
not passing
pp page.text
"\n\n\n\nLogout\n\nTest User (testuser)\n"
thats not good
why am i getting a logout?
actually thats probably all that is in user-area? thats perhaps the footer?
2 issues - hooshy not getting it - either scrap hsooshy or get it in there
selector of user-area - put in new class or something

#2 is done - put in studies class - can improve that later

 When I go to the "Study ListXXX" page
this step seems to pass even if page doesnt exist fyi

so 2 issues - go to page - and getting study into page
also 3rd issue - i dont think studies should be in login

 No mocked service response found for '/api/v2/users/fake-uuid/studies.xml' (Dupe::Network::RequestNotFoundError)
we have to at least mock empty studies

When /^I go to the "([^"]*)" page$/ do |page_name|
  visit "/"

we are passing i think we are ready to show to ugandhar and ben and rest
first need to clean it up

lets push it - and comment on it
and rebase it - hopefully that will go ok

cleaned & pushed
need to rebase
write up in hip chat

thurs 2/23 dorrington
lets make a branch of the branch in case rebase goes bad
rebase
oh actually maybe make a table out of the studies
also should there be more scenarios?
lets look at balance haml tables

from view/studies/index.html.haml
          %table#study_list
            %tr
              %th(width="1%")= t('studies.index.header.live')
              %th= t('studies.index.header.name') 
              %th(width="13%")= t('studies.index.header.study_group')
              %th(width="5%")= t('studies.index.header.subjects') 
              %th(width="5%")= t('studies.index.header.sites') 
              %th(width="20%")= t('studies.index.header.report') 

              - if @studies.length == 0
                %tr(class = 'even')
                  %td(colspan=10)
                    .zero_case
                      - if @user_studies.length == 0
                        .text_bold= t('studies.index.zero_case1')
                        .text= t('studies.index.zero_case2')
                      - else
                        .text= t('studies.index.no_matched_studies')

            - @studies.each do |study| 
              - class_name = cycle('even', 'odd')
              - can_design_study = User.current.role_for_study(study).permission_set.can_design_study?
              
              %tr(class = "#{class_name}")[study]
                %td.live= image_tag( "b_check.gif", :alt => "checkmark" ) if study.live?
                %td.name
                  - if can_design_study && !study.live?
                    - study_link = edit_study_randomization_design_path(study,study.study_design.id)
                  - else
                    - study_link = study_sites_path(study)

                  = link_to(study.name,study_link)
                %td= h study.study_group_name
                %td.subject_count{:onclick => "document.location='"+study_subjects_path(study)+"'"}
                  = link_to(study.subjects.length.to_s,study_subjects_path(study), :onclick => "event.cancelBubble=true")
                %td.site_count{:onclick => "document.location='"+study_sites_path(study)+"'"}
                  = link_to(t('.sites_link'), study_sites_path(study), :onclick => "event.cancelBubble=true" )
                %td.configuration_report
                  = link_to(image_tag( "i_Reader_16.gif", :alt => "pdf icon" ), configuration_report_study_study_designs_path(study, :format => "pdf")) if can_design_study
        = @pager

<table border="1">
<tr>
<th>Header 1</th>
<th>Header 2</th>
</tr>
<tr>
<td>row 1, cell 1</td>
<td>row 1, cell 2</td>
</tr>
<tr>
<td>row 2, cell 1</td>
<td>row 2, cell 2</td>
</tr>
</table>

ok table is in
now dup branch
then rebase
push
pr


http://book.git-scm.com/4_rebasing.html
git checkout mywork
$ git rebase origin

git checkout develop
git pull origin develop
git checkout feature/study-index
git rebase develop


git rebase develop
First, rewinding head to replay your work on top of it...
Applying: though i had already changed this in last pr/branch
Using index info to reconstruct a base tree...
Falling back to patching base and 3-way merge...
Auto-merging Gemfile.lock
CONFLICT (content): Merge conflict in Gemfile.lock
Auto-merging Gemfile
CONFLICT (content): Merge conflict in Gemfile
Failed to merge in the changes.
Patch failed at 0001 though i had already changed this in last pr/branch

When you have resolved this problem run "git rebase --continue".
If you would prefer to skip this patch, instead run "git rebase --skip".
To check out the original branch and stop rebasing run "git rebase --abort".

In the process of the rebase, it may discover conflicts. In that case it will stop and allow you to fix the conflicts; after fixing conflicts, use "git-add" to update the index with those contents, and then, instead of running git-commit, just run

$ git rebase --continue

 git add Gemfile
 ~/i ((no branch)) $ git add Gemfile.lock
 ~/i ((no branch)) $ git rebase --continue
Applying: though i had already changed this in last pr/branch
No changes - did you forget to use 'git add'?
If there is nothing left to stage, chances are that something else
already introduced the same changes; you might want to skip this patch.

When you have resolved this problem run "git rebase --continue".
If you would prefer to skip this patch, instead run "git rebase --skip".
To check out the original branch and stop rebasing run "git rebase --abort".

vpn - nj - 1Lg!
thats whats killing things

well vpn solved all probs - mauth_signer, shamus... - except medidata_helper???
but i think its an access issue
this is a bummer it leaves me hosed
maybe comment out helper stuff  run cukes
maybe ugandhar can email me the gem?

cool everything passes after rebase!

dam i wonder if shouldve pushed after rebase
dont understand why i get this dam message
pb
To git@github.com:mdsol/iir.git
 ! [rejected]        HEAD -> feature/study-index (non-fast-forward)
error: failed to push some refs to 'git@github.com:mdsol/iir.git'
To prevent you from losing history, non-fast-forward updates were rejected
Merge the remote changes (e.g. 'git pull') before pushing again.  See the
'Note about fast-forwards' section of 'git push --help' for details.
dev already up to date
do i need to rebase with origin? no that makes no sense

i think it doesnt like that the branch is already pushed out there

  When an update changes a branch (or more in general, a ref) that used to point at commit A to point at another commit B, it is
       called a fast-forward update if and only if B is a descendant of A.

       In a fast-forward update from A to B, the set of commits that the original commit A built on top of is a subset of the commits the
       new commit B builds on top of. Hence, it does not lose any history.

       In contrast, a non-fast-forward update will lose history. For example, suppose you and somebody else started at the same commit X,
       and you built a history leading to commit B while the other person built a history leading to commit A. The history looks like this:

                 B
                /
            ---X---A

       Further suppose that the other person already pushed changes leading to A back to the original repository you two obtained the
       original commit X.

2 alternative solutions:
       You can perform "git pull", resolve potential conflicts, and "git push" the result. A "git pull" will create a merge commit C
       between commits A and B.

                 B---C
                /   /
            ---X---A

       Updating A with the resulting merge commit will fast-forward and your push will be accepted.

       Alternatively, you can rebase your change between X and B on top of A, with "git pull --rebase", and push the result back. The
       rebase will create a new commit D that builds the change between X and B on top of A.

                 B   D
                /   /
            ---X---A

lets try git pull --rebase
im gonna make a 3rd branch just in case

3rd alternative:
     There is another common situation where you may encounter non-fast-forward rejection when you try to push, and it is possible even
       when you are pushing into a repository nobody else pushes into. After you push commit A yourself (in the first picture in this
       section), replace it with "git commit --amend" to produce commit B, and you try to push it out, because forgot that you have pushed
       A out already. In such a case, and only if you are certain that nobody in the meantime fetched your earlier commit A (and started
       building on top of it), you can run "git push --force" to overwrite it. In other words, "git push --force" is a method reserved for
       a case where you do mean to lose history.



 git branch feature/study-index3 is post rebase
study-index2 is pre rebase

i think git push --force would actually be fine in this case
though i am curious what git pull --rebase will do ??

woops tudyindex3 made from develop my mistake
lets make studyindex4

ok did git pull --rebase
and cucs pass
~/i (feature/study-index) $ git pull --rebase
remote: Counting objects: 295, done.
remote: Compressing objects: 100% (138/138), done.
remote: Total 214 (delta 100), reused 169 (delta 56)
Receiving objects: 100% (214/214), 53.71 KiB, done.
Resolving deltas: 100% (100/100), completed with 25 local objects.
From github.com:mdsol/iir
   5d1111b..40c4920  develop    -> origin/develop
 * [new branch]      feature/shamus_setup -> origin/feature/shamus_setup
 * [new branch]      footer     -> origin/footer
 * [new branch]      iir_header_rebased_with_develop -> origin/iir_header_rebased_with_develop
 * [new branch]      iir_header_setup -> origin/iir_header_setup
 * [new branch]      medidata_help -> origin/medidata_help
 * [new branch]      medidata_logo -> origin/medidata_logo
You asked me to pull without telling me which branch you
want to rebase against, and 'branch.feature/study-index.merge' in
your configuration file does not tell me, either. Please
specify which branch you want to use on the command line and
try again (e.g. 'git pull <repository> <refspec>').
See git-pull(1) for details.

If you often rebase against the same branch, you may want to
use something like the following in your configuration file:
    [branch "feature/study-index"]
    remote = <nickname>
    merge = <remote-ref>
    rebase = true

    [remote "<nickname>"]
    url = <url>
    fetch = <refspec>

See git-config(1) for details.

i think it worked

next time i should just try git push --force

dam pb is still rejected - incredible
pb
To git@github.com:mdsol/iir.git
 ! [rejected]        HEAD -> feature/study-index (non-fast-forward)
error: failed to push some refs to 'git@github.com:mdsol/iir.git'
To prevent you from losing history, non-fast-forward updates were rejected
Merge the remote changes (e.g. 'git pull') before pushing again.  See the
'Note about fast-forwards' section of 'git push --help' for details.

thats wierd 
lets just do git push --force

git push --force
Counting objects: 51, done.
Delta compression using up to 8 threads.
Compressing objects: 100% (27/27), done.
Writing objects: 100% (33/33), 5.04 KiB, done.
Total 33 (delta 10), reused 0 (delta 0)
To git@github.com:mdsol/iir.git
 + 7bf47cd...25d27ce feature/study-index -> feature/study-index (forced update)
 ~/i (feature/study-index) $ pb
Everything up-to-date

that did it

oh my i see an issue
doing .xml in user.rb self.find_user
but i think mauth active resource is using .json
this will come out once we can test it out with real mauth

ok on to the next task

Navigate to list page from top navigation

should feature go in page.feature?
wait a second - i think navigation is a different cookie than the header
lets look at balance

yes 
general/navigation.feature
# These scenarios describe and test the links that are available based on the current page
# and if the links are functioning as expected for:
#   * The main navigation bar
#   * The sub navigation (tab) bar

Feature: Navigation (General-Navigation)
  In order to access the site content
  As a user
  I want to be able to quickly and easily access the content I need

  Background:
    Given a study exists with name: "Test Study 1"
    And a medidata user exists with login: "testuser"
    And "testuser" has access to study "Test Study 1" as a "System Administrator"
    And I am logged into Balance as "testuser"
    And a study exists with name: "Role Test Study 1"
    And a medidata user exists with login: "roletestuser"

  @Release2011.4.0
  @PB049-001
  @Validation
  Scenario: Clicking the Study List link should take the user to the Study List page.
    When I follow "Study List"
    Then I should be on the studies list page
    And I should see "Study List"

wo totally wierd
cuc is passin if i just say cuc
but if i give a file name then it doesnt find steps
passes with feature dir
but not on feature/general

cucmber.yml file where is that
i think grigory messed up cuc.yml

yup
#std_opts = "-r features/support/env.rb -r features/step_definitions --format #{ENV['CUCUMBER_FORMAT'] || 'pretty'} --strict --tags ~@wip"
std_opts = "--format #{ENV['CUCUMBER_FORMAT'] || 'pretty'} --strict --tags ~@wip"
%>
for some reason grigory took out -r feature/step_definitions ??

so the scenario falsley passes
 When I follow "Study List" do i have a Study List?

cos i had wip there

i should really get balance fully installed
so i can run features and see where their steps are defined

im not sure visit should be at end of logged in - lets see what balance does

  Background:
    Given a study exists with name: "Test Study 1"
    And a medidata_study_group exists with name: "Test Study Group"
    And a medidata_study exists with name: "Test Study 2", parent: "Test Study Group"
    And a study exists with medidata: "Test Study 2"
    And a medidata user exists with login: "testuser"
    And "testuser" has access to study "Test Study 1" as a "System Administrator"
    And "testuser" has access to study "Test Study 2" as a "Primary Investigator"
    And I am logged into Balance as "testuser"

yup - balance does visit at end of login
Given(/^I am(?: currently)? logged in(?:to Balance)? as "([^\"]*)"$/) do |login|
  Capybara.current_session.reset!
  @current_user = MedidataUser.find(:first, :conditions => {:login => login})
  CASClient::Frameworks::Rails::Filter.fake(@current_user.login, { :user_id => @current_user.id })
  visit "/studies"

i think this comes from pickle - not obvious step for it in sd
need to get balance up and running proper
    And a medidata user exists with login: "testuser"
so then can run feature and see what step its calling

need balance db
i think iwas in the middle of redis
Redis is an open source, advanced key-value store. It is often referred to as a data structure server since keys can contain strings, hashes, lists, sets and sorted ...

rm /Applications/Firefox.app/Contents/MacOS/libsqlite3.dylib
doesnt exist but there is a libmozsqlite3.dylib which i wonder if i should be removing
probably

cool balance cucumber now running!

And a medidata user exists with login: "testuser" # features/step_definitions/pickle_steps.rb:4

yes its pickle - we need to dupe it

# this file generated by script/generate pickle
# create a model
Given(/^#{capture_model} exists?(?: with #{capture_fields})?$/) do |name, fields|
  create_model(name, fields)
end
And a medidata user exists with login: "testuser"


ben approves - lets do pickle-dupe!
1st need to really understand what pickle does

  gem 'pickle'
  gem 'pickle-dupe'

ok selenium is in! env.rb and base.rb need to be merged cleaned up

gems are in
lets use them
In order to use pickle with dupe, you need to add :dupe to your pickle’s configuration as follows:

Pickle.configure do |config|
  config.adapters = [:dupe]
end
where does that happen??
in base.rb


rails g pickle --help
Usage:
  rails generate pickle [options]

Options:
  [--paths]  # Generate features/support/paths.rb file.
  [--email]  # Generate features/step_definitions/email_steps.rb file

Runtime options:
  -f, [--force]    # Overwrite files that already exist
  -p, [--pretend]  # Run but do not make any changes
  -q, [--quiet]    # Supress status output
  -s, [--skip]     # Skip files that already exist

Generates Pickle step files.

rails generate pickle --paths --email
rails generate pickle --paths --email
features/support/paths.rb not found, is your cucumber up to date?

chat w ben - not using paths

rails generate pickle --email

rails generate pickle --email
       exist  features/step_definitions
       exist  features/support
      create  features/step_definitions/pickle_steps.rb
      create  features/support/pickle.rb
      create  features/step_definitions/email_steps.rb
      create  features/support/email.rb

base.rb

require 'pickle/world'
require 'pickle'
require 'features/support/pickle_adapter'
require 'features/support/pickle'

thats balance rails 2 i think


In: features/support/pickle.rb

require 'pickle/world'

Pickle.configure do |config|
  config.adapters = [:machinist, :active_record, YourOwnAdapterClass]
  config.map 'me', 'myself', 'my', 'I', :to => 'user: "me"'
end
Out of the box pickle looks for machinist, factory-girl, then uses the ORM(s) that you’re using to create models.

If you find that your steps aren’t working with your factories, it’s probably the case that your factory setup is not being included in your cucumber environment (see comments above regarding machinist and factory-girl).


Using the default profile...
undefined local variable or method `capture_email' for main:Object (NameError)
/Users/magibson/projects/iir/features/step_definitions/email_steps.rb:21:in `<top (required)>'

not using email at this point anyways - take it out i guess

Using the default profile...
undefined local variable or method `capture_model' for main:Object (NameError)

shit - its not taking

Pickle-dupe requires the following gems

pickle 0.2.1 github.com/ianwhite/pickle
dupe 0.5.1 github.com/moonmaster9000/dupe/

those are old versions - does it not work with more recent versions 
i guess change bundle game file and see if it works
iawgens is not contactable - pickle pickle-dupe dude

still didnt work
i think i should throw in the towel for now on pickle


require 'active_support'
require 'pickle/version'
require 'pickle/adapter'
require 'pickle/config'
require 'pickle/parser'
require 'pickle/session'
require 'pickle/session/parser'


my fiddling with gemfile i think messed things


email rack_mauth.yml file


mon 2/27 - tcom from brooklyn jet lag
nned to commit these notes to git end of day

ok so throwing in the towel with pickle at the moment - 
maybe will have ugandhar help out with that

so lets just dupe up the refactor with no pickle for now


You asked me to pull without telling me which branch you
want to rebase against, and 'branch.feature/study-index.merge' in
your configuration file does not tell me, either. Please
specify which branch you want to use on the command line and
try again (e.g. 'git pull <repository> <refspec>').
See git-pull(1) for details.

wow! missed that - silly goose

so rebase prob wouldve worked

from pr ben discussion:

This is looking a little ugly. Can we refactor this a little? Maybe make some methods in the step file like

  def register_user
    ..
  end

  def register_study
  ...
  end
Registration of studies should be done in another step.

  Given a study exists with name: "ABC-123"
  And user "Fred Jones" is an Investigator for study "ABC-123"
 magibson repo collab 3 days ago 
Edit
Delete
agreed - oh i get it - so the key is the study step HAS to happen first - thats what i was missing
i was trying to separate and putting the study step second and then the login step was failing
because the visit / at the end of login step was hit stuy controller which expected some mock of study
will refactor

oh and the new gems seem to screw everything up - wierd!
lets go back to old gems lock file

    Given I am logged in as "testuser" with name "Test User" # features/step_definitions/session_steps.rb:3
      wrong number of arguments (2 for 3) (ArgumentError)
      ./features/step_definitions/session_steps.rb:22:in `/^I am logged in as "([^\"]*)" with name "([^\"]*)"$/'
      features/study/list.feature:12:in `Given I am logged in as "testuser" with name "Test User"'

how do i revert the gemfile lock?

gitx discard is 1 way


Using the default profile...
You have already activated gherkin 2.9.0, but your Gemfile requires gherkin 2.7.6. Using bundle exec may solve this. (Gem::LoadError)

what the fuck is going on?

phew
needed to do a clean gemset - clean out old crap
and now it works
wacky
wierd apparently some call has changed in new gem
no need to figure that out now
i wonder how releated this was to putting in pickle? and the version stuff there
and dupe-pickle
and related to why dupe-pickle wouldnt work??


Given /^the library has lots of books$/ do
  Dupe.create :book, :name => "Rooby Rocks", :author => (Dupe.create :author, :name => 'Matz')
  Dupe.create :book, :name => "Rails Rocks too!", :author => (Dupe.create :author, :name => 'DHH')
end

stay focused
so user already created i think?
just need to add study to existing user
user has login & name already
querying by name i think?


imedidata app uuid is really iir app uuid that has been assigned created by imedidata 
rename this!

john louis
needs public key for imed and iir
and appuuids
 
iir app uuid is
d38e7edc-5113-11e1-95fe-70cd60fffe66
imedidata app uuid seems to be
63566d60-4c62-11e1-b86c-0800200c9a66

ive got the private keys for these - where are the public keys
can just make up new keys though there is a specific way to do that

bring up on chat rewrite for mauth client ethan rewrite

public key is not on this computer!
just make new pairs

oh yes it is

https://sites.google.com/a/mdsol.com/knowledgebase/home/departments/engineering/on-demand-portfolio/services/core-services/mauth/generating-keypairs-for-mauth
tells how to make keys

Using OpenSSH to Generate Keypairs
The ssh-keygen utility (part of the OpenSSH package) is used to generate keypairs.  The following command will generate an appropriate keypair for use with MAuth or iMedidata:

ssh-keygen -t rsa -b 2048 -f myappkey

This will result in the private key being stored in the file named 'myappkey' and the public key being stored in 'myappkey.pub'.

ssh-keygen saves its public key in a different format, so the public key must be transformed to a PEM format using the following command:

ssh-keygen -f myappkey.pub -e -m pem


ssh-keygen -t rsa -b 2048 -f local_imedidata
ssh-keygen -f local_imedidata.pub -e -m pem

no no no
the iir key isnt at all the same
lets just make a new one
should prob keep the public somewhere?

michael dug up the imed keys

gonna make new iir keys then
need to make a new branch for this

ssh-keygen -t rsa -b 2048 -f local_iir
ssh-keygen -f local_iir.pub -e -m pem 
or to file
ssh-keygen -f local_iir.pub -e -m pem > local_iir.pub.pem

ok need to start a new branch just for the new key

im ediat does need to change - as baseurl needs to be innovate
need to reremember how to change 

dam yaml file needs indenting
space indenting


i think im gonna merge matuh.yml with cloud.yml
actually scracth it - its all gonna change with mauth client - 
maybe can do that today

actually its imedidata not iir that hooks to sand/inn/mauth
iir just goes to imedidata


2 options
i modify it in place ?? and commit it
or modify imeidata branch checkout
dont really have imedidata setup
its such a small change
lets do it in place
i think we have to check out the branch first


If you want to make a change within a submodule and you have a detached head, then you should create or checkout a branch, make your changes, publish the change within the submodule, and then update the superproject to reference the new commit:

$ git checkout master
or

$ git checkout -b fix-up

then

$ echo "adding a line again" >> a.txt
$ git commit -a -m "Updated the submodule from within the superproject."
$ git push
$ cd ..
$ git diff
diff --git a/a b/a
index d266b98..261dfac 160000
--- a/a
+++ b/a
@@ -1 +1 @@
-Subproject commit d266b9873ad50488163457f025db7cdd9683d88b
+Subproject commit 261dfac35cb99d380eb966e102c1197139f7fa24
$ git add a
$ git commit -m "Updated submodule a."
$ git push
You have to run git submodule update after git pull if you want to update submodules, too.

hmmmm
git checkout feature/support_mauth
how do you checkout a remote branch??

git checkout feature/support_mauth
Branch feature/support_mauth set up to track remote branch feature/support_mauth from origin.
Switched to a new branch 'feature/support_mauth'

git pull origin feature/support_mauth
remote: Counting objects: 7, done.
remote: Compressing objects: 100% (1/1), done.
remote: Total 4 (delta 3), reused 4 (delta 3)
Unpacking objects: 100% (4/4), done.
From github.com:mdsol/imedidata
 * branch            feature/support_mauth -> FETCH_HEAD
Updating e0662bd..3bda320
Fast-forward

 config/rack_mauth.yml |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)
 ~/i/vendor/apps/imedidata (feature/support_mauth) $ git pull origin feature/support_mauth
From github.com:mdsol/imedidata
 * branch            feature/support_mauth -> FETCH_HEAD
Already up-to-date.


wo! already points to 
    :mauth_baseurl: https://mauth-innovate.imedidata.com
michael mustve done that

so just need to point to latest version really

3bda320cf0 is the new michale version

~/projects/iir (feature/mauth-key) $ git submodule status
 f5bdd2809b3610065a642650bd460dbb22915921 vendor/apps/authmedidata (release2011.2.0.2)
+3bda320cf05b0b6a00d9d673891c9719d3f2735b vendor/apps/imedidata (release2011.1.6-213-g3bda320)
 75d741453f54c3a9c45368e8edf69732e969363c vendor/plugins/rubycas-client (remotes/origin/session_stores)

ok got it

follow steps above
 ~/projects/iir (feature/mauth-key) $ gd
# On branch feature/mauth-key
# Changes not staged for commit:
#   (use "git add <file>..." to update what will be committed)
#   (use "git checkout -- <file>..." to discard changes in working directory)
#   (commit or discard the untracked or modified content in submodules)
#
#	modified:   vendor/apps/imedidata (new commits, untracked content)
#
no changes added to commit (use "git add" and/or "git commit -a")
diff --git a/vendor/apps/imedidata b/vendor/apps/imedidata
index e0662bd..3bda320 160000
--- a/vendor/apps/imedidata
+++ b/vendor/apps/imedidata
@@ -1 +1 @@
-Subproject commit e0662bd1264da8feea09b79ecf0f2d4387078362
+Subproject commit 3bda320cf05b0b6a00d9d673891c9719d3f2735b-dirty

git add vendor/apps/imedidata/
git commit -m "

########
move these to new
in a hurry
2/28 tues office

ok what now
need try running!

wierd - need to_s in oh i get it - because using string not # in test - bad test!
    full_path = IMEDIDATA_API_PATH + "users/" + user_uuid.to_s + ".xml" # .json/.xml ?
user.rb - user_uuid

 git pull origin feature/support_mauth



2/29/12 wed tcom brooklyn
ok i need to clean up the mess from yesterday
i think theres a debugger now in 

git pull --rebase origin feature/mauth-key

 git pull --rebase origin feature/mauth-key
remote: Counting objects: 24, done.
remote: Compressing objects: 100% (7/7), done.
remote: Total 16 (delta 8), reused 13 (delta 5)
Unpacking objects: 100% (16/16), done.
From github.com:mdsol/iir
 * branch            feature/mauth-key -> FETCH_HEAD
First, rewinding head to replay your work on top of it...
Applying: gem file lock for bundle install from ugandhars new stuff

it worked!
pb - works!

cuc is probably all broken
yes it is

fix cuc

it runs against mauth innovate still!

need to get cuc working again

need to issue directions on getting submodule updated for ben & grigory

  CASClient::Frameworks::Rails::Filter.fake(login, { :full_name => full_name, :user_id => @current_user.uuid.to_s, :user_uuid => @current_user.uuid.to_s })
got it - mock in the cas client thing

oh also cas client should NOT be a plugin but a gem	


  And I am logged in as "testuser" with name "Test User"     # features/step_definitions/session_steps.rb:7
      No mocked service response found for '/api/v2/users/fake-uuid.json' (Dupe::Network::RequestNotFoundError)
      ./app/models/user.rb:27:in `find_user'
      ./app/controllers/application_controller.rb:28:in `get_current_user'
      ./features/step_definitions/session_steps.rb:14:in `/^I am logged in as "([^\"]*)" with name "([^\"]*)"$/'
      features/study/list.feature:15:in `And I am logged in as "testuser" with name "Test User"'

oh its the .json - dupe doesnt do .json

dam broke live and scenario still not passing going from json to xml
argh so tedious

hmm - it works with old code - can connect to mauth and all from here

need to move mauth signer back!! to lib

i think we need to try this with curl??
and see if .xml even works with imedidata - i would think it would but never tried it

to curl hmmmmm dont think i have the curler on here
and i think ethan has new stuff with that

hmm got go ahead from ben on puttin json into dupe
so maybe i should pough ahead with that?

it seems imedidata isnt responding to xml

NoMethodError (undefined method `collect!' for #<Hash:0x00000100baea18>):
13:07:40 iir.1           |   app/models/user.rb:45:in `studies'
13:07:40 iir.1           |   app/controllers/investigator/studies_controller.rb:6:in `index'

this may be whats returned when you authenticate but dont return data - not sure
and it might be imedidata doesnt return data xml for users



ok lets fork dupe and take a look
*****



*****
3/2 to 3/9 worked on gwt api explorer - see notes for that

*****
3/12/12 monday office
back to iir

need to get mauth client in there

from michael from ethan

---------- Forwarded message ----------
From: Ethan Thiel <ethiel@mdsol.com>
Date: Fri, Feb 17, 2012 at 5:55 PM
Subject: mauth-client
To: Michael West <mwest@mdsol.com>


-gem 'rack-mauth', :git => "git@github.com:mdsol/rack-mauth.git", :ref => 'd8ced6e'
-gem 'mauth_signer', :git => 'git@github.com:mdsol/mauth_signer.git', :ref => '933a834'
+gem 'mauth-client', :git => 'git@github.com:mdsol/mauth-client.git', :ref => '495a38e'

mauth-client's ref will change from :ref => '495a38e' to :tag => 'v2.0.0' when mauth-client is released. 

replace your invocation of Medidata::MAuthMiddleware with the exact same invocation of MAuth::Rack::RequestAuthenticator. if you were using symbolize_keys you no longer need to, if not, that's fine too. for me that was essentially:
-    use Medidata::MAuthMiddleware, Eureka.mauth_config
+    use MAuth::Rack::RequestAuthenticator, Eureka.mauth_config

signing your responses is also a good thing to add, so add a corresponding middleware of MAuth::Rack::ResponseSigner. DON'T do this unless you have a private key and app_uuid (but I'm sure imedidata is using this) 
+    use MAuth::Rack::ResponseSigner, Eureka.mauth_config


well im simultaneously looking into disaboing mauth
what does balance do
from hipchat
do you know how balance does what they do - i guess i should look at the balance code and see what @ben is talking about
Madalina T.
11:05 AM
not sure how balance works around this if at all it does but we don't write custom code in imedidata to accomodate clients development or test environments
Mark G.
11:05 AM
as clearly i dont have an understanding
k
Ben Y.
11:06 AM
# renders a 404 if there is no request token, or an expiry notice if the token has expired 
def api_authenticate
  unless RAILS_ENV == "development" || RAILS_ENV == "performance"
    @request_token = RequestToken.find_by_token(PRIVATE_KEY.private_decrypt(Base64::decode64(params.delete(:RequestToken))))

    render :nothing => true, :status => 404 and return if @request_token.blank?
    render :text => "The token has expired." and return if @request_token.expired?
  end
end

Hide full text
in lib/api_authentication.rb
We disable in performance because Teo's testing tools do not support token security (or any form of encryption)
What we should do is have a config option
that can be set in a yml file
and then it's at the discretion of the consumer to disable/enable it as needed.
Mark G.
11:16 AM
vendor/apps/imedidata/db/bootstrap.rb
4:require 'fakeweb' if RAILS_ENV == "test" || RAILS_ENV == "development" 
with @yi s help
found the above in balance
so i think combinig the 2
Mark G.
11:17 AM
that in dev request tokens arent sent and perhaps fakeweb is actually used for some requests? is that true? this is balance imedidata submodule


ok mauth client
ethan gchat conv:

Ethan:  this is weird
 me:  what is this?
 Ethan:  not sure, but something in how mauth headers are set here
it may be weirdness in the way ares does things
you set headers on the class?
 me:  youre looking at iir i take it
 Ethan:  like, User.headers['x-mws-time'] ?
yeah
 me:  oh yea its crappy for now
was gonna change it
but we figured its all gonna change with eureka anyways
so lazily left it til eureka
 Ethan:  yeah, but that's going to break horribly if ...
no, wait
rails isn't multithreaded, is it?
 me:  oh in going to mauth client i see
 Ethan:  cause that'd break it certainly
nah, going to mauth client shouldn't change things a lot
I'm just finding this pattern of setting headers on the class to set them on the request very weird
 me:  what would break what?
whats the alternative - call me clueless
 Ethan:  I don't know, I didn't say I had an alternative
I just said it's weird
 me:  well youre wierd
 Ethan:  and not thread safe, but maybe that doesn't matter
 me:  
so i know threads in java - i dont know thread in rails
 Ethan:  I mean, it's conceptually the same as using a global variable for your request headers
 me:  so why isnt this thread safe?
 Ethan:  because User.headers is on the class and the class is shared across all threads
 me:  mauth_headers = MAUTH_SIGNER.signed_request_headers(:app_uuid => IIR_APP_UUID,
                            :request_url => path, :verb => verb)
   mauth_headers.each {|k,v| resource.headers[k] = v}
are you talking about the above code
 Ethan:  no
the resource.headers part
resource.headers[k] = v
resource is User
so User.headers is shared across all threads
 me:  oh
well to be honest i wasnt sure how else to do this
but right
 Ethan:  so if two simultaneous requests are made on the User model, they may get the wrong headers
 me:  so you are saying it could end up setting it across all requests/threads that are flowing through
right
because its User class not user instance right?
and User class cuts across threads

Ethan:  yes
 me:  well that aint no good
 Ethan:  now (1) I don't think it's a problem because rails isn't multi-threaded (I think?) (2) I don't know the right way to do it, or even if there is a right way to do it with ares
so maybe just say fuck it
 me:  MauthSigner.set_mauth_headers(self,full_path)
right theres the call
rails isnt multi threaded???
 Ethan:  nope
 me:  so how does rails handle multpile requests coming in?
 Ethan:  um
sequentially
one at a time
 me:  how the hell does that scale?
 Ethan:  not well
you spin up more rails processes
and put them behind a load balancer
but each individual one handles requests one at a time
 me:  is taht what imed does?
 Ethan:  that's what all our apps do
 me:  multi threading seems like a basic to me - shocking
 Ethan:  I am inclined to agree
 me:  maybe rails 4
so even rails 3 isnt multi?
 Ethan:  I don't think so
I'm not sure
 me:  well thats one of the few things java/servlets got right
well good to know
so right then no threading issue and ok to do User header
i guess thats why ares does it that way
 Ethan:  I mean, I know it was totally broken before, and they "fixed" rails multithreading by sticking one big mutex around requests.
well, no, I think we're just abusing ares' header stuff
 me:  i was a little surpised it was a class method
 Ethan:  I don't think it's intended for mauth-type stuff
 me:  oh well maybe theres another way to do this - this was the way i found - and it took a little digging
 Ethan:  it's for headers that you set once at the beginning and apply to every request
 me:  oh i see - so what im doing is not what they intended it for
woops
yea i dont know how ares does headers on instances - will have to look into that
 Sent at 11:52 AM on Monday
 Ethan:  I think rodrigo did something related to this
let me see if I can find it
 me:  oh he does that other project you referenced once which i forget the name - agi something ?
 Ethan:  yeah, agifog
not to be confused with agi, which is different
or fog, which is different
or fogagi which ... no, I just made that one up.
 me:  what is agifog anyways?
 oh wait, it's in agi, not agifog
here we are
https://github.com/jbz/agi/blob/master/lib/active_resource/extend/mauth_signer.rb

lets open a new branch 
first pull from dev

here we are
https://github.com/jbz/agi/blob/master/lib/active_resource/extend/mauth_signer.rb
 Sent at 12:00 PM on Monday
 Ethan:  hmm. now I'm not so sure. rails itself has allegedly been thread-safe since 2.2
which I buy
but I'm not sure if things actually take advantage and make multiple simultaneous requests of a rails process
I'm having trouble finding anything on that
 me:  hmm insteresting
 Ethan:  anyway! doing things in a thread-unsafe manner is generally not preferable
so if you can fix your ares usage with the patch that agi uses, that'd be cool
 me:  right - need to fix this

imitate agi!

dev
pdev
make-branch feature/mauth-client

maybe 1st refacotr for agi way??
1st lets see if works

dam the non killable ness
;lets try to fix that in another branch - its so annoying



foreman went from 0.36.1 to 0.40.0 on feb 29
lock on 0.36.1!

https://sites.google.com/a/mdsol.com/knowledgebase/home/departments/engineering/on-demand-portfolio/services/core-services/mauth/mauth-client

https://columbo-portal-current.s3.amazonaws.com/mauth/mauth-client-design/MAuth/Client.html

cuc test is no good well just tests if nothing major wrong with code
but it stubs out mauth so no real test at all



******
3/13/12 tues office
******

ok lets try the mauth refactor i guess if it doesnt work just abandon branch

https://github.com/jbz/agi/blob/master/lib/active_resource/extend/mauth_signer.rb

agi / lib / active_resource / extend / mauth_signer.rb

# Monkey Patch to hook Mauth Signer into ActiveResource
module ActiveResource #:nodoc:
  module Extend
    module MauthSigner
       class ActiveResource::Connection
         # get request(:get, path, build_request_headers(headers, :get, self.site.merge(path)))
         # delete request(:delete, path, build_request_headers(headers, :delete, self.site.merge(path)))
         # put request(:put, path, body.to_s, build_request_headers(headers, :put, self.site.merge(path)))
         # post request(:post, path, body.to_s, build_request_headers(headers, :post, self.site.merge(path)))

         def request(method, path, *arguments)
           mauth_config = AppConfig["mauth"].symbolize_keys
           mauth_config[:private_key] = File.read(mauth_config[:private_key_file])
           mauth_signer = MAuth::Signer.new(mauth_config)

           mauth_params = {
             :verb => method.to_s.upcase,
             :request_url => URI.parse(path).path,
             :body => [:post, :put].include?(method) ? arguments.first : nil,
             :app_uuid => mauth_config[:app_uuid]
           }
           signed_headers = mauth_signer.signed_request_headers(mauth_params)

           arguments.last.update(signed_headers)

           # this is the original part
           result = ActiveSupport::Notifications.instrument("request.active_resource") do |payload|
             payload[:method]      = method
             payload[:request_uri] = "#{site.scheme}://#{site.host}:#{site.port}#{path}"
             payload[:result]      = http.send(method, path, *arguments)
           end
           handle_response(result)
         rescue Timeout::Error => e
           raise TimeoutError.new(e.message)
         rescue OpenSSL::SSL::SSLError => e
           raise SSLError.new(e.message)
         end
       end
     end
  end
end


 ~/projects/agi (master) $ ack MauthSigner
app/models/rds_parameter_group.rb
2:  include ActiveResource::Extend::MauthSigner if AppConfig["mauth"]["enable_mauth"]

app/models/rds_security_group.rb
2:  include ActiveResource::Extend::MauthSigner if AppConfig["mauth"]["enable_mauth"]

app/models/rds_server.rb
2:  include ActiveResource::Extend::MauthSigner if AppConfig["mauth"]["enable_mauth"]

lib/active_resource/extend/mauth_signer.rb
4:    module MauthSigner


uninitialized constant ActiveResource::Extend

application.rb
    # Custom directories with classes and modules you want to be autoloadable.
    config.autoload_paths += %W(#{config.root}/lib)

hmmmmm
not sure how to include something deep in lib?

from ugandhar to steal a study - 

mysql-iir

update studies set parent_id = 5 where id = 4;
update study_invitations set root_study_group_id = 5 where study_id = 4;
update app_assignments set root_study_group_id = 5 where study_id = 4;
update app_assignments set app_id = 3 where study_id = 4;


******************
3/14/12 wed office
******************

ok need to respond to ethans comments


18
down vote
accepted
A method "def" can serve as a "begin" statement:

def foo
  ...
rescue
  ...
end


ok NEW sprint
############
SPRINT 6
3/14/12 wed
############


*************
3/15/12
thurs 
office
*************

kevin showed me qpl - not working on now but should write up

login-imedidata.com url
kevinshroff  Password123

scrool down GM QuickPrice - GM Worldwide

indication 
type in "heart"

drop down group by
Therapuetic aread eg "CARDIOVASCULAR" 
green shading on mouse over

git checking out from remote
http://stackoverflow.com/questions/67699/how-do-i-clone-all-remote-branches-with-git
git checkout origin/experimental

If you have many remote branches that you want to fetch at once:

$ git remote update
$ git pull --all
Now you can checkout any branch as you need to, without hitting the remote repo.

To create a local branch based on a remote branch, do something like:
git checkout -b dev refs/remotes/origin/dev
Branch dev set up to track remote branch refs/remotes/origin/dev.
Switched to a new branch "dev"

In order to work on top of a specific remote branch, assuming it's the origin remote:
git checkout -b branch origin/branchname

gb -a
* develop
  feature/foreman-fix
  feature/imed-submod
  feature/init-rails
  feature/mauth-client
  feature/mauth-key
  feature/mauth-refactor
  feature/mauth-signer
  feature/more-setup
  feature/procfile-foreman-subcon
  feature/study-mauth
  master
  remotes/origin/budget_submodule
  remotes/origin/develop
  remotes/origin/feature/create_activity
  remotes/origin/feature/cucumber_setup
  remotes/origin/feature/foreman-fix
  remotes/origin/feature/header_scenarios_passing
  remotes/origin/feature/imed-submod
  remotes/origin/feature/init-rails
  remotes/origin/feature/mauth-client
  remotes/origin/feature/mauth-key
  remotes/origin/feature/mauth-refactor
  remotes/origin/feature/mauth-signer
  remotes/origin/feature/more-setup
  remotes/origin/feature/nav-to-list
  remotes/origin/feature/procfile-foreman-subcon
  remotes/origin/feature/shamus_setup
  remotes/origin/feature/study-index
  remotes/origin/feature/study-mauth
  remotes/origin/fix_submodule
  remotes/origin/footer
  remotes/origin/footer_ux
  remotes/origin/iir_header_rebased_with_develop
  remotes/origin/iir_header_setup
  remotes/origin/logout
  remotes/origin/master
  remotes/origin/medidata_help
  remotes/origin/medidata_logo
  remotes/origin/navigation_bar_iir


git checkout -b branch origin/branchname

git checkout -b feature/

oh wait this is a svc - oh no it isnt

git fetch
From github.com:mdsol/iir
   b839f63..7b7faee  develop    -> origin/develop
 * [new branch]      feature/dupe_post -> origin/feature/dupe_post
 * [new branch]      feature/show -> origin/feature/show
 * [new branch]      navigation_iir_complete -> origin/navigation_iir_complete
 * [new branch]      navigation_iir_test -> origin/navigation_iir_test
 * [new branch]      navigation_story -> origin/navigation_story
 * [new branch]      pr_missed_out_changes -> origin/pr_missed_out_changes

git checkout -b feature/dupe_post origin/feature/dupe_post

~/i (develop) $ git checkout -b feature/dupe_post origin/feature/dupe_post
M	vendor/apps/budgets_service
M	vendor/apps/imedidata
Branch feature/dupe_post set up to track remote branch feature/dupe_post from origin.
Switched to a new branch 'feature/dupe_post'
 ~/i (feature/dupe_post) $ 

worked!
lets run failing scenario

shes still on forem 0.4 - i should change that manually for now i guess? as it is a pain
though actually im not gonna use foreman just cuc

failing:
cu features/study/show.feature:31
alias test-create-budget

The document "{\"budget\":{\"initiating_user_uuid\":\"fake-uuid\",\"study_group_uuid\":\"fake_study_group_uuid\",\"study_uuid\":\"638637\"}}" does not have a valid root

yea its trying to xml that json


hmmm so how should i investigate - 
i am going to have to make changes to dupe
so should point to local dupe and then breakpoint that

  #gem 'dupe', :git => 'git@github.com:magibson/dupe.git'
  gem 'dupe', :path => '/Users/magibson/projects/dupe'

bundle install

i guess notes now switch over to dupe notes

ok back from dupe - dupe fixed for post and hopefully put to
in fact might be fixed in general except the automatice ares stuff which we dont use

i think its time to start slapping mauth on to the services
maybe start with budget since its ugandars

1st need to check it out and branch it
git@github.com:mdsol/budgets.git

hmmm theres the submodule and the full checkout

going with full checkout - submodules are silly
oh need to change ValidationFeature to Feature typo

ok so what needs doing 
can look at docs or look at imedidata branch


gem 'mauth-client', :git => "git@github.com:mdsol/mauth-client.git", :tag => 'v2.0.1'
bundle install

If adding to a Rails 3.x application, update your environment.rb file as follows:

Rails::Initializer.run do |config|
mauth_conf = YAML.load_file(File.join(Rails.root, "config", "mauth.yml"))[Rails.env]
if mauth_conf['private_key_file']
  mauth_conf['private_key'] = File.read(mauth_conf['private_key_file'])
end
  require 'mauth/rack'
  config.middleware.use MAuth::Rack::ResponseSigner, mauth_conf # OPTIONAL; only use if you are registered in mauth service
  config.middleware.use MAuth::Rack::RequestAuthenticator, mauth_conf
end


ssh-keygen -t rsa -b 2048 -f local_iir
ssh-keygen -f local_iir.pub -e -m pem 
or to file
ssh-keygen -f local_iir.pub -e -m pem > local_iir.pub.pem


ssh-keygen -f local_budget.pub -e -m pem > local_budget.pub.pem

ssh-keygen -f local_budget.pub -e -m pem > local_budget.pub.pem
ssh-keygen: illegal option -- m

ssh-keygen -f local_budget.pub -e pem > local_budget.pub.pem

ssh-keygen -t rsa -b 2048 -f local_budget
ssh-keygen -f local_budget.pub -e -m pem > local_budget.pub.pem

the pem doesnt work

  -E      This option will read a private or public OpenSSH RSAv2 key file
             and print the RSA public key in a PEM encoded format suitable for
             the openssl(1) command to stdout.

ssh-keygen -f local_budget.pub -E

ssh-keygen: illegal option -- E

hmmm diff versions of ssh keygen apparently

ah its just -e
 -e          Convert OpenSSH to RFC 4716 key file.
that must be a pem file

ssh-keygen -f local_budget.pub -e > local_budget.pub.pem

pd ~/fiddle/iir/reference
ssh-keygen -t rsa -b 2048 -f reference
ssh-keygen -f reference.pub -e > reference.pub.pem

pd ~/fiddle/iir/cost-analysis
ssh-keygen -t rsa -b 2048 -f cost-analysis
ssh-keygen -f cost-analysis.pub -e > cost-analysis.pub.pem

pd ~/fiddle/iir/activity
ssh-keygen -t rsa -b 2048 -f activity
ssh-keygen -f activity.pub -e > activity.pub.pem

keys are made 
lets contrive app uuids

config/mauth.yml
iir_app_uuid: d38e7edc-5113-11e1-95fe-70cd60fffe66

7-4-4-4-12
is format

iirdevt-xxxx-xxxx-xxxx-referencexxx
iirdevt-xxxx-xxxx-xxxx-costanalysis
iirdevt-xxxx-xxxx-xxxx-activityxxxx
iirdevt-xxxx-xxxx-xxxx-budgetxxxxxx


activity public key
---- BEGIN SSH2 PUBLIC KEY ----
Comment: "2048-bit RSA, converted from OpenSSH by magibson@qp1150wndnm.ad.mdsol.com"
AAAAB3NzaC1yc2EAAAABIwAAAQEAvixfDeHDo9NC2nP+C21KuvGvPDKDlob+rqlogwIOMU
J/JoCIr8kDg7TuQ1st44zqNXvEeo4f08v6eBR7qjY4FyU6/yhgXzkRGpld9jIfb9IVI1sT
YUurc+PJgiMwqaOzYZ9aW3q6Yu1N2+P2ME5ULKC4NqO4huBdSCS3bPm+qK4r1DwRBw6CgT
LSuyB/Ndta8NV6johPn5KKw2MzSxdS9FRB19nKNE3EqGPhkYyVZUy4kriARuW7wLG2OwJ5
GrXTB0SeTxEQpu1UKhjmgn9/erPAsOD8boLlc5ajKkGYZjMT7FPlL4wzm+bP4mSmILRsek
wTHGI2RVBmgVft/Rdt3w==
---- END SSH2 PUBLIC KEY ----

budget public key
---- BEGIN SSH2 PUBLIC KEY ----
Comment: "2048-bit RSA, converted from OpenSSH by magibson@qp1150wndnm.ad.mdsol.com"
AAAAB3NzaC1yc2EAAAABIwAAAQEAvXNI48PYUnofCqtVcKrtAdHT7ooJoak/TXxmK1mhfo
a9mr9LAYKzo1S7q362U2eIDVG0TiWeFi5iVPk+nddwHlGf8KoFaFSi1AGjos8W5FY5k/bh
Cp4wmUa2lz85AyHeL+1l93x72Dz5DJuEuo0f/nFWafrIe1Ve8XoXFAf68MApFjeo0MOoUD
WBmr00bp9PsVoUaBFrGMLrKjJ7JzAoCIny6OlSupgqjfefXW89ZQi2mcelWpcjaIpl3O2L
AlAQohtYHi//ywhPoaXYL0sdZlU2MdDlYiEUZOTSf7nE9wXCXUbJkIf3n1rw9WuiTwXN/Q
peAHH+NegQGnoVyQoL6w==
---- END SSH2 PUBLIC KEY ----

reference public key
---- BEGIN SSH2 PUBLIC KEY ----
Comment: "2048-bit RSA, converted from OpenSSH by magibson@qp1150wndnm.ad.mdsol.com"
AAAAB3NzaC1yc2EAAAABIwAAAQEAptUR6VeSUDwJhHDZQLXxROvmHh/QF9xH29gMUvtDVj
9LaZv4sbyemOZ2w8OuA21rkFVvKXlqQYIrmnurwfcBbL7MtS/FMNPc+nIkLgtotqeGIvR8
fMlVg8qmDbIi/mT5oQmO/zT/wzXmy3Kj4G6jP+VAiJIpvtpq2nkN/tClQLtG1/mhFeYT1T
xpwc/taYIli0vvC/b7XlKUW5MeosFFln1pqPusHgqCMfCda+y9GVw/pIfVvA3/KXotU4eV
tvQlZiF6EpLx2PXZWfhWeFq018Qsjlb0I+50NEoKg5cb+L652mlp2idh2AW/X+nwVm4Qo8
wcBha8bOv4/ndwNwifpQ==
---- END SSH2 PUBLIC KEY ----

cost-analysis public key
---- BEGIN SSH2 PUBLIC KEY ----
Comment: "2048-bit RSA, converted from OpenSSH by magibson@qp1150wndnm.ad.mdsol.com"
AAAAB3NzaC1yc2EAAAABIwAAAQEAyreDZLsJ7PUL1LNXxwz5HSA9W8X8B3aAeoPxE5HShr
Crix4lpj/ZGNVuZfJLAg+68sf05e2cg56rCmiU+Im9s+/hAEC3ZjyV437x25Q8nwF4F1Dx
AbTz3Qs+VIjwpdtzsg9CvUITHocUJrTErpWizHGKRPc3fU/+ohhj/ftbtTEGv4KqXXRVEQ
REcgKmxtTdBb2zMC3qamwBSXTVrtcMii9swN4RHTzWyP5oAypzZqWGNeXiPfrjnkl3hYk8
rPAZ7hzi7Zjzm0HRw/PeLnljS4REFwkcob2eoSISsGIVmjvGJLFaW8p5HY730SQkbv6LeL
DVrODyER/TzpYFMW+2GQ==
---- END SSH2 PUBLIC KEY ----


possible dummy app uuids - feel free to change or i can make more robust ones if you like:

iirdevt-xxxx-xxxx-xxxx-referencexxx
iirdevt-xxxx-xxxx-xxxx-costanalysis
iirdevt-xxxx-xxxx-xxxx-activityxxxx
iirdevt-xxxx-xxxx-xxxx-budgetxxxxxx


well who knows when john louis will have that ready
but might as well set it all up on the branch i guess


hmmmm - dont know where pub key is for old iir key



OLD from 2/27 email to john louis
hey johnlouis
what format do you prefer public keys in
these 2 are actually in 2 different formats - sorry - i can resend
however you like
the 1st one the email program broke up long lines - thats probably
going to be a problem
the 2nd one replaces new lines with \n
just let me know how you like em and ill resend
im guessing you might prefer the latter?
thanks for putthing this up!
cheers - mark
iir app_uuid
d38e7edc-5113-11e1-95fe-70cd60fffe66
iir mark local public key
-----BEGIN RSA PUBLIC KEY-----
MIIBCgKCAQEAy8uLxcS4BMStRiRRV+pDxujhaWJOQzM9kPOOHw7r80DVpbUUDpZF
aQdnUpDlIq3ptY8hVnEgLGKzCGlNeot/aWJh7s01CuAgTP1WhfILU7XhlXtbsuh+
+MlhDbkDQsEePcIOGzQCBQHHcxn+DBAwSbN5sNfpB/BQkmXmgXkbTgP8aNEQNr8y
wypmXYQ5zOnDBFPOBbcrhm4kfUzVtWbQ87ukAyQDsTh0/Tjf76xRf4mRB0VipPjj
tw7wFGULSckco1ZpnaTwb6NUJrXnI3l1eArPUBFAInrlNYOSYow/+vRG9/Cg0bhc
LmVpeKJSPw1PM65rqv0g5dbVO6PlfrDqAwIDAQAB
-----END RSA PUBLIC KEY-----
imedidata app uuid
63566d60-4c62-11e1-b86c-0800200c9a66
imedidata mark public key
-----BEGIN RSA PUBLIC
KEY-----\nMIIBCgKCAQEAtJQ15Qxju7lrXyXL8eRHQNa4KvG1Lief+reSwhVTAUTWqk1LRcZG\nh+fpu5IYG2LnL+nRiwBOirqTgsTt4EblTp7k8uzdawPg4Zfk7Y20OZ/F+LrQ/0JF\n2fGtdZvqyH4IY6GHtPvBEBZ5ERM5pJMMgk7WGp6ocNhpwwaE/ATAOTrnNAFtX2Mw\nQ5e0IihZYywM0iDuddBVI5pqtgE6WvJQ2KFk//9VZqYax2kxDOT/QSIJDQhtuP9R\nuc4Km+T8X27GVL6Vm1QX65wlOiVGGL67/FLuluDkBqIeUaNPYstFxBP8MEoHqhYf\n7D5vHV0JItLmnGTPn0p7fqx9rNtcvR2ERQIDAQAB\n-----END
RSA PUBLIC KEY-----\n
end of OLD email from 2/27

used same key pair it seems for both imed & iir
oh will have to do this for imed too - geez

ok iir will be broken now since john louis wiped out key
need to fix that up with new key
actually its a new system
need to fix it for me
and then tell others to set up their keys with john louis
lets 1st get it fixed for me
take out private key
update docs
then send email to folks pointing to doc change

1st lets run iir and see it fail

it didnt fail
i dont think jlp wiped out the keys yet
hmmmmm - then maybe fix later
lets set up budget 1st i guess

YOUR NEW PERSONAL UUID IS:

2058f324-59b0-452f-a4b2-065e30e7768a


it is labeled "magibson" in mauth-innovate.imedidata.com

when ready I will delete all other uuids I gave you in the past.

thanks

ah i see he hasnt deleted them yet

so maybe i should send out directions 1st
well lets 1st do budget new way then write up notes

need to make mauth.yml.example file thats emptyish/exampleish - check that into git
then make real one with .gitignore on it
then try it

trying to run budgets
funny error:
/Users/magibson/.rvm/gems/ruby-1.8.7-p352/gems/activesupport-3.1.1/lib/active_support/dependencies.rb:234:in `load': /Users/magibson/projects/budgets/config/initializers/session_store.rb:3: syntax error, unexpected ':', expecting $end (SyntaxError)
...sion_store :cookie_store, key: '_budgets_session'
cur
ruby-1.8.7-p352
thats the problem!
al bud
alias bud='cd ~/projects/budgets;  rvm use ruby-1.9.2-p290@budgets'
 ~/projects/budgets (feature/mauth) $ bud
Using /Users/magibson/.rvm/gems/ruby-1.9.2-p290 with gemset budgets

`const_missing': uninitialized constant Rails::Initializer (NameError)
clean bundle install

http://guides.rubyonrails.org/rails_on_rack.html

3.2.1 Adding a Middleware

You can add a new middleware to the middleware stack using any of the following methods:

config.middleware.use(new_middleware, args) – Adds the new middleware at the bottom of the middleware stack.
config.middleware.insert_before(existing_middleware, new_middleware, args) – Adds the new middleware before the specified existing middleware in the middleware stack.
config.middleware.insert_after(existing_middleware, new_middleware, args) – Adds the new middleware after the specified existing middleware in the middleware stack.
# config/application.rb
# Push Rack::BounceFavicon at the bottom
config.middleware.use Rack::BounceFavicon
# Add Lifo::Cache after ActiveRecord::QueryCache.
# Pass { :page_cache => false } argument to Lifo::Cache.
config.middleware.insert_after ActiveRecord::QueryCache, Lifo::Cache, :page_cache => false

added to application.rb:
    # MAUTH rack
    mauth_conf = YAML.load_file(File.join(Rails.root, "config", "mauth.yml"))[Rails.env]
    if mauth_conf['private_key_file']
      mauth_conf['private_key'] = File.read(mauth_conf['private_key_file'])
    end
    require 'mauth/rack'

    config.middleware.use MAuth::Rack::ResponseSigner, mauth_conf
    config.middleware.use MAuth::Rack::RequestAuthentictor, mauth_conf

need mauth.yml of course - progress

lets first make mauth.yml - do a git ignore on it and then make sample

YOUR NEW PERSONAL UUID IS: (app_uuid)

2058f324-59b0-452f-a4b2-065e30e7768a

lets dig up private key that should still be valid from iir
  private_key: |
        -----BEGIN RSA PRIVATE KEY-----
        MIIEpQIBAAKCAQEAy8uLxcS4BMStRiRRV+pDxujhaWJOQzM9kPOOHw7r80DVpbUU
        DpZFaQdnUpDlIq3ptY8hVnEgLGKzCGlNeot/aWJh7s01CuAgTP1WhfILU7XhlXtb
        suh++MlhDbkDQsEePcIOGzQCBQHHcxn+DBAwSbN5sNfpB/BQkmXmgXkbTgP8aNEQ
        Nr8ywypmXYQ5zOnDBFPOBbcrhm4kfUzVtWbQ87ukAyQDsTh0/Tjf76xRf4mRB0Vi
        pPjjtw7wFGULSckco1ZpnaTwb6NUJrXnI3l1eArPUBFAInrlNYOSYow/+vRG9/Cg
        0bhcLmVpeKJSPw1PM65rqv0g5dbVO6PlfrDqAwIDAQABAoIBAQC3IB5nBg/9aOXy
        42ucvktND7KNyeJdjEvEVrbcvcHUAex5TK/LM8kHSbnUfZMIiJI7rXPdgyXP/Ji3
        9DfE6FkDT36E4SzKqv8bb4IyNn9rJ0Kf2gtaRoTh9cMaW6fMclBEWn3mf+NYsHKS
        wUaBfIKHl5jACiPCGHWuN5bbvQGGJX5YrHSvaAtvAvSVoqk9e08IZPWkUxTWZq46
        QNI4Zr5NaeD14xn5YnKvLDmiigZkqwGPj3JlNm2NBjvBgJZjBkF0oYCunPOoFOxS
        /yjwIGJbvTXkIgeCSyH2e6hXEfCzTK2gu1m2PUa7iCvssNewCz120RHwdp/TG5BH
        69OJYewxAoGBAPu7Wc3GZYD24qbwFTdGUtQAboJTgW8ZOCRz4u2Tbdo2Oylerx9v
        n0CO5h0FBcJQq2fXPAag9gaHQjCAA+2DSK8qlFUNDIocK3DtVMFv/SYhn1Mo1eGk
        cBtLRF+NfLm66/tI12UcExPRxgf6NfYe24Eus+ZPq2+fouS90HePlTWVAoGBAM9A
        H9nf5vQunk8JCVzJvbLg/076GVGEPnCAJT8uor/Tv93eu7/wRXQZnKrFAZ44krh0
        3S0DGD+Uweu0JXmJENpqIV8ZeCSlUBEGgN9ivue6glOAjCpndeiW+cfbIMHcVsha
        Mhi+TP00setPZt9IQNbRVTccdTCF+jIDV4W7wQs3AoGAGiRswRf3dpstEpUgPutI
        sseQsmwlpvoBgJegW3fSErVLE5LHsQYQjc3JS/43iOSDyHbrvux8YFUvpIXG4qWd
        qMNNQD/oq3cdc87R3Hza11jqiOJWw+Yl1k/Mu/efmlI1K5V2+QMfYBGK9U0gyXyO
        4y2MdUCU1zTG3+ZufdwlbLkCgYEAgl1Lq7jzhdVtLzn38a3U7ZgqAHvBQU12GT4C
        L+Qd65w+rElWwD1a8tTJf4G8qtHbOLwKBC5WKmhgMut2RyS4vSrVIwTaVfLGkm8M
        0XdDrm/bWrsZb/L0cAHHzLdBu6/lxtE1gerycrOa1vFzPDAu2PGEMM5tyL/9yUfg
        3fZkT7ECgYEA5Obilp8Qa+mJRrFq+9XM9p9Nyy1uZiD0YE4ZhYPXH6fiDO2S/EOH
        ShnUvZnlRy1XA0pjQp74f9hQswBQE5DQDQSFSaR6vGPKurkW2k+TgdR8gR98OJGU
        oSM/J2VRPdlFRsQW+5x4BJb1MFiIkfvPIACkXPR4ITLhmuptSQbXh3w=
        -----END RSA PRIVATE KEY-----

/Users/magibson/.rvm/gems/ruby-1.9.2-p290@budgets/gems/rake-0.9.2.2/lib/rake/ext/module.rb:36:in `const_missing': uninitialized constant MAuth::Rack::RequestAuthentictor (NameError)


need to test this out with curl/scripties - tonya is still working on wiring it into iir client

i think ethan wrote some new stuff for the curlies

rackmauth - script is in curl_gen_script branch
git checkout -b feature/curl_gen_script origin/feature/curl_gen_script
cp test/curlgen.rb ~/projects/budgets/

actually could just work/config run script in rack mauth directory itself

https://sites.google.com/a/mdsol.com/knowledgebase/home/departments/engineering/on-demand-portfolio/services/core-services/mauth/mauth-client-cli-tool
curl gen no more!

cd ~/projects
git clone git@github.com:mdsol/mauth-client.git
cd mauth-client

mkdir config && cd config

bin/mauth-client GET  https://eureka-innovate.imedidata.com/apis

bin/mauth-client GET https://localhost:3000/budgets/v1/budgets/729b6850-a0cc-4a85-8066-f96f95006ec0

ok added to budget dev db with ugandar email
rails console
Budget.create({:initiating_user_uuid => "307602f2-469f-11e1-ad6f-00261824db2f", "study_uuid" => "d2216ad8-5199-11e1-95fe-70cd60fffe66", "study_group_uuid" =>"35aa8dec-5199-11e1-95fe-70cd60fffe66", :phase_uuid => "5b660b29-2413-4a4e-a0b0-b0f351b29f73", :indication_uuid => "1", :location_uuid => "1", })


bin/mauth-client GET https://localhost:3000/budgets/v1/budgets/729b6850-a0cc-4a85-8066-f96f95006ec0
~/projects/mauth-client (master) $ bin/mauth-client GET https://localhost:3000/budgets/v1/budgets/729b6850-a0cc-4a85-8066-f96f95006ec0
* connect to localhost on port 3000
* getting our SSL on
> GET /budgets/v1/budgets/729b6850-a0cc-4a85-8066-f96f95006ec0 HTTP/1.1
> X-MWS-Time: 1332177164
> X-MWS-Authentication: MWS 2058f324-59b0-452f-a4b2-065e30e7768a:JoRFAHYLAh0hhbyReT10QDpVWiZvB7Tc4z1RZQ1/L6OM4zyIYTdWQUqnlTQenGSwv3VSC6lhg5yN4Gf/tfyHN1fp4vTbSOBh23CFcIfsBwZbAFHlb/hqHajy9UIDH0zugPORYKWv3J9T1SAdp2AckbkUUYE19lS3WCA113/CyJwhiZFCATCN/5gxdODgAArMIZvcZaEwakn767K8FWYRS4eNDw+TaT4ASw83/s9+IQoSOJFFJwpbW98bgQLypFYQHl9TXviOdtO5CbWq/ZxtW6VTrzX740rGC3gipetsallpUOgZwbBt/CkfBEgfW9zAbUkYFCeTOp2VHtd74WpDeQ==
> 
/Users/magibson/.rvm/rubies/ruby-1.8.7-p352/lib/ruby/1.8/net/http.rb:586:in `connect': SSL_connect returned=1 errno=0 state=SSLv2/v3 read server hello A: unknown protocol (OpenSSL::SSL::SSLError)
	from /Users/magibson/.rvm/rubies/ruby-1.8.7-p352/lib/ruby/1.8/net/http.rb:586:in `connect'
	from /Users/magibson/.rvm/rubies/ruby-1.8.7-p352/lib/ruby/1.8/net/http.rb:553:in `do_start'
	from /Users/magibson/.rvm/rubies/ruby-1.8.7-p352/lib/ruby/1.8/net/http.rb:542:in `start'
	from /Users/magibson/.rvm/rubies/ruby-1.8.7-p352/lib/ruby/1.8/net/http.rb:1035:in `request'
	from /Users/magibson/.rvm/rubies/ruby-1.8.7-p352/lib/ruby/1.8/net/http.rb:772:in `get'
	from /Users/magibson/.rvm/gems/ruby-1.8.7-p352/gems/faraday-0.7.6/lib/faraday/adapter/net_http.rb:59:in `call'
	from bin/mauth-client:57:in `call'
	from /Users/magibson/projects/mauth-client/lib/mauth/faraday.rb:17:in `call'
	from /Users/magibson/projects/mauth-client/lib/mauth/faraday.rb:10:in `call'
	from /Users/magibson/.rvm/gems/ruby-1.8.7-p352/gems/faraday_middleware-0.8.5/lib/faraday_middleware/request/encode_json.rb:21:in `call'
	from /Users/magibson/.rvm/gems/ruby-1.8.7-p352/gems/faraday-0.7.6/lib/faraday/connection.rb:210:in `run_request'
	from /Users/magibson/.rvm/gems/ruby-1.8.7-p352/gems/faraday-0.7.6/lib/faraday/connection.rb:93:in `get'
	from bin/mauth-client:84:in `send'
	from bin/mauth-client:84

bundle install
and which ruby/rails?
its currently in 1.8.7

rvm use ruby-1.9.2-p290
bomb
rvm use 1.8.7-p352


for some reason my request was https instead of http that was problem

bin/mauth-client GET http://localhost:3000/budgets/v1/budgets/729b6850-a0cc-4a85-8066-f96f95006ec0
NOT
bin/mauth-client GET https://localhost:3000/budgets/v1/budgets/729b6850-a0cc-4a85-8066-f96f95006ec0

and the response signer stays
apparetnly we want to sign responses

so i think this is ready for a pr?? isnt it?
should i rebase it? why not

wait we are not ready

a few things
need to git ignore config/mauth.yml
need to put in sample config/mauth.yml.example
need to put in disabling of mauth? in config somewhere?

oh also need to run cuc - prob broken!

need to doc 
1 setting up keys 
2 testing it out


********************
3/20/12 tues office
********************
ok budget service has mauth whats next
i think reference service in prep for eureka
the hard part is that phil is away so may not know how to set it up with data and test it
may not want to do eureka for test

what are the steps
git clone
rvm 1.9
bundle install
make branch!
add to gem file
config file
mauth.yml.example
mauth.yml w private key & app_uuid - git ignored
make data (???)
test with CLI (???)


http://localhost:3000/v1/phases
returns:
[{"uuid":"5b660b29-2413-4a4e-a0b0-b0f351b29f73","name":"Phase 1"},{"uuid":"b4e3fa0c-54cc-4749-a589-7d8808a34453","name":"Phase 2"},{"uuid":"e991d87b-d8c9-45d7-b344-77937670ef52","name":"Phase 3"},{"uuid":"43d5aedb-cce4-419e-82a4-ef18474f60fc","name":"Phase 4"},{"uuid":"fcf189f0-99ae-41df-80b5-8ff1a29aa051","name":"Unknown"}]

hardwired into the controller
cool!

this doesnt work - i suspect because i dont have csv/data loaded
curl -s http://0.0.0.0:3000/references/indications?search_term=pk
<h1>Routing Error</h1>
<p><pre>No route matches [GET] &quot;/references/indications&quot;</pre></p>

lets try
curl -s http://0.0.0.0:3000/v1/phases
[{"uuid":"5b660b29-2413-4a4e-a0b0-b0f351b29f73","name":"Phase 1"},{"uuid":"b4e3fa0c-54cc-4749-a589-7d8808a34453","name":"Phase 2"},{"uuid":"e991d87b-d8c9-45d7-b344-77937670ef52","name":"Phase 3"},{"uuid":"43d5aedb-cce4-419e-82a4-ef18474f60fc","name":"Phase 4"},{"uuid":"fcf189f0-99ae-41df-80b5-8ff1a29aa051","name":"Unknown"}]

yup that works
have a testable now!

gemfile
bundle install
config file
mauth.yml.example
mauth.yml w private key & app_uuid - git ignored
##make data (???)
test with CLI (???)


gem 'mauth-client', :git => "git@github.com:mdsol/mauth-client.git", :tag => 'v2.0.1'
bundle install

dont forget to enable mauth for dev

curl -s http://0.0.0.0:3000/v1/phases
Unauthorized

cool its working - well at least its unauthorizing

test w cli!

cd ~/mc/config
 ln -s ~/ref/config/mauth.yml ref-mauth.yml
rm mauth.yml
  ln -s ref-mauth.yml mauth.yml

wow it worked
i think we are ready for pr?


from ethan
use the MAUTH_CONFIG_YAML variable ("might be nice to have cmd line param in mauth client for mauth.yml file - if thats not already there?")
MAUTH_CONFIG_YAML=~/some_mauth_config.yml mauth-client get http://foobar
i should try that

 MAUTH_CONFIG_YAML=~/projects/reference/config/mauth.yml bin/mauth-client  GET http://localhost:3000/v1/phases

alright well lets do cost analysis

oh actually i should make submodule of ref svc! in iir 
so ready for eureka

making a submodule is always a little sticky aint it


***********************
3/21/12 wed office
******************

so where am i at
submodule is made and merged for ref
i think now its back to mauth
need to do cost analysis

(foolow install direcs...)
git clone
rvm 1.9
bundle install
db... yml & rake

make branch!
add to gem file
bundle install
config file - application.rb
mauth.yml.example
mauth.yml w private key & app_uuid - git ignored
make data (???)
test with CLI (???) - ask tonya?

doc cli test

change docs for submodule and install

how do i load a csv file into mysql?

http://localhost:3000/v1/costs/22698ad3-8dc4-4ee9-9fbf-beac8644b60b?location_uuid=4b6500ad-7428-4e0b-8df4-91eca1344579&indication_uuid=6868b538-fe5d-4575-9577-0e6d1a6e31ca&phase_uuid=b4e3fa0c-54cc-4749-a589-7d8808a34453

LOAD DATA INFILE 'data.txt' INTO TABLE db2.my_table;

alias mysql-cost-analysis="mysql -u root cost_analysis_development"

mysql -u root cost_analysis_development

LOAD DATA INFILE '/Users/magibson/projects/cost_analysis/industry_costs.csv' INTO TABLE cost_analysis_development.industry_costs;

LOAD DATA INFILE '/Users/magibson/projects/cost_analysis/indication_maps.csv' INTO TABLE cost_analysis_development.indication_maps;

LOAD DATA INFILE '/Users/magibson/projects/cost_analysis/industry_costs.csv' INTO TABLE cost_analysis_development.industry_costs;
ERROR 1062 (23000): Duplicate entry '0---' for key 'industry_costs_search_index'

i guess ill try navicat tool? 

MAUTH_CONFIG_YAML=~/projects/cost_analysis/config/mauth.yml bin/mauth-client GET http://localhost:3000/v1/costs/22698ad3-8dc4-4ee9-9fbf-beac8644b60b?location_uuid=4b6500ad-7428-4e0b-8df4-91eca1344579&indication_uuid=6868b538-fe5d-4575-9577-0e6d1a6e31ca&phase_uuid=b4e3fa0c-54cc-4749-a589-7d8808a34453

make pr
update docs
when tonya fixes cost analysis data dump try that out

need to update to new submodule in iir for cost analysis and budget - already done for ref


ok on to activities

#(foolow install direcs...)
#git clone
#rvm 1.9
#bundle install
#db... yml & rake

#make branch!
#add to gem file
#bundle install
#config file - application.rb
#mauth.yml.example
#mauth.yml w private key & app_uuid - 
make data (???)
test with CLI (???) - ask tonya?
commit ignore pr
doc cli test

http://0.0.0.0:3000/v1/activities?search_term=fee

MAUTH_CONFIG_YAML=./config/mauth.yml ~/projects/mauth-client/bin/mauth-client GET http://localhost:3000/v1/activities?search_term=fee
MAUTH_CONFIG_YAML=~/projects/activities/config/mauth.yml ~/projects/mauth-client/bin/mauth-client GET "http://localhost:3000/v1/activities?search_term=fee"
MAUTH_CONFIG_YAML=~/projects/activities/config/mauth.yml ~/projects/mauth-client/bin/mauth-client GET "http://0.0.0.0:3000/v1/activities?search_term=fee"


got activities csvs from tonya
procedure_frequencies activities activities_synonyms

alias mysql-activities="mysql -u root activity_development"

LOAD DATA INFILE '/Users/magibson/Downloads/procedure_frequencies.csv' INTO TABLE activity_development.procedure_frequencies;


it works - have to load data via navicat - wont load via mysql cmd line

ready to commit pr


******************************************
3/22/12 thurs brooklyn,on train to nj & NJ
******************************************
hmmm well note for next time gonna try to work from train
figure out what piece of work you want to work on
and the day before work on loading up laptop for that piece
i want to work on budget service
but i didnt load the latest budget service on computer
woops
also want to work on submodules for iir - which is pretty internetty
however couldve loaded a submodule help page and then written down proposed
commands to run once internet is back
hmmm
well can still attempt to write budget scenarios as i do have an old budget
as submodule of iir to use as reference - well lets try
theres also an iir task but its lowest priority
darn 

well 1st docs we need to write for grigory
main difference is loading up data:

DOCS FOR LOADING UP ACTIVITY DATA FROM CSV FILES WITH NAVICAT
(please correct these directions if there is an error)
download navicat for mysql - web address - & install & run - i only could find free 30 day trial - 
Tonya says theres a free lite version - i couldnt find it - 30 day trial ok for now.
get 3 csv files from tonya or frank or mark
bring up navicat
add a connection for mysql db (keep default settings - empty pwd...)
click on connection gives list of databases
click on activities_development db
should see a list of tables that correspond with 3 csv files
click on a table and click import data
click/accept csv file (default)
hit a bunch of conintues - defaults all work
except for mapping page
you need to explicitly map each column - skip the id column and otherwise they are in order
1st field (after id) maps to 1st column in file, 2nd to 2nd...
hit continue (a few times)
and finally the csv file will load into the table
do this for all 3 csv files

ok thats pretty much the navicat directions

SUBMODULES
so for submodules i can can scan through the notes here and see if theres anything informative
alias add-locale-update="cd ~/i/config/locales; git fetch; git checkout origin/HEAD; cd ../..; git add config/locales"

#cd vendor/apps/budgets
cd vendor/apps
git fetch?
git checkout origin/HEAD ??? HEAD?
do we need to check out develop branch
?git checkout -b develop origin/develop -- isnt that backward?? maybe not
alias make-branch='git checkout -b '
cd ../..
git add vendor/apps/budgets ??
git commit -m "adding submodule"  ??
git submodule add budget-branch budgets
git submodule add origin

see submodule-notes...

HOLMDEL
ok lets update grigory docs 1st

need to try running fs - which wasnt working before actually

foreman seems to now be barfing on rvm???
yet its still same 0.3.2 version i think - but could be a different 0.3.2?
RVM is not a function, selecting rubies with 'rvm use ...' will not work.
well really its subcontractor - i think?

and foreman is still 0.36
wierd!

budget service submod done - oh wait havent done with enabled mauth
well actually i dont think iir is yet calling budget
just imedidata & need to add for references w eureka
